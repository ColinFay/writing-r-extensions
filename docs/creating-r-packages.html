<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Writing R extensions</title>
  <meta name="description" content="Writing R Extensions covers how to create your own packages, write R help files, and the foreign language (C, C++, Fortran, …) interfaces.">
  <meta name="generator" content="bookdown 0.5 and GitBook 2.6.7">

  <meta property="og:title" content="Writing R extensions" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Writing R Extensions covers how to create your own packages, write R help files, and the foreign language (C, C++, Fortran, …) interfaces." />
  <meta name="github-repo" content="ColinFay/writing-r-extensions" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Writing R extensions" />
  
  <meta name="twitter:description" content="Writing R Extensions covers how to create your own packages, write R help files, and the foreign language (C, C++, Fortran, …) interfaces." />
  

<meta name="author" content="R Core Team">


<meta name="date" content="2017-10-18">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="acknowledgements.html">
<link rel="next" href="writing-r-documentation-files.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />







<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-65307055-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-65307055-3');
</script>



<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Writing R Extensions</a></li>
<li class="chapter" data-level="" data-path="acknowledgements.html"><a href="acknowledgements.html"><i class="fa fa-check"></i>Acknowledgements</a></li>
<li class="chapter" data-level="1" data-path="creating-r-packages.html"><a href="creating-r-packages.html"><i class="fa fa-check"></i><b>1</b> Creating R packages</a></li>
<li class="chapter" data-level="2" data-path="writing-r-documentation-files.html"><a href="writing-r-documentation-files.html"><i class="fa fa-check"></i><b>2</b> Writing R documentation files</a></li>
<li class="chapter" data-level="3" data-path="tidying-and-profiling-r-code.html"><a href="tidying-and-profiling-r-code.html"><i class="fa fa-check"></i><b>3</b> Tidying and profiling R code</a></li>
<li class="chapter" data-level="4" data-path="debugging.html"><a href="debugging.html"><i class="fa fa-check"></i><b>4</b> Debugging</a></li>
<li class="chapter" data-level="5" data-path="system-and-foreign-language-interfaces.html"><a href="system-and-foreign-language-interfaces.html"><i class="fa fa-check"></i><b>5</b> System and foreign language interfaces</a></li>
<li class="chapter" data-level="6" data-path="the-r-api-entry-points-for-c-code.html"><a href="the-r-api-entry-points-for-c-code.html"><i class="fa fa-check"></i><b>6</b> The R API: entry points for C code</a></li>
<li class="chapter" data-level="7" data-path="generic-functions-and-methods.html"><a href="generic-functions-and-methods.html"><i class="fa fa-check"></i><b>7</b> Generic functions and methods</a></li>
<li class="chapter" data-level="8" data-path="linking-guis-and-other-front-ends-to-r.html"><a href="linking-guis-and-other-front-ends-to-r.html"><i class="fa fa-check"></i><b>8</b> Linking GUIs and other front-ends to R</a></li>
<li class="chapter" data-level="9" data-path="function-and-variable-index.html"><a href="function-and-variable-index.html"><i class="fa fa-check"></i><b>9</b> Function and variable index</a></li>
<li class="chapter" data-level="10" data-path="concept-index.html"><a href="concept-index.html"><i class="fa fa-check"></i><b>10</b> Concept index</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Writing R extensions</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="creating-r-packages" class="section level1">
<h1><span class="header-section-number">Chapter 1</span> Creating R packages</h1>
<p>
<a href="" id="index-Packages"></a> <a href="" id="index-Creating-packages"></a>
</p>
<p>
Packages provide a mechanism for loading optional code, data and documentation as needed. The R distribution itself includes about 30 packages.
</p>
<p>
In the following, we assume that you know the <code class="calibre2">library()</code> command, including its <code class="calibre2">lib.loc</code> argument, and we also assume basic knowledge of the <code class="calibre2">R CMD INSTALL</code> utility. Otherwise, please look at R’s help pages on
</p>
<div class="example">
<pre class="example1"><code>?library
?INSTALL</code></pre>
</div>
<p>
before reading on.
</p>
<p>
For packages which contain code to be compiled, a computing environment including a number of tools is assumed; the “R Installation and Administration” manual describes what is needed for each OS.
</p>
<p>
Once a source package is created, it must be installed by the command <code class="calibre2">R CMD INSTALL</code>.
</p>
<p>
Other types of extensions are supported (but rare): See <a href="creating-r-packages.html#Package-types">Package types</a>.
</p>
<p>
Some notes on terminology complete this introduction. These will help with the reading of this manual, and also in describing concepts accurately when asking for help.
</p>
<p>
A <em>package</em> is a directory of files which extend R, a <em>source package</em> (the master files of a package), or a tarball containing the files of a source package, or an <em>installed</em> package, the result of running <code class="calibre2">R CMD INSTALL</code> on a source package. On some platforms (notably macOS and Windows) there are also <em>binary packages</em>, a zip file or tarball containing the files of an installed package which can be unpacked rather than installing from sources.
</p>
<p>
A package is <strong>not</strong><a href="concept-index.html#FOOT1" id="DOCF1"><sup>1</sup></a> a <em>library</em>. The latter is used in two senses in R documentation.
</p>
<ul>
<li>
A directory into which packages are installed, e.g. /usr/lib/R/library: in that sense it is sometimes referred to as a <em>library directory</em> or <em>library tree</em> (since the library is a directory which contains packages as directories, which themselves contain directories).
</li>
<li>
That used by the operating system, as a shared, dynamic or static library or (especially on Windows) a DLL, where the second L stands for ‘library’. Installed packages may contain compiled code in what is known on Unix-alikes as a <em>shared object</em> and on Windows as a DLL. The concept of a <em>shared library</em> (<em>dynamic library</em> on macOS) as a collection of compiled code to which a package might link is also used, especially for R itself on some platforms. On most platforms these concepts are interchangeable (shared objects and DLLs can both be loaded into the R process and be linked against), but macOS distinguishes between shared objects (extension .so) and dynamic libraries (extension .dylib).
</li>
</ul>
<p>
There are a number of well-defined operations on source packages.
</p>
<ul>
<li>
The most common is <em>installation</em> which takes a source package and installs it in a library using <code class="calibre2">R CMD INSTALL</code> or <code class="calibre2">install.packages</code>.
</li>
<li>
Source packages can be <em>built</em>. This involves taking a source directory and creating a tarball ready for distribution, including cleaning it up and creating PDF documentation from any <em>vignettes</em> it may contain. Source packages (and most often tarballs) can be <em>checked</em>, when a test installation is done and tested (including running its examples); also, the contents of the package are tested in various ways for consistency and portability.
</li>
<li>
<em>Compilation</em> is not a correct term for a package. Installing a source package which contains C, C++ or Fortran code will involve compiling that code. There is also the possibility of ‘byte’ compiling the R code in a package (using the facilities of package <strong>compiler</strong>): already base and recommended packages are normally byte-compiled and this can be specified for other packages. So <em>compiling</em> a package may come to mean byte-compiling its R code.
</li>
<li>
It used to be unambiguous to talk about <em>loading</em> an installed package using <code class="calibre2">library()</code>, but since the advent of package namespaces this has been less clear: people now often talk about <em>loading</em> the package’s namespace and then <em>attaching</em> the package so it becomes visible on the search path. Function <code class="calibre2">library</code> performs both steps, but a package’s namespace can be loaded without the package being attached (for example by calls like <code class="calibre2">splines::ns</code>).
</li>
</ul>
<p>
The concept of <em>lazy loading</em> of code or data is mentioned at several points. This is part of the installation, always selected for R code but optional for data. When used the R objects of the package are created at installation time and stored in a database in the R directory of the installed package, being loaded into the session at first use. This makes the R session start up faster and use less (virtual) memory.
</p>
<p>
<a href="" id="index-CRAN"></a>
</p>
<p>
CRAN is a network of WWW sites holding the R distributions and contributed code, especially R packages. Users of R are encouraged to join in the collaborative project and to submit their own packages to CRAN: current instructions are linked from <a href="https://CRAN.R-project.org/banner.shtml#submitting" class="uri">https://CRAN.R-project.org/banner.shtml#submitting</a>.
</p>
<hr />
<p>
<a href="" id="Package-structure"></a> <a href="" id="Package-structure-1"></a>
</p>
<h3 id="package-structure" class="section">
1.1 Package structure
</h3>
<p>
<a href="" id="index-Package-structure"></a>
</p>
<p>
The sources of an R package consists of a subdirectory containing a files DESCRIPTION and NAMESPACE, and the subdirectories R, data, demo, exec, inst, man, po, src, tests, tools and vignettes (some of which can be missing, but which should not be empty). The package subdirectory may also contain files INDEX, configure, cleanup, LICENSE, LICENCE and NEWS. Other files such as INSTALL (for non-standard installation instructions), README/README.md<a href="concept-index.html#FOOT2" id="DOCF2"><sup>2</sup></a>, or ChangeLog will be ignored by R, but may be useful to end users. The utility <code class="calibre2">R CMD build</code> may add files in a build directory (but this should not be used for other purposes).
</p>
<p>
Except where specifically mentioned,<a href="concept-index.html#FOOT3" id="DOCF3"><sup>3</sup></a> packages should not contain Unix-style ‘hidden’ files/directories (that is, those whose name starts with a dot).
</p>
<p>
The DESCRIPTION and INDEX files are described in the subsections below. The NAMESPACE file is described in the section on <a href="creating-r-packages.html#Package-namespaces">Package namespaces</a>.
</p>
<p>
<a href="" id="index-configure-file"></a> <a href="" id="index-cleanup-file"></a>
</p>
<p>
The optional files configure and cleanup are (Bourne) shell scripts which are, respectively, executed before and (if option –clean was given) after installation on Unix-alikes, see <a href="creating-r-packages.html#Configure-and-cleanup">Configure and cleanup</a>. The analogues on Windows are configure.win and cleanup.win.
</p>
<p>
For the conventions for files NEWS and ChangeLog in the GNU project see <a href="https://www.gnu.org/prep/standards/standards.html#Documentation" class="uri">https://www.gnu.org/prep/standards/standards.html#Documentation</a>.
</p>
<p>
The package subdirectory should be given the same name as the package. Because some file systems (e.g., those on Windows and by default on OS X) are not case-sensitive, to maintain portability it is strongly recommended that case distinctions not be used to distinguish different packages. For example, if you have a package named foo, do not also create a package named Foo.
</p>
<p>
To ensure that file names are valid across file systems and supported operating systems, the ASCII control characters as well as the characters ‘“’, ‘*’, ‘:’, ‘/’, ‘&lt;’, ‘&gt;’, ‘?’, ‘\’, and ‘|’ are not allowed in file names. In addition, files with names ‘con’, ‘prn’, ‘aux’, ‘clock$’, ‘nul’, ‘com1’ to ‘com9’, and ‘lpt1’ to ‘lpt9’ after conversion to lower case and stripping possible “extensions” (e.g., ‘lpt5.foo.bar’), are disallowed. Also, file names in the same directory must not differ only by case (see the previous paragraph). In addition, the basenames of ‘.Rd’ files may be used in URLs and so must be ASCII and not contain <code class="calibre2">%</code>. For maximal portability filenames should only contain only ASCII characters not excluded already (that is <code class="calibre2">A-Za-z0-9._!#$%&amp;+,;=@^(){}‘[]</code> — we exclude space as many utilities do not accept spaces in file paths): non-English alphabetic characters cannot be guaranteed to be supported in all locales. It would be good practice to avoid the shell metacharacters <code class="calibre2">(){}’[]$~</code>: <code class="calibre2">~</code> is also used as part of ‘8.3’ filenames on Windows. In addition, packages are normally distributed as tarballs, and these have a limit on path lengths: for maximal portability 100 bytes.
</p>
<p>
A source package if possible should not contain binary executable files: they are not portable, and a security risk if they are of the appropriate architecture. <code class="calibre2">R CMD check</code> will warn about them<a href="concept-index.html#FOOT4" id="DOCF4"><sup>4</sup></a> unless they are listed (one filepath per line) in a file BinaryFiles at the top level of the package. Note that CRAN will not accept submissions containing binary files even if they are listed.
</p>
<p>
The R function <code class="calibre2">package.skeleton</code> can help to create the structure for a new package: see its help page for details.
</p>
<hr />
<p>
<a href="" id="The-DESCRIPTION-file"></a> <a href="" id="The-DESCRIPTION-file-1"></a>
</p>
<h4 id="the-description-file" class="subsection">
1.1.1 The DESCRIPTION file
</h4>
<p>
<a href="" id="index-DESCRIPTION-file"></a>
</p>
<p>
The DESCRIPTION file contains basic information about the package in the following format:
</p>
<blockquote>
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left">
<div class="example">
<pre class="smallexample"><code>Package: pkgname
Version: 0.5-1
Date: 2015-01-01
Title: My First Collection of Functions
Authors@R: c(person(&quot;Joe&quot;, &quot;Developer&quot;, role = c(&quot;aut&quot;, &quot;cre&quot;),
                     email = &quot;Joe.Developer@some.domain.net&quot;),
              person(&quot;Pat&quot;, &quot;Developer&quot;, role = &quot;aut&quot;),
              person(&quot;A.&quot;, &quot;User&quot;, role = &quot;ctb&quot;,
                     email = &quot;A.User@whereever.net&quot;))
Author: Joe Developer [aut, cre],
  Pat Developer [aut],
  A. User [ctb]
Maintainer: Joe Developer &lt;Joe.Developer@some.domain.net&gt;
Depends: R (&gt;= 3.1.0), nlme
Suggests: MASS
Description: A (one paragraph) description of what
  the package does and why it may be useful.
License: GPL (&gt;= 2)
URL: https://www.r-project.org, http://www.another.url
BugReports: https://pkgname.bugtracker.url</code></pre>
</div>
</td>
</tr>
</tbody>
</table>
</blockquote>
<p>
The format is that of a version of a ‘Debian Control File’ (see the help for ‘read.dcf’ and <a href="https://www.debian.org/doc/debian-policy/ch-controlfields.html" class="uri">https://www.debian.org/doc/debian-policy/ch-controlfields.html</a>: R does not require encoding in UTF-8 and does not support comments starting with ‘#’). Fields start with an ASCII name immediately followed by a colon: the value starts after the colon and a space. Continuation lines (for example, for descriptions longer than one line) start with a space or tab. Field names are case-sensitive: all those used by R are capitalized.
</p>
<p>
For maximal portability, the DESCRIPTION file should be written entirely in ASCII — if this is not possible it must contain an ‘Encoding’ field (see below).
</p>
<p>
Several optional fields take <em>logical values</em>: these can be specified as ‘yes’, ‘true’, ‘no’ or ‘false’: capitalized values are also accepted.
</p>
<p>
The ‘Package’, ‘Version’, ‘License’, ‘Description’, ‘Title’, ‘Author’, and ‘Maintainer’ fields are mandatory, all other fields are optional. Fields ‘Author’ and ‘Maintainer’ can be auto-generated from ‘<a href="mailto:Authors@R">Authors@R</a>’, and may be omitted if the latter is provided: however if they are not ASCII we recommend that they are provided.
</p>
<p>
The mandatory ‘Package’ field gives the name of the package. This should contain only (ASCII) letters, numbers and dot, have at least two characters and start with a letter and not end in a dot. If it needs explaining, this should be done in the ‘Description’ field (and not the ‘Title’ field).
</p>
<p>
The mandatory ‘Version’ field gives the version of the package. This is a sequence of at least <em>two</em> (and usually three) non-negative integers separated by single ‘.’ or ‘-’ characters. The canonical form is as shown in the example, and a version such as ‘0.01’ or ‘0.01.0’ will be handled as if it were ‘0.1-0’. It is <strong>not</strong> a decimal number, so for example <code class="calibre2">0.9 &lt; 0.75</code> since <code class="calibre2">9 &lt; 75</code>.
</p>
<p>
The mandatory ‘License’ field is discussed in the next subsection.
</p>
<p>
The mandatory ‘Title’ field should give a <em>short</em> description of the package. Some package listings may truncate the title to 65 characters. It should use <em>title case</em> (that is, use capitals for the principal words: <code class="calibre2">tools::toTitleCase</code> can help you with this), not use any markup, not have any continuation lines, and not end in a period (unless part of …). Do not repeat the package name: it is often used prefixed by the name. Refer to other packages and external software in single quotes, and to book titles (and similar) in double quotes.
</p>
<p>
The mandatory ‘Description’ field should give a <em>comprehensive</em> description of what the package does. One can use several (complete) sentences, but only one paragraph. It should be intelligible to all the intended readership (e.g. for a CRAN package to all CRAN users). It is good practice not to start with the package name, ‘This package’ or similar. As with the ‘Title’ field, double quotes should be used for quotations (including titles of books and articles), and single quotes for non-English usage, including names of other packages and external software. This field should also be used for explaining the package name if necessary. URLs should be enclosed in angle brackets, e.g. ‘&lt;<a href="https://www.r-project.org%3E" class="uri">https://www.r-project.org&gt;</a>’: see also <a href="creating-r-packages.html#Specifying-URLs">Specifying URLs</a>.
</p>
<p>
The mandatory ‘Author’ field describes who wrote <em>the package</em>. It is a plain text field intended for human readers, but not for automatic processing (such as extracting the email addresses of all listed contributors: for that use ‘<a href="mailto:Authors@R">Authors@R</a>’). Note that all significant contributors must be included: if you wrote an R wrapper for the work of others included in the src directory, you are not the sole (and maybe not even the main) author.
</p>
<p>
The mandatory ‘Maintainer’ field should give a <em>single</em> name followed by a <em>valid</em> (RFC 2822) email address in angle brackets. It should not end in a period or comma. This field is what is reported by the <code class="calibre2">maintainer</code> function and used by <code class="calibre2">bug.report</code>. For a CRAN package it should be a <em>person</em>, not a mailing list and not a corporate entity: do ensure that it is valid and will remain valid for the lifetime of the package.
</p>
<p>
Note that the <em>display name</em> (the part before the address in angle brackets) should be enclosed in double quotes if it contains non-alphanumeric characters such as comma or period. (The current standard, RFC 5322, allows periods but RFC 2822 did not.)
</p>
<p>
Both ‘Author’ and ‘Maintainer’ fields can be omitted if a suitable ‘<a href="mailto:Authors@R">Authors@R</a>’ field is given. This field can be used to provide a refined and machine-readable description of the package “authors” (in particular specifying their precise <em>roles</em>), via suitable R code. It should create an object of class <code class="calibre2">“person”</code>, by either a call to <code class="calibre2">person</code> or a series of calls (one per “author”) concatenated by <code class="calibre2">c()</code>: see the example DESCRIPTION file above. The roles can include ‘“aut”’ (author) for full authors, ‘“cre”’ (creator) for the package maintainer, and ‘“ctb”’ (contributor) for other contributors, ‘“cph”’ (copyright holder), among others. See <code class="calibre2">?person</code> for more information. Note that no role is assumed by default. Auto-generated package citation information takes advantage of this specification. The ‘Author’ and ‘Maintainer’ fields are auto-generated from it if needed when building<a href="concept-index.html#FOOT5" id="DOCF5"><sup>5</sup></a> or installing.
</p>
<p>
<a href="" id="index-COPYRIGHTS"></a>
</p>
<p>
An optional ‘Copyright’ field can be used where the copyright holder(s) are not the authors. If necessary, this can refer to an installed file: the convention is to use file inst/COPYRIGHTS.
</p>
<p>
The optional ‘Date’ field gives the <em>release date</em> of the current version of the package. It is strongly recommended<a href="concept-index.html#FOOT6" id="DOCF6"><sup>6</sup></a> to use the ‘yyyy-mm-dd’ format conforming to the ISO 8601 standard.
</p>
<p>
The ‘Depends’, ‘Imports’, ‘Suggests’, ‘Enhances’, ‘LinkingTo’ and ‘Additional_repositories’ fields are discussed in a later subsection.
</p>
<p>
Dependencies external to the R system should be listed in the ‘SystemRequirements’ field, possibly amplified in a separate README file.
</p>
<p>
The ‘URL’ field may give a list of URLs separated by commas or whitespace, for example the homepage of the author or a page where additional material describing the software can be found. These URLs are converted to active hyperlinks in CRAN package listings. See <a href="creating-r-packages.html#Specifying-URLs">Specifying URLs</a>.
</p>
<p>
The ‘BugReports’ field may contain a single URL to which bug reports about the package should be submitted. This URL will be used by <code class="calibre2">bug.report</code> instead of sending an email to the maintainer. A browser is opened for a ‘<a href="http://" class="uri">http://</a>’ or ‘<a href="https://" class="uri">https://</a>’ URL. As from R 3.4.0, <code class="calibre2">bug.report</code> will try to extract an email address (preferably from a ‘mailto:’ URL or enclosed in angle brackets).
</p>
<p>
Base and recommended packages (i.e., packages contained in the R source distribution or available from CRAN and recommended to be included in every binary distribution of R) have a ‘Priority’ field with value ‘base’ or ‘recommended’, respectively. These priorities must not be used by other packages.
</p>
<p>
A ‘Collate’ field can be used for controlling the collation order for the R code files in a package when these are processed for package installation. The default is to collate according to the ‘C’ locale. If present, the collate specification must list <em>all</em> R code files in the package (taking possible OS-specific subdirectories into account, see <a href="creating-r-packages.html#Package-subdirectories">Package subdirectories</a>) as a whitespace separated list of file paths relative to the R subdirectory. Paths containing white space or quotes need to be quoted. An OS-specific collation field (‘Collate.unix’ or ‘Collate.windows’) will be used in preference to ‘Collate’.
</p>
<p>
The ‘LazyData’ logical field controls whether the R datasets use lazy-loading. A ‘LazyLoad’ field was used in versions prior to 2.14.0, but now is ignored.
</p>
<p>
The ‘KeepSource’ logical field controls if the package code is sourced using <code class="calibre2">keep.source = TRUE</code> or <code class="calibre2">FALSE</code>: it might be needed exceptionally for a package designed to always be used with <code class="calibre2">keep.source = TRUE</code>.
</p>
<p>
The ‘ByteCompile’ logical field controls if the package code is to be byte-compiled on installation: the default is currently not to, so this may be useful for a package known to benefit particularly from byte-compilation (which can take quite a long time and increases the installed size of the package). It is used for the recommended packages, as they are byte-compiled when R is installed and for consistency should be byte-compiled when updated. This can be overridden by installing with flag –no-byte-compile.
</p>
<p>
The ‘ZipData’ logical field was used to control whether the automatic Windows build would zip up the data directory or not prior to R 2.13.0: it is now ignored.
</p>
<p>
The ‘Biarch’ logical field is used on Windows to select the <code class="calibre2">INSTALL</code> option –force-biarch for this package.
</p>
<p>
The ‘BuildVignettes’ logical field can be set to a false value to stop <code class="calibre2">R CMD build</code> from attempting to build the vignettes, as well as preventing<a href="concept-index.html#FOOT7" id="DOCF7"><sup>7</sup></a> <code class="calibre2">R CMD check</code> from testing this. This should only be used exceptionally, for example if the PDFs include large figures which are not part of the package sources (and hence only in packages which do not have an Open Source license).
</p>
<p>
The ‘VignetteBuilder’ field names (in a comma-separated list) packages that provide an engine for building vignettes. These may include the current package, or ones listed in ‘Depends’, ‘Suggests’ or ‘Imports’. The <strong>utils</strong> package is always implicitly appended. See <a href="writing-package-vignettes.html#Non_002dSweave-vignettes">Non-Sweave vignettes</a> for details.
</p>
<p>
If the DESCRIPTION file is not entirely in ASCII it should contain an ‘Encoding’ field specifying an encoding. This is used as the encoding of the DESCRIPTION file itself and of the R and NAMESPACE files, and as the default encoding of .Rd files. The examples are assumed to be in this encoding when running <code class="calibre2">R CMD check</code>, and it is used for the encoding of the <code class="calibre2">CITATION</code> file. Only encoding names <code class="calibre2">latin1</code>, <code class="calibre2">latin2</code> and <code class="calibre2">UTF-8</code> are known to be portable. (Do not specify an encoding unless one is actually needed: doing so makes the package <em>less</em> portable. If a package has a specified encoding, you should run <code class="calibre2">R CMD build</code> etc in a locale using that encoding.)
</p>
<p>
The ‘NeedsCompilation’ field should be set to <code class="calibre2">“yes”</code> if the package contains code which to be compiled, otherwise <code class="calibre2">“no”</code> (when the package could be installed from source on any platform without additional tools). This is used by <code class="calibre2">install.packages(type = “both”)</code> in R &gt;= 2.15.2 on platforms where binary packages are the norm: it is normally set by <code class="calibre2">R CMD build</code> or the repository assuming compilation is required if and only if the package has a src directory.
</p>
<p>
The ‘OS_type’ field specifies the OS(es) for which the package is intended. If present, it should be one of <code class="calibre2">unix</code> or <code class="calibre2">windows</code>, and indicates that the package can only be installed on a platform with ‘.Platform$OS.type’ having that value.
</p>
<p>
The ‘Type’ field specifies the type of the package: see <a href="creating-r-packages.html#Package-types">Package types</a>.
</p>
<p>
One can add subject classifications for the content of the package using the fields ‘Classification/ACM’ or ‘Classification/ACM-2012’ (using the Computing Classification System of the Association for Computing Machinery, <a href="http://www.acm.org/about/class/" class="uri">http://www.acm.org/about/class/</a>; the former refers to the 1998 version), ‘Classification/JEL’ (the Journal of Economic Literature Classification System, <a href="https://www.aeaweb.org/econlit/jelCodes.php" class="uri">https://www.aeaweb.org/econlit/jelCodes.php</a>, or ‘Classification/MSC’ or ‘Classification/MSC-2010’ (the Mathematics Subject Classification of the American Mathematical Society, <a href="http://www.ams.org/msc/" class="uri">http://www.ams.org/msc/</a>; the former refers to the 2000 version). The subject classifications should be comma-separated lists of the respective classification codes, e.g., ‘Classification/ACM: G.4, H.2.8, I.5.1’.
</p>
<p>
A ‘Language’ field can be used to indicate if the package documentation is not in English: this should be a comma-separated list of standard (not private use or grandfathered) IETF language tags as currently defined by RFC 5646 (<a href="https://tools.ietf.org/html/rfc5646" class="uri">https://tools.ietf.org/html/rfc5646</a>, see also <a href="https://en.wikipedia.org/wiki/IETF_language_tag" class="uri">https://en.wikipedia.org/wiki/IETF_language_tag</a>), i.e., use language subtags which in essence are 2-letter ISO 639-1 (<a href="https://en.wikipedia.org/wiki/ISO_639-1" class="uri">https://en.wikipedia.org/wiki/ISO_639-1</a>) or 3-letter ISO 639-3 (<a href="https://en.wikipedia.org/wiki/ISO_639-3" class="uri">https://en.wikipedia.org/wiki/ISO_639-3</a>) language codes.
</p>
<p>
An ‘RdMacros’ field can be used to hold a comma-separated list of packages from which the current package will import Rd macro definitions. These will be imported after the system macros, in the order listed in the ‘RdMacros’ field, before any macro definitions in the current package are loaded. Macro definitions in individual .Rd files in the man directory are loaded last, and are local to later parts of that file. In case of duplicates, the last loaded definition will be used<a href="concept-index.html#FOOT8" id="DOCF8"><sup>8</sup></a> Both <code class="calibre2">R CMD Rd2pdf</code> and <code class="calibre2">R CMD Rdconv</code> have an optional flag –RdMacros=pkglist. The option is also a comma-separated list of package names, and has priority over the value given in DESCRIPTION. Packages using Rd macros should depend on R 3.2.0 or later.
</p>
<blockquote>
<p>
<strong>Note:</strong> There should be no ‘Built’ or ‘Packaged’ fields, as these are added by the package management tools.
</p>
</blockquote>
<p>
There is no restriction on the use of other fields not mentioned here (but using other capitalizations of these field names would cause confusion). Fields <code class="calibre2">Note</code>, <code class="calibre2">Contact</code> (for contacting the authors/developers<a href="concept-index.html#FOOT9" id="DOCF9"><sup>9</sup></a>) and <code class="calibre2">MailingList</code> are in common use. Some repositories (including CRAN and R-forge) add their own fields.
</p>
<hr />
<p>
<a href="" id="Licensing"></a> <a href="" id="Licensing-1"></a>
</p>
<h4 id="licensing" class="subsection">
1.1.2 Licensing
</h4>
<p>
Licensing for a package which might be distributed is an important but potentially complex subject.
</p>
<p>
It is very important that you include license information! Otherwise, it may not even be legally correct for others to distribute copies of the package, let alone use it.
</p>
<p>
The package management tools use the concept of ‘free or open source software’ (FOSS, e.g., <a href="https://en.wikipedia.org/wiki/FOSS" class="uri">https://en.wikipedia.org/wiki/FOSS</a>) licenses: the idea being that some users of R and its packages want to restrict themselves to such software. Others need to ensure that there are no restrictions stopping them using a package, e.g. forbidding commercial or military use. It is a central tenet of FOSS software that there are no restrictions on users nor usage.
</p>
<p>
Do not use the ‘License’ field for information on copyright holders: if needed, use a ‘Copyright’ field.
</p>
<p>
The mandatory ‘License’ field in the DESCRIPTION file should specify the license of the package in a standardized form. Alternatives are indicated <em>via</em> vertical bars. Individual specifications must be one of
</p>
<ul>
<li>
<p>
One of the “standard” short specifications
</p>
<div class="example">
<pre class="example1"><code>GPL-2 GPL-3 LGPL-2 LGPL-2.1 LGPL-3 AGPL-3 Artistic-2.0
BSD_2_clause BSD_3_clause MIT</code></pre>
</div>
<p>
as made available <em>via</em> <a href="https://www.R-project.org/Licenses/" class="uri">https://www.R-project.org/Licenses/</a> and contained in subdirectory share/licenses of the R source or home directory.
</p>
</li>
<li>
<p>
The names or abbreviations of other licenses contained in the license data base in file share/licenses/license.db in the R source or home directory, possibly (for versioned licenses) followed by a version restriction of the form ‘(op v)’ with ‘op’ one of the comparison operators ‘&lt;’, ‘&lt;=’, ‘&gt;’, ‘&gt;=’, ‘==’, or ‘!=’ and ‘v’ a numeric version specification (strings of non-negative integers separated by ‘.’), possibly combined <em>via</em> ‘,’ (see below for an example). For versioned licenses, one can also specify the name followed by the version, or combine an existing abbreviation and the version with a ‘-’.
</p>
<p>
Abbreviations <code class="calibre2">GPL</code> and <code class="calibre2">LGPL</code> are ambiguous and usually taken to mean any version of the license: but it is better not to use them.
</p>
</li>
<li>
One of the strings ‘file LICENSE’ or ‘file LICENCE’ referring to a file named LICENSE or LICENCE in the package (source and installation) top-level directory.
</li>
<li>
The string ‘Unlimited’, meaning that there are no restrictions on distribution or use other than those imposed by relevant laws (including copyright laws).
</li>
</ul>
<p>
If a package license <em>restricts</em> a base license (where permitted, e.g., using GPL-3 or AGPL-3 with an attribution clause), the additional terms should be placed in file LICENSE (or LICENCE), and the string ‘+ file LICENSE’ (or ‘+ file LICENCE’, respectively) should be appended to the corresponding individual license specification. Note that several commonly used licenses do not permit restrictions: this includes GPL-2 and hence any specification which includes it.
</p>
<p>
Examples of standardized specifications include
</p>
<div class="example">
<pre class="example1"><code>License: GPL-2
License: LGPL (&gt;= 2.0, &lt; 3) | Mozilla Public License
License: GPL-2 | file LICENCE
License: GPL (&gt;= 2) | BSD_3_clause + file LICENSE
License: Artistic-2.0 | AGPL-3 + file LICENSE</code></pre>
</div>
<p>
Please note in particular that “Public domain” is not a valid license, since it is not recognized in some jurisdictions.
</p>
<p>
Please ensure that the license you choose also covers any dependencies (including system dependencies) of your package: it is particularly important that any restrictions on the use of such dependencies are evident to people reading your DESCRIPTION file.
</p>
<p>
Fields ‘License_is_FOSS’ and ‘License_restricts_use’ may be added by repositories where information cannot be computed from the name of the license. ‘License_is_FOSS: yes’ is used for licenses which are known to be FOSS, and ‘License_restricts_use’ can have values ‘yes’ or ‘no’ if the LICENSE file is known to restrict users or usage, or known not to. These are used by, e.g., the <code class="calibre2">available.packages</code> filters.
</p>
<p>
<a href="" id="index-LICENSE-file"></a> <a href="" id="index-LICENCE-file"></a>
</p>
<p>
The optional file LICENSE/LICENCE contains a copy of the license of the package. To avoid any confusion only include such a file if it is referred to in the ‘License’ field of the DESCRIPTION file.
</p>
<p>
Whereas you should feel free to include a license file in your <em>source</em> distribution, please do not arrange to <em>install</em> yet another copy of the GNU COPYING or COPYING.LIB files but refer to the copies on <a href="https://www.R-project.org/Licenses/" class="uri">https://www.R-project.org/Licenses/</a> and included in the R distribution (in directory share/licenses). Since files named LICENSE or LICENCE <em>will</em> be installed, do not use these names for standard license files. To include comments about the licensing rather than the body of a license, use a file named something like LICENSE.note.
</p>
<p>
A few “standard” licenses are rather license templates which need additional information to be completed <em>via</em> ‘+ file LICENSE’.
</p>
<hr />
<p>
<a href="" id="Package-Dependencies"></a> <a href="" id="Package-Dependencies-1"></a>
</p>
<h4 id="package-dependencies" class="subsection">
1.1.3 Package Dependencies
</h4>
<p>
The ‘Depends’ field gives a comma-separated list of package names which this package depends on. Those packages will be attached before the current package when <code class="calibre2">library</code> or <code class="calibre2">require</code> is called. Each package name may be optionally followed by a comment in parentheses specifying a version requirement. The comment should contain a comparison operator, whitespace and a valid version number, e.g. ‘MASS (&gt;= 3.1-20)’.
</p>
<p>
The ‘Depends’ field can also specify a dependence on a certain version of R — e.g., if the package works only with R version 3.0.0 or later, include ‘R (&gt;= 3.0.0)’ in the ‘Depends’ field. You can also require a certain SVN revision for R-devel or R-patched, e.g. ‘R (&gt;= 2.14.0), R (&gt;= r56550)’ requires a version later than R-devel of late July 2011 (including released versions of 2.14.0).
</p>
<p>
It makes no sense to declare a dependence on <code class="calibre2">R</code> without a version specification, nor on the package <strong>base</strong>: this is an R package and package <strong>base</strong> is always available.
</p>
<p>
A package or ‘R’ can appear more than once in the ‘Depends’ field, for example to give upper and lower bounds on acceptable versions.
</p>
<p>
Both <code class="calibre2">library</code> and the R package checking facilities use this field: hence it is an error to use improper syntax or misuse the ‘Depends’ field for comments on other software that might be needed. The R <code class="calibre2">INSTALL</code> facilities check if the version of R used is recent enough for the package being installed, and the list of packages which is specified will be attached (after checking version requirements) before the current package.
</p>
<p>
The ‘Imports’ field lists packages whose namespaces are imported from (as specified in the NAMESPACE file) but which do not need to be attached. Namespaces accessed by the ‘::’ and ‘:::’ operators must be listed here, or in ‘Suggests’ or ‘Enhances’ (see below). Ideally this field will include all the standard packages that are used, and it is important to include S4-using packages (as their class definitions can change and the DESCRIPTION file is used to decide which packages to re-install when this happens). Packages declared in the ‘Depends’ field should not also be in the ‘Imports’ field. Version requirements can be specified and are checked when the namespace is loaded (since R &gt;= 3.0.0).
</p>
<p>
The ‘Suggests’ field uses the same syntax as ‘Depends’ and lists packages that are not necessarily needed. This includes packages used only in examples, tests or vignettes (see <a href="creating-r-packages.html#Writing-package-vignettes">Writing package vignettes</a>), and packages loaded in the body of functions. E.g., suppose an example<a href="concept-index.html#FOOT10" id="DOCF10"><sup>10</sup></a> from package <strong>foo</strong> uses a dataset from package <strong>bar</strong>. Then it is not necessary to have <strong>bar</strong> use <strong>foo</strong> unless one wants to execute all the examples/tests/vignettes: it is useful to have <strong>bar</strong>, but not necessary. Version requirements can be specified but should be checked by the code which uses the package.
</p>
<p>
Finally, the ‘Enhances’ field lists packages “enhanced” by the package at hand, e.g., by providing methods for classes from these packages, or ways to handle objects from these packages (so several packages have ‘Enhances: chron’ because they can handle datetime objects from <a href="https://CRAN.R-project.org/package=chron"><strong>chron</strong></a> even though they prefer R’s native datetime functions). Version requirements can be specified, but are currently not used. Such packages cannot be required to check the package: any tests which use them must be conditional on the presence of the package. (If your tests use e.g. a dataset from another package it should be in ‘Suggests’ and not ‘Enhances’.)
</p>
<p>
The general rules are
</p>
<ul>
<li>
A package should be listed in only one of these fields.
</li>
<li>
Packages whose namespace only is needed to load the package using <code class="calibre2">library(pkgname)</code> should be listed in the ‘Imports’ field and not in the ‘Depends’ field. Packages listed in <code class="calibre2">imports</code> or <code class="calibre2">importFrom</code> directives in the NAMESPACE file should almost always be in ‘Imports’ and not ‘Depends’.
</li>
<li>
Packages that need to be attached to successfully load the package using <code class="calibre2">library(pkgname)</code> must be listed in the ‘Depends’ field.
</li>
<li>
All packages that are needed<a href="concept-index.html#FOOT11" id="DOCF11"><sup>11</sup></a> to successfully run <code class="calibre2">R CMD check</code> on the package must be listed in one of ‘Depends’ or ‘Suggests’ or ‘Imports’. Packages used to run examples or tests conditionally (e.g. <em>via</em> <code class="calibre2">if(require(pkgname))</code>) should be listed in ‘Suggests’ or ‘Enhances’. (This allows checkers to ensure that all the packages needed for a complete check are installed.)
</li>
</ul>
<p>
In particular, packages providing “only” data for examples or vignettes should be listed in ‘Suggests’ rather than ‘Depends’ in order to make lean installations possible.
</p>
<p>
Version dependencies in the ‘Depends’ and ‘Imports’ fields are used by <code class="calibre2">library</code> when it loads the package, and <code class="calibre2">install.packages</code> checks versions for the ‘Depends’, ‘Imports’ and (for <code class="calibre2">dependencies = TRUE</code>) ‘Suggests’ fields.
</p>
<p>
It is increasingly important that the information in these fields is complete and accurate: it is for example used to compute which packages depend on an updated package and which packages can safely be installed in parallel.
</p>
<p>
This scheme was developed before all packages had namespaces (R 2.14.0 in October 2011), and good practice changed once that was in place.
</p>
<p>
Field ‘Depends’ should nowadays be used rarely, only for packages which are intended to be put on the search path to make their facilities available to the end user (and not to the package itself): for example it makes sense that a user of package <a href="https://CRAN.R-project.org/package=latticeExtra"><strong>latticeExtra</strong></a> would want the functions of package <a href="https://CRAN.R-project.org/package=lattice"><strong>lattice</strong></a> made available.
</p>
<p>
Almost always packages mentioned in ‘Depends’ should also be imported from in the NAMESPACE file: this ensures that any needed parts of those packages are available when some other package imports the current package.
</p>
<p>
The ‘Imports’ field should not contain packages which are not imported from (<em>via</em> the NAMESPACE file or <code class="calibre2">::</code> or <code class="calibre2">:::</code> operators), as all the packages listed in that field need to be installed for the current package to be installed. (This is checked by <code class="calibre2">R CMD check</code>.)
</p>
<p>
R code in the package should call <code class="calibre2">library</code> or <code class="calibre2">require</code> only exceptionally. Such calls are never needed for packages listed in ‘Depends’ as they will already be on the search path. It used to be common practice to use <code class="calibre2">require</code> calls for packages listed in ‘Suggests’ in functions which used their functionality, but nowadays it is better to access such functionality <em>via</em> <code class="calibre2">::</code> calls.
</p>
<p>
A package that wishes to make use of header files in other packages needs to declare them as a comma-separated list in the field ‘LinkingTo’ in the DESCRIPTION file. For example
</p>
<div class="example">
<pre class="example1"><code>LinkingTo: link1, link2</code></pre>
</div>
<p>
The ‘LinkingTo’ field can have a version requirement which is checked at installation.
</p>
<p>
Specifying a package in ‘LinkingTo’ suffices if these are C++ headers containing source code or static linking is done at installation: the packages do not need to be (and usually should not be) listed in the ‘Depends’ or ‘Imports’ fields. This includes CRAN package <a href="https://CRAN.R-project.org/package=BH"><strong>BH</strong></a> and almost all users of <a href="https://CRAN.R-project.org/package=RcppArmadillo"><strong>RcppArmadillo</strong></a> and <a href="https://CRAN.R-project.org/package=RcppEigen"><strong>RcppEigen</strong></a>.
</p>
<p>
For another use of ‘LinkingTo’ see <a href="system-and-foreign-language-interfaces.html#Linking-to-native-routines-in-other-packages">Linking to native routines in other packages</a>.
</p>
<p>
The ‘Additional_repositories’ field is a comma-separated list of repository URLs where the packages named in the other fields may be found. It is currently used by <code class="calibre2">R CMD check</code> to check that the packages can be found, at least as source packages (which can be installed on any platform).
</p>
<hr />
<p>
<a href="" id="Suggested-packages"></a> <a href="" id="Suggested-packages-1"></a>
</p>
<h4 id="suggested-packages" class="subsection">
1.1.3.1 Suggested packages
</h4>
<p>
Note that someone wanting to run the examples/tests/vignettes may not have a suggested package available (and it may not even be possible to install it for that platform). The recommendation used to be to make their use conditional <em>via</em> <code class="calibre2">if(require(“pkgname”))</code>: this is OK if that conditioning is done in examples/tests/vignettes, although using <code class="calibre2">if(requireNamespace(“pkgname”))</code> is preferred, if possible.
</p>
<p>
However, using <code class="calibre2">require</code> for conditioning <em>in package code</em> is not good practice as it alters the search path for the rest of the session and relies on functions in that package not being masked by other <code class="calibre2">require</code> or <code class="calibre2">library</code> calls. It is better practice to use code like
</p>
<div class="example">
<pre class="example1"><code>   if (requireNamespace(&quot;rgl&quot;, quietly = TRUE)) {
      rgl::plot3d(...)
   } else {
      ## do something else not involving rgl.
   }</code></pre>
</div>
<p>
Note the use of <code class="calibre2">rgl::</code> as that object would not necessarily be visible (and if it is, it need not be the one from that namespace: <code class="calibre2">plot3d</code> occurs in several other packages). If the intention is to give an error if the suggested package is not available, simply use e.g. <code class="calibre2">rgl::plot3d</code>.
</p>
<p>
Note that the recommendation to use suggested packages conditionally in tests does also apply to packages used to manage test suites: a notorious example was <a href="https://CRAN.R-project.org/package=testthat"><strong>testthat</strong></a> which in version 1.0.0 contained illegal C++ code and hence could not be installed on standards-compliant platforms.
</p>
<p>
Some people have assumed that a ‘recommended’ package in ‘Suggests’ can safely be used unconditionally, but this is not so. (R can be installed without recommended packages, and which packages are ‘recommended’ may change.)
</p>
<p>
As noted above, packages in ‘Enhances’ <em>must</em> be used conditionally and hence objects within them should always be accessed <em>via</em> <code class="calibre2">::</code>.
</p>
<hr />
<p>
<a href="" id="The-INDEX-file"></a> <a href="" id="The-INDEX-file-1"></a>
</p>
<h4 id="the-index-file" class="subsection">
1.1.4 The INDEX file
</h4>
<p>
<a href="" id="index-INDEX-file"></a>
</p>
<p>
The optional file INDEX contains a line for each sufficiently interesting object in the package, giving its name and a description (functions such as print methods not usually called explicitly might not be included). Normally this file is missing and the corresponding information is automatically generated from the documentation sources (using <code class="calibre2">tools::Rdindex()</code>) when installing from source.
</p>
<p>
The file is part of the information given by <code class="calibre2">library(help = pkgname)</code>.
</p>
<p>
Rather than editing this file, it is preferable to put customized information about the package into an overview help page (see <a href="writing-r-documentation-files.html#Documenting-packages">Documenting packages</a>) and/or a vignette (see <a href="creating-r-packages.html#Writing-package-vignettes">Writing package vignettes</a>).
</p>
<hr />
<p>
<a href="" id="Package-subdirectories"></a> <a href="" id="Package-subdirectories-1"></a>
</p>
<h4 id="package-subdirectories" class="subsection">
1.1.5 Package subdirectories
</h4>
<p>
<a href="" id="index-Package-subdirectories"></a>
</p>
<p>
The R subdirectory contains R code files, only. The code files to be installed must start with an ASCII (lower or upper case) letter or digit and have one of the extensions<a href="concept-index.html#FOOT12" id="DOCF12"><sup>12</sup></a> .R, .S, .q, .r, or .s. We recommend using .R, as this extension seems to be not used by any other software. It should be possible to read in the files using <code class="calibre2">source()</code>, so R objects must be created by assignments. Note that there need be no connection between the name of the file and the R objects created by it. Ideally, the R code files should only directly assign R objects and definitely should not call functions with side effects such as <code class="calibre2">require</code> and <code class="calibre2">options</code>. If computations are required to create objects these can use code ‘earlier’ in the package (see the ‘Collate’ field) plus functions in the ‘Depends’ packages provided that the objects created do not depend on those packages except <em>via</em> namespace imports.
</p>
<p>
Two exceptions are allowed: if the R subdirectory contains a file sysdata.rda (a saved image of one or more R objects: please use suitable compression as suggested by <code class="calibre2">tools::resaveRdaFiles</code>, and see also the ‘SysDataCompression’ DESCRIPTION field.) this will be lazy-loaded into the namespace environment – this is intended for system datasets that are not intended to be user-accessible <em>via</em> <code class="calibre2">data</code>. Also, files ending in ‘.in’ will be allowed in the R directory to allow a configure script to generate suitable files.
</p>
<p>
Only ASCII characters (and the control characters tab, formfeed, LF and CR) should be used in code files. Other characters are accepted in comments<a href="concept-index.html#FOOT13" id="DOCF13"><sup>13</sup></a>, but then the comments may not be readable in e.g. a UTF-8 locale. Non-ASCII characters in object names will normally<a href="concept-index.html#FOOT14" id="DOCF14"><sup>14</sup></a> fail when the package is installed. Any byte will be allowed in a quoted character string but <code class="calibre2">\uxxxx</code> escapes should be used for non-ASCII characters. However, non-ASCII character strings may not be usable in some locales and may display incorrectly in others.
</p>
<p>
<a href="" id="index-library_002edynam"></a>
</p>
<p>
Various R functions in a package can be used to initialize and clean up. See <a href="writing-package-vignettes.html#Load-hooks">Load hooks</a>.
</p>
<p>
The man subdirectory should contain (only) documentation files for the objects in the package in <em>R documentation</em> (Rd) format. The documentation filenames must start with an ASCII (lower or upper case) letter or digit and have the extension .Rd (the default) or .rd. Further, the names must be valid in ‘<a href="file://" class="uri">file://</a>’ URLs, which means<a href="concept-index.html#FOOT15" id="DOCF15"><sup>15</sup></a> they must be entirely ASCII and not contain ‘%’. See <a href="writing-r-documentation-files.html">Writing R documentation files</a>, for more information. Note that all user-level objects in a package should be documented; if a package pkg contains user-level objects which are for “internal” use only, it should provide a file pkg-internal.Rd which documents all such objects, and clearly states that these are not meant to be called by the user. See e.g. the sources for package <strong>grid</strong> in the R distribution. Note that packages which use internal objects extensively should not export those objects from their namespace, when they do not need to be documented (see <a href="creating-r-packages.html#Package-namespaces">Package namespaces</a>).
</p>
<p>
Having a man directory containing no documentation files may give an installation error.
</p>
<p>
The man subdirectory may contain a subdirectory named macros; this will contain source for user-defined Rd macros. (See <a href="writing-r-documentation-files.html#User_002ddefined-macros">User-defined macros</a>.) These use the Rd format, but may not contain anything but macro definitions, comments and whitespace.
</p>
<p>
The R and man subdirectories may contain OS-specific subdirectories named unix or windows.
</p>
<p>
The sources and headers for the compiled code are in src, plus optionally a file Makevars or Makefile. When a package is installed using <code class="calibre2">R CMD INSTALL</code>, <code class="calibre2">make</code> is used to control compilation and linking into a shared object for loading into R. There are default <code class="calibre2">make</code> variables and rules for this (determined when R is configured and recorded in R_HOME/etcR_ARCH/Makeconf), providing support for C, C++, FORTRAN 77, Fortran 9x<a href="concept-index.html#FOOT16" id="DOCF16"><sup>16</sup></a>, Objective C and Objective C++<a href="concept-index.html#FOOT17" id="DOCF17"><sup>17</sup></a> with associated extensions .c, .cc or .cpp, .f, .f90 or .f95, .m, and .mm, respectively. We recommend using .h for headers, also for C++<a href="concept-index.html#FOOT18" id="DOCF18"><sup>18</sup></a> or Fortran 9x include files. (Use of extension .C for C++ is no longer supported.) Files in the src directory should not be hidden (start with a dot), and hidden files will under some versions of R be ignored.
</p>
<p>
It is not portable (and may not be possible at all) to mix all these languages in a single package, and we do not support using both C++ and Fortran 9x. Because R itself uses it, we know that C and FORTRAN 77 can be used together and mixing C and C++ seems to be widely successful.
</p>
<p>
If your code needs to depend on the platform there are certain defines which can used in C or C++. On all Windows builds (even 64-bit ones) ‘_WIN32’ will be defined: on 64-bit Windows builds also ‘_WIN64’, and on macOS ‘<strong>APPLE</strong>’ is defined.<a href="concept-index.html#FOOT19" id="DOCF19"><sup>19</sup></a>
</p>
<p>
The default rules can be tweaked by setting macros<a href="concept-index.html#FOOT20" id="DOCF20"><sup>20</sup></a> in a file src/Makevars (see <a href="creating-r-packages.html#Using-Makevars">Using Makevars</a>). Note that this mechanism should be general enough to eliminate the need for a package-specific src/Makefile. If such a file is to be distributed, considerable care is needed to make it general enough to work on all R platforms. If it has any targets at all, it should have an appropriate first target named ‘all’ and a (possibly empty) target ‘clean’ which removes all files generated by running <code class="calibre2">make</code> (to be used by ‘R CMD INSTALL –clean’ and ‘R CMD INSTALL –preclean’). There are platform-specific file names on Windows: src/Makevars.win takes precedence over src/Makevars and src/Makefile.win must be used. Some <code class="calibre2">make</code> programs require makefiles to have a complete final line, including a newline.
</p>
<p>
A few packages use the src directory for purposes other than making a shared object (e.g. to create executables). Such packages should have files src/Makefile and src/Makefile.win (unless intended for only Unix-alikes or only Windows).
</p>
<p>
In very special cases packages may create binary files other than the shared objects/DLLs in the src directory. Such files will not be installed in a multi-architecture setting since <code class="calibre2">R CMD INSTALL –libs-only</code> is used to merge multiple sub-architectures and it only copies shared objects/DLLs. If a package wants to install other binaries (for example executable programs), it should provide an R script src/install.libs.R which will be run as part of the installation in the <code class="calibre2">src</code> build directory <em>instead of</em> copying the shared objects/DLLs. The script is run in a separate R environment containing the following variables: <code class="calibre2">R_PACKAGE_NAME</code> (the name of the package), <code class="calibre2">R_PACKAGE_SOURCE</code> (the path to the source directory of the package), <code class="calibre2">R_PACKAGE_DIR</code> (the path of the target installation directory of the package), <code class="calibre2">R_ARCH</code> (the arch-dependent part of the path, often empty), <code class="calibre2">SHLIB_EXT</code> (the extension of shared objects) and <code class="calibre2">WINDOWS</code> (<code class="calibre2">TRUE</code> on Windows, <code class="calibre2">FALSE</code> elsewhere). Something close to the default behavior could be replicated with the following src/install.libs.R file:
</p>
<div class="example">
<pre class="example1"><code>files &lt;- Sys.glob(paste0(&quot;*&quot;, SHLIB_EXT))
dest &lt;- file.path(R_PACKAGE_DIR, paste0(&#39;libs&#39;, R_ARCH))
dir.create(dest, recursive = TRUE, showWarnings = FALSE)
file.copy(files, dest, overwrite = TRUE)
if(file.exists(&quot;symbols.rds&quot;))
    file.copy(&quot;symbols.rds&quot;, dest, overwrite = TRUE)</code></pre>
</div>
<p>
On the other hand, executable programs could be installed along the lines of
</p>
<div class="example">
<pre class="example1"><code>execs &lt;- c(&quot;one&quot;, &quot;two&quot;, &quot;three&quot;)
if(WINDOWS) execs &lt;- paste0(execs, &quot;.exe&quot;)
if ( any(file.exists(execs)) ) {
  dest &lt;- file.path(R_PACKAGE_DIR,  paste0(&#39;bin&#39;, R_ARCH))
  dir.create(dest, recursive = TRUE, showWarnings = FALSE)
  file.copy(execs, dest, overwrite = TRUE)
}</code></pre>
</div>
<p>
Note the use of architecture-specific subdirectories of bin where needed.
</p>
<p>
The data subdirectory is for data files: See <a href="creating-r-packages.html#Data-in-packages">Data in packages</a>.
</p>
<p>
The demo subdirectory is for R scripts (for running <em>via</em> <code class="calibre2">demo()</code>) that demonstrate some of the functionality of the package. Demos may be interactive and are not checked automatically, so if testing is desired use code in the tests directory to achieve this. The script files must start with a (lower or upper case) letter and have one of the extensions .R or .r. If present, the demo subdirectory should also have a 00Index file with one line for each demo, giving its name and a description separated by a tab or at least three spaces. (This index file is not generated automatically.) Note that a demo does not have a specified encoding and so should be an ASCII file (see <a href="creating-r-packages.html#Encoding-issues">Encoding issues</a>). Function <code class="calibre2">demo()</code> will use the package encoding if there is one, but this is mainly useful for non-ASCII comments.
</p>
<p>
<a href="" id="index-_002eRinstignore-file"></a>
</p>
<p>
The contents of the inst subdirectory will be copied recursively to the installation directory. Subdirectories of inst should not interfere with those used by R (currently, R, data, demo, exec, libs, man, help, html and Meta, and earlier versions used latex, R-ex). The copying of the inst happens after src is built so its Makefile can create files to be installed. To exclude files from being installed, one can specify a list of exclude patterns in file .Rinstignore in the top-level source directory. These patterns should be Perl-like regular expressions (see the help for <code class="calibre2">regexp</code> in R for the precise details), one per line, to be matched case-insensitively against the file and directory paths, e.g. doc/.*[.]png$ will exclude all PNG files in inst/doc based on the extension.
</p>
<p>
Note that with the exceptions of INDEX, LICENSE/LICENCE and NEWS, information files at the top level of the package will <em>not</em> be installed and so not be known to users of Windows and macOS compiled packages (and not seen by those who use <code class="calibre2">R CMD INSTALL</code> or <code class="calibre2">install.packages</code> on the tarball). So any information files you wish an end user to see should be included in inst. Note that if the named exceptions also occur in inst, the version in inst will be that seen in the installed package.
</p>
<p>
<a href="" id="index-CITATION"></a> <a href="" id="index-citation"></a> <a href="" id="index-NEWS_002eRd"></a> <a href="" id="index-news"></a>
</p>
<p>
Things you might like to add to inst are a CITATION file for use by the <code class="calibre2">citation</code> function, and a NEWS.Rd file for use by the <code class="calibre2">news</code> function. See its help page for the specific format restrictions of the NEWS.Rd file.
</p>
<p>
<a href="" id="index-AUTHORS"></a> <a href="" id="index-COPYRIGHTS-1"></a>
</p>
<p>
Another file sometimes needed in inst is AUTHORS or COPYRIGHTS to specify the authors or copyright holders when this is too complex to put in the DESCRIPTION file.
</p>
<p>
Subdirectory tests is for additional package-specific test code, similar to the specific tests that come with the R distribution. Test code can either be provided directly in a .R (or .r as from R 3.4.0) file, or <em>via</em> a .Rin file containing code which in turn creates the corresponding .R file (e.g., by collecting all function objects in the package and then calling them with the strangest arguments). The results of running a .R file are written to a .Rout file. If there is a corresponding<a href="concept-index.html#FOOT21" id="DOCF21"><sup>21</sup></a> .Rout.save file, these two are compared, with differences being reported but not causing an error. The directory tests is copied to the check area, and the tests are run with the copy as the working directory and with <code class="calibre2">R_LIBS</code> set to ensure that the copy of the package installed during testing will be found by <code class="calibre2">library(pkg_name)</code>. Note that the package-specific tests are run in a vanilla R session without setting the random-number seed, so tests which use random numbers will need to set the seed to obtain reproducible results (and it can be helpful to do so in all cases, to avoid occasional failures when tests are run).
</p>
<p>
If directory tests has a subdirectory Examples containing a file <code class="calibre2">pkg-Ex.Rout.save</code>, this is compared to the output file for running the examples when the latter are checked. Reference output should be produced without having the –timings option set (and note that –as-cran sets it).
</p>
<p>
Subdirectory exec could contain additional executable scripts the package needs, typically scripts for interpreters such as the shell, Perl, or Tcl. NB: only files (and not directories) under exec are installed (and those with names starting with a dot are ignored), and they are all marked as executable (mode <code class="calibre2">755</code>, moderated by ‘umask’) on POSIX platforms. Note too that this is not suitable for executable <em>programs</em> since some platforms (including Windows) support multiple architectures using the same installed package directory.
</p>
<p>
Subdirectory po is used for files related to <em>localization</em>: see <a href="writing-package-vignettes.html#Internationalization">Internationalization</a>.
</p>
<p>
Subdirectory tools is the preferred place for auxiliary files needed during configuration, and also for sources need to re-create scripts (e.g. M4 files for <code class="calibre2">autoconf</code>).
</p>
<hr />
<p>
<a href="" id="Data-in-packages"></a> <a href="" id="Data-in-packages-1"></a>
</p>
<h4 id="data-in-packages" class="subsection">
1.1.6 Data in packages
</h4>
<p>
The data subdirectory is for data files, either to be made available <em>via</em> lazy-loading or for loading using <code class="calibre2">data()</code>. (The choice is made by the ‘LazyData’ field in the DESCRIPTION file: the default is not to do so.) It should not be used for other data files needed by the package, and the convention has grown up to use directory inst/extdata for such files.
</p>
<p>
Data files can have one of three types as indicated by their extension: plain R code (.R or .r), tables (.tab, .txt, or .csv, see <code class="calibre2">?data</code> for the file formats, and note that .csv is <strong>not</strong> the standard<a href="concept-index.html#FOOT22" id="DOCF22"><sup>22</sup></a> CSV format), or <code class="calibre2">save()</code> images (.RData or .rda). The files should not be hidden (have names starting with a dot). Note that R code should be “self-sufficient” and not make use of extra functionality provided by the package, so that the data file can also be used without having to load the package or its namespace.
</p>
<p>
Images (extensions .RData<a href="concept-index.html#FOOT23" id="DOCF23"><sup>23</sup></a> or .rda) can contain references to the namespaces of packages that were used to create them. Preferably there should be no such references in data files, and in any case they should only be to packages listed in the <code class="calibre2">Depends</code> and <code class="calibre2">Imports</code> fields, as otherwise it may be impossible to install the package. To check for such references, load all the images into a vanilla R session, and look at the output of <code class="calibre2">loadedNamespaces()</code>.
</p>
<p>
If your data files are large and you are not using ‘LazyData’ you can speed up installation by providing a file datalist in the data subdirectory. This should have one line per topic that <code class="calibre2">data()</code> will find, in the format ‘foo’ if <code class="calibre2">data(foo)</code> provides ‘foo’, or ‘foo: bar bah’ if <code class="calibre2">data(foo)</code> provides ‘bar’ and ‘bah’. <code class="calibre2">R CMD build</code> will automatically add a datalist file to data directories of over 1Mb, using the function <code class="calibre2">tools::add_datalist</code>.
</p>
<p>
Tables (.tab, .txt, or .csv files) can be compressed by <code class="calibre2">gzip</code>, <code class="calibre2">bzip2</code> or <code class="calibre2">xz</code>, optionally with additional extension .gz, .bz2 or .xz.
</p>
<p>
If your package is to be distributed, do consider the resource implications of large datasets for your users: they can make packages very slow to download and use up unwelcome amounts of storage space, as well as taking many seconds to load. It is normally best to distribute large datasets as .rda images prepared by <code class="calibre2">save(, compress = TRUE)</code> (the default). Using <code class="calibre2">bzip2</code> or <code class="calibre2">xz</code> compression will usually reduce the size of both the package tarball and the installed package, in some cases by a factor of two or more.
</p>
<p>
Package <strong>tools</strong> has a couple of functions to help with data images: <code class="calibre2">checkRdaFiles</code> reports on the way the image was saved, and <code class="calibre2">resaveRdaFiles</code> will re-save with a different type of compression, including choosing the best type for that particular image.
</p>
<p>
Some packages using ‘LazyData’ will benefit from using a form of compression other than <code class="calibre2">gzip</code> in the installed lazy-loading database. This can be selected by the –data-compress option to <code class="calibre2">R CMD INSTALL</code> or by using the ‘LazyDataCompression’ field in the DESCRIPTION file. Useful values are <code class="calibre2">bzip2</code>, <code class="calibre2">xz</code> and the default, <code class="calibre2">gzip</code>. The only way to discover which is best is to try them all and look at the size of the pkgname/data/Rdata.rdb file.
</p>
<p>
Lazy-loading is not supported for very large datasets (those which when serialized exceed 2GB, the limit for the format on 32-bit platforms).
</p>
<p>
The analogue for sysdata.rda is field ‘SysDataCompression’: the default is <code class="calibre2">xz</code> for files bigger than 1MB otherwise <code class="calibre2">gzip</code>.
</p>
<hr />
<p>
<a href="" id="Non_002dR-scripts-in-packages"></a> <a href="" id="Non_002dR-scripts-in-packages-1"></a>
</p>
<h4 id="non-r-scripts-in-packages" class="subsection">
1.1.7 Non-R scripts in packages
</h4>
<p>
Code which needs to be compiled (C, C++, FORTRAN, Fortran 95 …) is included in the src subdirectory and discussed elsewhere in this document.
</p>
<p>
Subdirectory exec could be used for scripts for interpreters such as the shell, BUGS, JavaScript, Matlab, Perl, php (<a href="https://CRAN.R-project.org/package=amap"><strong>amap</strong></a>), Python or Tcl (<a href="https://CRAN.R-project.org/package=Simile"><strong>Simile</strong></a>), or even R. However, it seems more common to use the inst directory, for example WriteXLS/inst/Perl, NMF/inst/m-files, RnavGraph/inst/tcl, RProtoBuf/inst/python and emdbook/inst/BUGS and gridSVG/inst/js.
</p>
<p>
Java code is a special case: except for very small programs, .java files should be byte-compiled (to a .class file) and distributed as part of a .jar file: the conventional location for the .jar file(s) is inst/java. It is desirable (and required under an Open Source license) to make the Java source files available: this is best done in a top-level java directory in the package—the source files should not be installed.
</p>
<p>
If your package requires one of these interpreters or an extension then this should be declared in the ‘SystemRequirements’ field of its DESCRIPTION file. (Users of Java most often do so <em>via</em> <a href="https://CRAN.R-project.org/package=rJava"><strong>rJava</strong></a>, when depending on/importing that suffices.)
</p>
<p>
Windows and Mac users should be aware that the Tcl extensions ‘BWidget’ and ‘Tktable’ which are currently included with the R for Windows and in the macOS installers <em>are</em> extensions and do need to be declared for users of other platforms (and that ‘Tktable’ is less widely available than it used to be, including not in the main repositories for major Linux distributions).
</p>
<p>
‘BWidget’ needs to be installed by the user on other OSes. This is fairly easy to do: first find the Tcl/Tk search path:
</p>
<div class="example">
<pre class="example1"><code>library(tcltk)
strsplit(tclvalue(&#39;auto_path&#39;), &quot; &quot;)[[1]]</code></pre>
</div>
<p>
then download the sources from <a href="http://sourceforge.net/projects/tcllib/files/BWidget/" class="uri">http://sourceforge.net/projects/tcllib/files/BWidget/</a> and at the command line run something like
</p>
<div class="example">
<pre class="example1"><code>tar xf bwidget-1.9.8.tar.gz
sudo mv bwidget-1.9.8 /usr/local/lib</code></pre>
</div>
<p>
substituting a location on the Tcl/Tk search path for /usr/local/lib if needed.
</p>
<hr />
<p>
<a href="" id="Specifying-URLs"></a> <a href="" id="Specifying-URLs-1"></a>
</p>
<h4 id="specifying-urls" class="subsection">
1.1.8 Specifying URLs
</h4>
<p>
URLs in many places in the package documentation will be converted to clickable hyperlinks in at least some of their renderings. So care is needed that their forms are correct and portable.
</p>
<p>
The full URL should be given, including the scheme (often ‘<a href="http://" class="uri">http://</a>’ or ‘<a href="https://" class="uri">https://</a>’) and a final ‘/’ for references to directories.
</p>
<p>
Spaces in URLs are not portable and how they are handled does vary by HTTP server and by client. There should be no space in the host part of an ‘<a href="http://" class="uri">http://</a>’ URL, and spaces in the remainder should be encoded, with each space replaced by ‘%20’.
</p>
<p>
Other characters may benefit from being encoded: see the help on <code class="calibre2">URLencode()</code>.
</p>
<p>
The canonical URL for a CRAN package is
</p>
<div class="example">
<pre class="example1"><code>https://cran.r-project.org/package=pkgname</code></pre>
</div>
<p>
and not a version starting ‘<a href="http://cran.r-project.org/web/packages/pkgname" class="uri">http://cran.r-project.org/web/packages/pkgname</a>’.
</p>
<hr />
<p>
<a href="" id="Configure-and-cleanup"></a> <a href="" id="Configure-and-cleanup-1"></a>
</p>
<h3 id="configure-and-cleanup" class="section">
1.2 Configure and cleanup
</h3>
<p>
Note that most of this section is specific to Unix-alikes: see the comments later on about the Windows port of R.
</p>
<p>
If your package needs some system-dependent configuration before installation you can include an executable (Bourne<a href="concept-index.html#FOOT24" id="DOCF24"><sup>24</sup></a>) shell script configure in your package which (if present) is executed by <code class="calibre2">R CMD INSTALL</code> before any other action is performed. This can be a script created by the Autoconf mechanism, but may also be a script written by yourself. Use this to detect if any nonstandard libraries are present such that corresponding code in the package can be disabled at install time rather than giving error messages when the package is compiled or used. To summarize, the full power of Autoconf is available for your extension package (including variable substitution, searching for libraries, etc.).
</p>
<p>
Under a Unix-alike only, an executable (Bourne shell) script cleanup is executed as the last thing by <code class="calibre2">R CMD INSTALL</code> if option –clean was given, and by <code class="calibre2">R CMD build</code> when preparing the package for building from its source.
</p>
<p>
As an example consider we want to use functionality provided by a (C or FORTRAN) library <code class="calibre2">foo</code>. Using Autoconf, we can create a configure script which checks for the library, sets variable <code class="calibre2">HAVE_FOO</code> to <code class="calibre2">TRUE</code> if it was found and to <code class="calibre2">FALSE</code> otherwise, and then substitutes this value into output files (by replacing instances of ‘<span class="citation">@HAVE_FOO</span>@’ in input files with the value of <code class="calibre2">HAVE_FOO</code>). For example, if a function named <code class="calibre2">bar</code> is to be made available by linking against library <code class="calibre2">foo</code> (i.e., using -lfoo), one could use
</p>
<div class="example">
<pre class="example1"><code>AC_CHECK_LIB(foo, fun, [HAVE_FOO=TRUE], [HAVE_FOO=FALSE])
AC_SUBST(HAVE_FOO)
......
AC_CONFIG_FILES([foo.R])
AC_OUTPUT</code></pre>
</div>
<p>
in configure.ac (assuming Autoconf 2.50 or later).
</p>
<p>
The definition of the respective R function in foo.R.in could be
</p>
<div class="example">
<pre class="example1"><code>foo &lt;- function(x) {
    if(!@HAVE_FOO@)
      stop(&quot;Sorry, library ‘foo’ is not available&quot;)
    ...</code></pre>
</div>
<p>
From this file <code class="calibre2">configure</code> creates the actual R source file foo.R looking like
</p>
<div class="example">
<pre class="example1"><code>foo &lt;- function(x) {
    if(!FALSE)
      stop(&quot;Sorry, library ‘foo’ is not available&quot;)
    ...</code></pre>
</div>
<p>
if library <code class="calibre2">foo</code> was not found (with the desired functionality). In this case, the above R code effectively disables the function.
</p>
<p>
One could also use different file fragments for available and missing functionality, respectively.
</p>
<p>
You will very likely need to ensure that the same C compiler and compiler flags are used in the configure tests as when compiling R or your package. Under a Unix-alike, you can achieve this by including the following fragment early in configure.ac (<em>before</em> calling <code class="calibre2">AC_PROG_CC</code>)
</p>
<div class="example">
<pre class="example1"><code>: &#36;{R_HOME=`R RHOME`}
if test -z &quot;&#36;{R_HOME}&quot;; then
  echo &quot;could not determine R_HOME&quot;
  exit 1
fi
CC=`&quot;&#36;{R_HOME}/bin/R&quot; CMD config CC`
CFLAGS=`&quot;&#36;{R_HOME}/bin/R&quot; CMD config CFLAGS`
CPPFLAGS=`&quot;&#36;{R_HOME}/bin/R&quot; CMD config CPPFLAGS`</code></pre>
</div>
<p>
(Using ‘${R_HOME}/bin/R’ rather than just ‘R’ is necessary in order to use the correct version of R when running the script as part of <code class="calibre2">R CMD INSTALL</code>, and the quotes since ‘${R_HOME}’ might contain spaces.)
</p>
<p>
If your code does load checks then you may also need
</p>
<div class="example">
<pre class="example1"><code>LDFLAGS=`&quot;&#36;{R_HOME}/bin/R&quot; CMD config LDFLAGS`</code></pre>
</div>
<p>
and packages written with C++ need to pick up the details for the C++ compiler and switch the current language to C++ by something like
</p>
<div class="example">
<pre class="example1"><code>CXX=`&quot;&#36;{R_HOME}/bin/R&quot; CMD config CXX`
CXXFLAGS=`&quot;&#36;{R_HOME}/bin/R&quot; CMD config CXXFLAGS`
AC_LANG(C++)</code></pre>
</div>
<p>
The latter is important, as for example C headers may not be available to C++ programs or may not be written to avoid C++ name-mangling.
</p>
<p>
<a href="" id="index-R-CMD-config"></a>
</p>
<p>
You can use <code class="calibre2">R CMD config</code> for getting the value of the basic configuration variables, and also the header and library flags necessary for linking a front-end executable program against R, see R CMD config –help for details.
</p>
<p>
To check for an external BLAS library using the <code class="calibre2">ACX_BLAS</code> macro from the official Autoconf Macro Archive, one can simply do
</p>
<div class="example">
<pre class="example1"><code>F77=`&quot;&#36;{R_HOME}/bin/R&quot; CMD config F77`
AC_PROG_F77
FLIBS=`&quot;&#36;{R_HOME}/bin/R&quot; CMD config FLIBS`
ACX_BLAS([], AC_MSG_ERROR([could not find your BLAS library], 1))</code></pre>
</div>
<p>
Note that <code class="calibre2">FLIBS</code> as determined by R must be used to ensure that FORTRAN 77 code works on all R platforms. Calls to the Autoconf macro <code class="calibre2">AC_F77_LIBRARY_LDFLAGS</code>, which would overwrite <code class="calibre2">FLIBS</code>, must not be used (and hence e.g. removed from <code class="calibre2">ACX_BLAS</code>). (Recent versions of Autoconf in fact allow an already set <code class="calibre2">FLIBS</code> to override the test for the FORTRAN linker flags.)
</p>
<p>
<strong>N.B.</strong>: If the <code class="calibre2">configure</code> script creates files, e.g. src/Makevars, you do need a <code class="calibre2">cleanup</code> script to remove them. Otherwise <code class="calibre2">R CMD build</code> may ship the files that are created. For example, package <a href="https://CRAN.R-project.org/package=RODBC"><strong>RODBC</strong></a> has
</p>
<div class="example">
<pre class="example1"><code>#!/bin/sh

rm -f config.* src/Makevars src/config.h</code></pre>
</div>
<p>
As this example shows, <code class="calibre2">configure</code> often creates working files such as config.log.
</p>
<p>
If your configure script needs auxiliary files, it is recommended that you ship them in a tools directory (as R itself does).
</p>
<p>
You should bear in mind that the configure script will not be used on Windows systems. If your package is to be made publicly available, please give enough information for a user on a non-Unix-alike platform to configure it manually, or provide a configure.win script to be used on that platform. (Optionally, there can be a cleanup.win script. Both should be shell scripts to be executed by <code class="calibre2">ash</code>, which is a minimal version of Bourne-style <code class="calibre2">sh</code>.) When configure.win is run the environment variables <code class="calibre2">R_HOME</code> (which uses ‘/’ as the file separator), <code class="calibre2">R_ARCH</code> and Use <code class="calibre2">R_ARCH_BIN</code> will be set. Use <code class="calibre2">R_ARCH</code> to decide if this is a 64-bit build (its value there is ‘/x64’) and to install DLLs to the correct place (${R_HOME}/libs${R_ARCH}). Use <code class="calibre2">R_ARCH_BIN</code> to find the correct place under the bin directory, e.g. ${R_HOME}/bin${R_ARCH_BIN}/Rscript.exe.
</p>
<p>
In some rare circumstances, the configuration and cleanup scripts need to know the location into which the package is being installed. An example of this is a package that uses C code and creates two shared object/DLLs. Usually, the object that is dynamically loaded by R is linked against the second, dependent, object. On some systems, we can add the location of this dependent object to the object that is dynamically loaded by R. This means that each user does not have to set the value of the <code class="calibre2">LD_LIBRARY_PATH</code> (or equivalent) environment variable, but that the secondary object is automatically resolved. Another example is when a package installs support files that are required at run time, and their location is substituted into an R data structure at installation time. <a href="" id="index-R_005fLIBRARY_005fDIR"></a> <a href="" id="index-R_005fPACKAGE_005fDIR"></a> <a href="" id="index-R_005fPACKAGE_005fNAME"></a> The names of the top-level library directory (i.e., specifiable <em>via</em> the ‘-l’ argument) and the directory of the package itself are made available to the installation scripts <em>via</em> the two shell/environment variables <code class="calibre2">R_LIBRARY_DIR</code> and <code class="calibre2">R_PACKAGE_DIR</code>. Additionally, the name of the package (e.g. ‘survival’ or ‘MASS’) being installed is available from the environment variable <code class="calibre2">R_PACKAGE_NAME</code>. (Currently the value of <code class="calibre2">R_PACKAGE_DIR</code> is always <code class="calibre2">${R_LIBRARY_DIR}/${R_PACKAGE_NAME}</code>, but this used not to be the case when versioned installs were allowed. Its main use is in configure.win scripts for the installation path of external software’s DLLs.) Note that the value of <code class="calibre2">R_PACKAGE_DIR</code> may contain spaces and other shell-unfriendly characters, and so should be quoted in makefiles and configure scripts.
</p>
<p>
One of the more tricky tasks can be to find the headers and libraries of external software. One tool which is increasingly available on Unix-alikes (but not by default on macOS) to do this is <code class="calibre2">pkg-config</code>. The configure script will need to test for the presence of the command itself (see for example package <a href="https://CRAN.R-project.org/package=Cairo"><strong>Cairo</strong></a>), and if present it can be asked if the software is installed, of a suitable version and for compilation/linking flags by e.g.
</p>
<div class="example">
<pre class="example1"><code>&#36; pkg-config --exists ‘QtCore &gt;= 4.0.0’  # check the status
&#36; pkg-config --modversion QtCore
4.7.1
&#36; pkg-config --cflags QtCore
-DQT_SHARED -I/usr/include/QtCore
&#36; pkg-config --libs QtCore
-lQtCore</code></pre>
</div>
<p>
Note that <code class="calibre2">pkg-config –libs</code> gives the information required to link against the default version of that library (usually the dynamic one), and <code class="calibre2">pkg-config –static</code> is needed if the static library is to be used.
</p>
<p>
Sometimes the name by which the software is known to <code class="calibre2">pkg-config</code> is not what one might expect (e.g. ‘gtk+-2.0’ even for 2.22). To get a complete list use
</p>
<div class="example">
<pre class="example1"><code>pkg-config --list-all | sort</code></pre>
</div>
<hr />
<p>
<a href="" id="Using-Makevars"></a> <a href="" id="Using-Makevars-1"></a>
</p>
<h4 id="using-makevars" class="subsection">
1.2.1 Using Makevars
</h4>
<p>
Sometimes writing your own configure script can be avoided by supplying a file Makevars: also one of the most common uses of a configure script is to make Makevars from Makevars.in.
</p>
<p>
A Makevars file is a makefile and is used as one of several makefiles by <code class="calibre2">R CMD SHLIB</code> (which is called by <code class="calibre2">R CMD INSTALL</code> to compile code in the src directory). It should be written if at all possible in a portable style, in particular (except for Makevars.win) without the use of GNU extensions.
</p>
<p>
The most common use of a Makevars file is to set additional preprocessor options (for example include paths) for C/C++ files <em>via</em> <code class="calibre2">PKG_CPPFLAGS</code>, and additional compiler flags by setting <code class="calibre2">PKG_CFLAGS</code>, <code class="calibre2">PKG_CXXFLAGS</code>, <code class="calibre2">PKG_FFLAGS</code> or <code class="calibre2">PKG_FCFLAGS</code>, for C, C++, FORTRAN or Fortran 9x respectively (see <a href="system-and-foreign-language-interfaces.html#Creating-shared-objects">Creating shared objects</a>).
</p>
<p>
<strong>N.B.</strong>: Include paths are preprocessor options, not compiler options, and <strong>must</strong> be set in <code class="calibre2">PKG_CPPFLAGS</code> as otherwise platform-specific paths (e.g. ‘-I/usr/local/include’) will take precedence.
</p>
<p>
Makevars can also be used to set flags for the linker, for example ‘-L’ and ‘-l’ options, <em>via</em> <code class="calibre2">PKG_LIBS</code>.
</p>
<p>
When writing a Makevars file for a package you intend to distribute, take care to ensure that it is not specific to your compiler: flags such as -O2 -Wall -pedantic (and all other -W flags: for the Oracle compilers these are used to pass arguments to compiler phases) are all specific to GCC.
</p>
<p>
Also, do not set variables such as <code class="calibre2">CPPFLAGS</code>, <code class="calibre2">CFLAGS</code> etc.: these should be settable by users (sites) through appropriate personal (site-wide) Makevars files.
</p>
<p>
There are some macros<a href="concept-index.html#FOOT25" id="DOCF25"><sup>25</sup></a> which are set whilst configuring the building of R itself and are stored in R_HOME/etcR_ARCH/Makeconf. That makefile is included as a Makefile <em>after</em> Makevars[.win], and the macros it defines can be used in macro assignments and make command lines in the latter. These include
</p>
<dl>
<dt>
<code class="calibre2">FLIBS</code>
</dt>
<dd>
<p>
<a href="" id="index-FLIBS"></a>
</p>
<p>
A macro containing the set of libraries need to link FORTRAN code. This may need to be included in <code class="calibre2">PKG_LIBS</code>: it will normally be included automatically if the package contains FORTRAN source files.
</p>
</dd>
<dt>
<code class="calibre2">BLAS_LIBS</code>
</dt>
<dd>
<p>
<a href="" id="index-BLAS_005fLIBS"></a>
</p>
<p>
A macro containing the BLAS libraries used when building R. This may need to be included in <code class="calibre2">PKG_LIBS</code>. Beware that if it is empty then the R executable will contain all the double-precision and double-complex BLAS routines, but no single-precision nor complex routines. If <code class="calibre2">BLAS_LIBS</code> is included, then <code class="calibre2">FLIBS</code> also needs to be<a href="concept-index.html#FOOT26" id="DOCF26"><sup>26</sup></a> included following it, as most BLAS libraries are written at least partially in FORTRAN.
</p>
</dd>
<dt>
<code class="calibre2">LAPACK_LIBS</code>
</dt>
<dd>
<p>
<a href="" id="index-LAPACK_005fLIBS"></a>
</p>
<p>
A macro containing the LAPACK libraries (and paths where appropriate) used when building R. This may need to be included in <code class="calibre2">PKG_LIBS</code>. It may point to a dynamic library <code class="calibre2">libRlapack</code> which contains the main double-precision LAPACK routines as well as those double-complex LAPACK routines needed to build R, or it may point to an external LAPACK library, or may be empty if an external BLAS library also contains LAPACK.
</p>
<p>
[<code class="calibre2">libRlapack</code> includes all the double-precision LAPACK routines which were current in 2003: a list of which routines are included is in file src/modules/lapack/README. Note that an external LAPACK/BLAS library need not do so, as some were ‘deprecated’ (and not compiled by default) in LAPACK 3.6.0 in late 2015.]
</p>
<p>
For portability, the macros <code class="calibre2">BLAS_LIBS</code> and <code class="calibre2">FLIBS</code> should always be included <em>after</em> <code class="calibre2">LAPACK_LIBS</code> (and in that order).
</p>
</dd>
<dt>
<code class="calibre2">SAFE_FFLAGS</code>
</dt>
<dd>
<p>
<a href="" id="index-SAFE_005fFFLAGS"></a>
</p>
<p>
A macro containing flags which are needed to circumvent over-optimization of FORTRAN code: it is typically ‘-g -O2 -ffloat-store’ on ‘ix86’ platforms using <code class="calibre2">gfortran</code>. Note that this is <strong>not</strong> an additional flag to be used as part of <code class="calibre2">PKG_FFLAGS</code>, but a replacement for <code class="calibre2">FFLAGS</code>, and that it is intended for the FORTRAN 77 compiler ‘F77’ and not necessarily for the Fortran 90/95 compiler ‘FC’. See the example later in this section.
</p>
</dd>
</dl>
<p>
<a href="" id="index-OBJECTS"></a>
</p>
<p>
Setting certain macros in Makevars will prevent <code class="calibre2">R CMD SHLIB</code> setting them: in particular if Makevars sets ‘OBJECTS’ it will not be set on the <code class="calibre2">make</code> command line. This can be useful in conjunction with implicit rules to allow other types of source code to be compiled and included in the shared object. It can also be used to control the set of files which are compiled, either by excluding some files in src or including some files in subdirectories. For example
</p>
<div class="example">
<pre class="example1"><code>OBJECTS = 4dfp/endianio.o 4dfp/Getifh.o R4dfp-object.o</code></pre>
</div>
<p>
Note that Makevars should not normally contain targets, as it is included before the default makefile and <code class="calibre2">make</code> will call the first target, intended to be <code class="calibre2">all</code> in the default makefile. If you really need to circumvent that, use a suitable (phony) target <code class="calibre2">all</code> before any actual targets in Makevars.[win]: for example package <a href="https://CRAN.R-project.org/package=fastICA"><strong>fastICA</strong></a> used to have
</p>
<div class="example">
<pre class="example1"><code>PKG_LIBS = @BLAS_LIBS@

SLAMC_FFLAGS=&#36;(R_XTRA_FFLAGS) &#36;(FPICFLAGS) &#36;(SHLIB_FFLAGS) &#36;(SAFE_FFLAGS)

all: &#36;(SHLIB)

slamc.o: slamc.f
        &#36;(F77) &#36;(SLAMC_FFLAGS) -c -o slamc.o slamc.f</code></pre>
</div>
<p>
needed to ensure that the LAPACK routines find some constants without infinite looping. The Windows equivalent was
</p>
<div class="example">
<pre class="example1"><code>all: &#36;(SHLIB)

slamc.o: slamc.f
        &#36;(F77) &#36;(SAFE_FFLAGS) -c -o slamc.o slamc.f</code></pre>
</div>
<p>
(since the other macros are all empty on that platform, and R’s internal BLAS was not used). Note that the first target in Makevars will be called, but for back-compatibility it is best named <code class="calibre2">all</code>.
</p>
<p>
If you want to create and then link to a library, say using code in a subdirectory, use something like
</p>
<div class="example">
<pre class="example1"><code>.PHONY: all mylibs

all: &#36;(SHLIB)
&#36;(SHLIB): mylibs

mylibs:
        (cd subdir; &#36;(MAKE))</code></pre>
</div>
<p>
Be careful to create all the necessary dependencies, as there is no guarantee that the dependencies of <code class="calibre2">all</code> will be run in a particular order (and some of the CRAN build machines use multiple CPUs and parallel makes). In particular,
</p>
<div class="example">
<pre class="example1"><code>all: mylibs</code></pre>
</div>
<p>
does <strong>not</strong> suffice.
</p>
<p>
Note that on Windows it is required that Makevars[.win] does create a DLL: this is needed as it is the only reliable way to ensure that building a DLL succeeded. If you want to use the src directory for some purpose other than building a DLL, use a Makefile.win file.
</p>
<p>
It is sometimes useful to have a target ‘clean’ in Makevars or Makevars.win: this will be used by <code class="calibre2">R CMD build</code> to clean up (a copy of) the package sources. When it is run by <code class="calibre2">build</code> it will have fewer macros set, in particular not <code class="calibre2">$(SHLIB)</code>, nor <code class="calibre2">$(OBJECTS)</code> unless set in the file itself. It would also be possible to add tasks to the target ‘shlib-clean’ which is run by <code class="calibre2">R CMD INSTALL</code> and <code class="calibre2">R CMD SHLIB</code> with options –clean and –preclean.
</p>
<p>
If you want to run R code in Makevars, e.g. to find configuration information, please do ensure that you use the correct copy of <code class="calibre2">R</code> or <code class="calibre2">Rscript</code>: there might not be one in the path at all, or it might be the wrong version or architecture. The correct way to do this is <em>via</em>
</p>
<div class="example">
<pre class="example1"><code>&quot;&#36;(R_HOME)/bin&#36;(R_ARCH_BIN)/Rscript&quot; filename
&quot;&#36;(R_HOME)/bin&#36;(R_ARCH_BIN)/Rscript&quot; -e ‘R expression’</code></pre>
</div>
<p>
where <code class="calibre2">$(R_ARCH_BIN)</code> is only needed currently on Windows.
</p>
<p>
Environment or make variables can be used to select different macros for 32- and 64-bit code, for example (GNU <code class="calibre2">make</code> syntax, allowed on Windows)
</p>
<div class="example">
<pre class="example1"><code>ifeq &quot;&#36;(WIN)&quot; &quot;64&quot;
PKG_LIBS = value for 64-bit Windows
else
PKG_LIBS = value for 32-bit Windows
endif</code></pre>
</div>
<p>
On Windows there is normally a choice between linking to an import library or directly to a DLL. Where possible, the latter is much more reliable: import libraries are tied to a specific toolchain, and in particular on 64-bit Windows two different conventions have been commonly used. So for example instead of
</p>
<div class="example">
<pre class="example1"><code>PKG_LIBS = -L&#36;(XML_DIR)/lib -lxml2</code></pre>
</div>
<p>
one can use
</p>
<div class="example">
<pre class="example1"><code>PKG_LIBS = -L&#36;(XML_DIR)/bin -lxml2</code></pre>
</div>
<p>
since on Windows <code class="calibre2">-lxxx</code> will look in turn for
</p>
<div class="example">
<pre class="example1"><code>libxxx.dll.a
xxx.dll.a
libxxx.a
xxx.lib
libxxx.dll
xxx.dll</code></pre>
</div>
<p>
where the first and second are conventionally import libraries, the third and fourth often static libraries (with <code class="calibre2">.lib</code> intended for Visual C++), but might be import libraries. See for example <a href="https://sourceware.org/binutils/docs-2.20/ld/WIN32.html#WIN32" class="uri">https://sourceware.org/binutils/docs-2.20/ld/WIN32.html#WIN32</a>.
</p>
<p>
The fly in the ointment is that the DLL might not be named libxxx.dll, and in fact on 32-bit Windows there is a libxml2.dll whereas on one build for 64-bit Windows the DLL is called libxml2-2.dll. Using import libraries can cover over these differences but can cause equal difficulties.
</p>
<p>
If static libraries are available they can save a lot of problems with run-time finding of DLLs, especially when binary packages are to be distributed and even more when these support both architectures. Where using DLLs is unavoidable we normally arrange (<em>via</em> configure.win) to ship them in the same directory as the package DLL.
</p>
<hr />
<p>
<a href="" id="OpenMP-support"></a> <a href="" id="OpenMP-support-1"></a>
</p>
<h4 id="openmp-support" class="subsection">
1.2.1.1 OpenMP support
</h4>
<p>
<a href="" id="index-OpenMP"></a>
</p>
<p>
There is some support for packages which wish to use OpenMP<a href="concept-index.html#FOOT27" id="DOCF27"><sup>27</sup></a>. The <code class="calibre2">make</code> macros
</p>
<div class="example">
<pre class="example1"><code>SHLIB_OPENMP_CFLAGS
SHLIB_OPENMP_CXXFLAGS
SHLIB_OPENMP_FCFLAGS
SHLIB_OPENMP_FFLAGS</code></pre>
</div>
<p>
are available for use in src/Makevars or src/Makevars.win. Include the appropriate macro in <code class="calibre2">PKG_CFLAGS</code>, <code class="calibre2">PKG_CPPFLAGS</code> and so on, and also in <code class="calibre2">PKG_LIBS</code>. C/C++ code that needs to be conditioned on the use of OpenMP can be used inside <code class="calibre2">#ifdef _OPENMP</code>: note that some toolchains used for R (including that of macOS and some others using <code class="calibre2">clang</code><a href="concept-index.html#FOOT28" id="DOCF28"><sup>28</sup></a>) have no OpenMP support at all, not even omp.h.
</p>
<p>
For example, a package with C code written for OpenMP should have in src/Makevars the lines
</p>
<div class="example">
<pre class="example1"><code>PKG_CFLAGS = &#36;(SHLIB_OPENMP_CFLAGS)
PKG_LIBS = &#36;(SHLIB_OPENMP_CFLAGS)</code></pre>
</div>
<p>
Note that the macro <code class="calibre2">SHLIB_OPENMP_CXXFLAGS</code> applies to the default C++ compiler and not necessarily to the C++11/14/17 compiler: users of the latter should do their own <code class="calibre2">configure</code> checks (an example is available in CRAN package <a href="https://CRAN.R-project.org/package=ARTP2"><strong>ARTP2</strong></a>).
</p>
<p>
Some care is needed when compilers are from different families which may use different OpenMP runtimes (e.g. <code class="calibre2">clang</code> <em>vs</em> GCC including <code class="calibre2">gfortran</code>, although it is currently possible to use the <code class="calibre2">clang</code> runtime with GCC but not <em>vice versa</em>). For a package with Fortran 77 code using OpenMP the appropriate lines are
</p>
<div class="example">
<pre class="example1"><code>PKG_FFLAGS = &#36;(SHLIB_OPENMP_FFLAGS)
PKG_LIBS = &#36;(SHLIB_OPENMP_CFLAGS)</code></pre>
</div>
<p>
as the C compiler will be used to link the package code (and there is no guarantee that this will work everywhere). (This does not apply to Fortran 9x code, where <code class="calibre2">SHLIB_OPENMP_FCFLAGS</code> should be used in both <code class="calibre2">PKG_FCFLAGS</code> and <code class="calibre2">PKG_LIBS</code>.)
</p>
<p>
For portability, any C/C++ code using the <code class="calibre2">omp_*</code> functions should include the omp.h header: some compilers (but not all) include it when OpenMP mode is switched on (e.g. <em>via</em> flag -fopenmp).
</p>
<p>
There is nothing<a href="concept-index.html#FOOT29" id="DOCF29"><sup>29</sup></a> to say what version of OpenMP is supported: version 3.1 (and much of 4.0) is supported by recent versions<a href="concept-index.html#FOOT30" id="DOCF30"><sup>30</sup></a> of the Linux, Windows and Solaris platforms, but portable packages cannot assume that end users have recent versions.<a href="concept-index.html#FOOT31" id="DOCF31"><sup>31</sup></a> macOS currently uses Apple builds of <code class="calibre2">clang</code> with no OpenMP support (even if invoked as <code class="calibre2">gcc</code> and despite the <code class="calibre2">man</code> page including the flag -fopenmp for that command). <a href="http://www.openmp.org/resources/openmp-compilers" class="uri">http://www.openmp.org/resources/openmp-compilers</a> gives some idea of what compilers support what versions.
</p>
<p>
The performance of OpenMP varies substantially between platforms. The Windows implementation has substantial overheads<a href="concept-index.html#FOOT32" id="DOCF32"><sup>32</sup></a>, so is only beneficial if quite substantial tasks are run in parallel. Also, on Windows new threads are started with the default<a href="concept-index.html#FOOT33" id="DOCF33"><sup>33</sup></a> FPU control word, so computations done on OpenMP threads will not make use of extended-precision arithmetic which is the default for the main process.
</p>
<p>
Calling any of the R API from threaded code is ‘for experts only’: they will need to read the source code to determine if it is thread-safe. In particular, code which makes use of the stack-checking mechanism must not be called from threaded code.
</p>
<p>
Packages are not standard-alone programs, and an R process could contain more than one OpenMP-enabled package as well as other components (for example, an optimized BLAS) making use of OpenMP. So careful consideration needs to be given to resource usage. OpenMP works with parallel regions, and for most implementations the default is to use as many threads as ‘CPUs’ for such regions. Parallel regions can be nested, although it is common to use only a single thread below the first level. The correctness of the detected number of ‘CPUs’ and the assumption that the R process is entitled to use them all are both dubious assumptions. The best way to limit resources is to limit the overall number of threads available to OpenMP in the R process: this can be done via environment variable <code class="calibre2">OMP_THREAD_LIMIT</code>, where implemented.<a href="concept-index.html#FOOT34" id="DOCF34"><sup>34</sup></a> Alternatively, the number of threads per region can be limited by the environment variable <code class="calibre2">OMP_NUM_THREADS</code> or API call <code class="calibre2">omp_set_num_threads</code>, or, better, for the regions in your code as part of their specification. E.g. R uses
</p>
<div class="example">
<pre class="example1"><code>#pragma omp parallel for num_threads(nthreads) …</code></pre>
</div>
<p>
That way you only control your own code and not that of other OpenMP users.
</p>
<hr />
<p>
<a href="" id="Using-pthreads"></a> <a href="" id="Using-pthreads-1"></a>
</p>
<h4 id="using-pthreads" class="subsection">
1.2.1.2 Using pthreads
</h4>
<p>
There is no direct support for the POSIX threads (more commonly known as <code class="calibre2">pthreads</code>): by the time we considered adding it several packages were using it unconditionally so it seems that nowadays it is universally available on POSIX operating systems (hence not Windows).
</p>
<p>
For reasonably recent versions of <code class="calibre2">gcc</code> and <code class="calibre2">clang</code> the correct specification is
</p>
<div class="example">
<pre class="example1"><code>PKG_CPPFLAGS = -pthread
PKG_LIBS = -pthread</code></pre>
</div>
<p>
(and the plural version is also accepted on some systems/versions). For other platforms the specification is
</p>
<div class="example">
<pre class="example1"><code>PKG_CPPFLAGS = -D_REENTRANT
PKG_LIBS = -lpthread</code></pre>
</div>
<p>
(and note that the library name is singular). This is what -pthread does on all known current platforms (although earlier versions of OpenBSD used a different library name).
</p>
<p>
For a tutorial see <a href="https://computing.llnl.gov/tutorials/pthreads/" class="uri">https://computing.llnl.gov/tutorials/pthreads/</a>.
</p>
<p>
POSIX threads are not normally used on Windows, which has its own native concepts of threads. However, there are two projects implementing <code class="calibre2">pthreads</code> on top of Windows, <code class="calibre2">pthreads-w32</code> and <code class="calibre2">winpthreads</code> (part of the MinGW-w64 project).
</p>
<p>
Whether Windows toolchains implement <code class="calibre2">pthreads</code> is up to the toolchain provider. A <code class="calibre2">make</code> variable <code class="calibre2">SHLIB_PTHREAD_FLAGS</code> is available: this should be included in both <code class="calibre2">PKG_CPPFLAGS</code> (or the Fortran or F9x equivalents) and <code class="calibre2">PKG_LIBS</code>.
</p>
<p>
The presence of a working <code class="calibre2">pthreads</code> implementation cannot be unambiguously determined without testing for yourself: however, that ‘_REENTRANT’ is defined<a href="concept-index.html#FOOT35" id="DOCF35"><sup>35</sup></a> in C/C++ code is a good indication.
</p>
<p>
Note that not all <code class="calibre2">pthreads</code> implementations are equivalent as parts are optional (see <a href="http://pubs.opengroup.org/onlinepubs/009695399/basedefs/pthread.h.html" class="uri">http://pubs.opengroup.org/onlinepubs/009695399/basedefs/pthread.h.html</a>): for example, macOS lacks the ‘Barriers’ option.
</p>
<p>
See also the comments on thread-safety and performance under OpenMP: on all known R platforms OpenMP is implemented <em>via</em> <code class="calibre2">pthreads</code> and the known performance issues are in the latter.
</p>
<hr />
<p>
<a href="" id="Compiling-in-sub_002ddirectories"></a> <a href="" id="Compiling-in-sub_002ddirectories-1"></a>
</p>
<h4 id="compiling-in-sub-directories" class="subsection">
1.2.1.3 Compiling in sub-directories
</h4>
<p>
Package authors fairly often want to organize code in sub-directories of src, for example if they are including a separate piece of external software to which this is an R interface.
</p>
<p>
One simple way is simply to set <code class="calibre2">OBJECTS</code> to be all the objects that need to be compiled, including in sub-directories. For example, CRAN package <a href="https://CRAN.R-project.org/package=RSiena"><strong>RSiena</strong></a> has
</p>
<div class="example">
<pre class="smallexample"><code>SOURCES = &#36;(wildcard data/*.cpp network/*.cpp utils/*.cpp model/*.cpp model/*/*.cpp model/*/*/*.cpp)

OBJECTS = siena07utilities.o siena07internals.o siena07setup.o siena07models.o &#36;(SOURCES:.cpp=.o)</code></pre>
</div>
<p>
One problem with that approach is that unless GNU make extensions are used, the source files need to be listed and kept up-to-date. As in the following from CRAN package <a href="https://CRAN.R-project.org/package=lossDev"><strong>lossDev</strong></a>:
</p>
<div class="example">
<pre class="smallexample"><code>OBJECTS.samplers = samplers/ExpandableArray.o samplers/Knots.o &#92;
  samplers/RJumpSpline.o samplers/RJumpSplineFactory.o &#92;
  samplers/RealSlicerOV.o samplers/SliceFactoryOV.o samplers/MNorm.o
OBJECTS.distributions = distributions/DSpline.o &#92;
  distributions/DChisqrOV.o distributions/DTOV.o &#92;
  distributions/DNormOV.o distributions/DUnifOV.o distributions/RScalarDist.o
OBJECTS.root = RJump.o

OBJECTS = &#36;(OBJECTS.samplers) &#36;(OBJECTS.distributions) &#36;(OBJECTS.root)</code></pre>
</div>
<p>
Where the subdirectory is self-contained code with a suitable makefile, the best approach is something like
</p>
<div class="example">
<pre class="smallexample"><code>PKG_LIBS = -LCsdp/lib -lsdp &#36;(LAPACK_LIBS) &#36;(BLAS_LIBS) &#36;(FLIBS)

&#36;(SHLIB): Csdp/lib/libsdp.a

Csdp/lib/libsdp.a:      
        @(cd Csdp/lib &amp;&amp; &#36;(MAKE) libsdp.a &#92;
          CC=&quot;&#36;(CC)&quot; CFLAGS=&quot;&#36;(CFLAGS) &#36;(CPICFLAGS)&quot; AR=&quot;&#36;(AR)&quot; RANLIB=&quot;&#36;(RANLIB)&quot;)</code></pre>
</div>
<p>
Note the quotes: the macros can contain spaces, e.g. <code class="calibre2">CC = “gcc -m64 -std=gnu99”</code>. Several authors have forgotten about parallel makes: the static library in the subdirectory must be made before the shared object (<code class="calibre2">$(SHLIB)</code>) and so the latter must depend on the former. Others forget the need<a href="concept-index.html#FOOT36" id="DOCF36"><sup>36</sup></a> for position-independent code.
</p>
<p>
We really do not recommend using src/Makefile instead of src/Makevars, and as the example above shows, it is not necessary.
</p>
<hr />
<p>
<a href="" id="Configure-example"></a> <a href="" id="Configure-example-1"></a>
</p>
<h4 id="configure-example" class="subsection">
1.2.2 Configure example
</h4>
<p>
It may be helpful to give an extended example of using a configure script to create a src/Makevars file: this is based on that in the <a href="https://CRAN.R-project.org/package=RODBC"><strong>RODBC</strong></a> package.
</p>
<p>
The configure.ac file follows: configure is created from this by running <code class="calibre2">autoconf</code> in the top-level package directory (containing configure.ac).
</p>
<blockquote>
<div class="example">
<pre class="smallexample"><code>AC_INIT([RODBC], 1.1.8) dnl package name, version

dnl A user-specifiable option
odbc_mgr=&quot;&quot;
AC_ARG_WITH([odbc-manager],
            AC_HELP_STRING([--with-odbc-manager=MGR],
                           [specify the ODBC manager, e.g. odbc or iodbc]),
            [odbc_mgr=&#36;withval])

if test &quot;&#36;odbc_mgr&quot; = &quot;odbc&quot; ; then
  AC_PATH_PROGS(ODBC_CONFIG, odbc_config)
fi

dnl Select an optional include path, from a configure option
dnl or from an environment variable.
AC_ARG_WITH([odbc-include],
            AC_HELP_STRING([--with-odbc-include=INCLUDE_PATH],
                           [the location of ODBC header files]),
            [odbc_include_path=&#36;withval])
RODBC_CPPFLAGS=&quot;-I.&quot;
if test [ -n &quot;&#36;odbc_include_path&quot; ] ; then
   RODBC_CPPFLAGS=&quot;-I. -I&#36;{odbc_include_path}&quot;
else
  if test [ -n &quot;&#36;{ODBC_INCLUDE}&quot; ] ; then
     RODBC_CPPFLAGS=&quot;-I. -I&#36;{ODBC_INCLUDE}&quot;
  fi
fi

dnl ditto for a library path
AC_ARG_WITH([odbc-lib],
            AC_HELP_STRING([--with-odbc-lib=LIB_PATH],
                           [the location of ODBC libraries]),
            [odbc_lib_path=&#36;withval])
if test [ -n &quot;&#36;odbc_lib_path&quot; ] ; then
   LIBS=&quot;-L&#36;odbc_lib_path &#36;{LIBS}&quot;
else
  if test [ -n &quot;&#36;{ODBC_LIBS}&quot; ] ; then
     LIBS=&quot;-L&#36;{ODBC_LIBS} &#36;{LIBS}&quot;
  else
    if test -n &quot;&#36;{ODBC_CONFIG}&quot;; then
      odbc_lib_path=`odbc_config --libs | sed s/-lodbc//`
      LIBS=&quot;&#36;{odbc_lib_path} &#36;{LIBS}&quot;
    fi
  fi
fi

dnl Now find the compiler and compiler flags to use
: &#36;{R_HOME=`R RHOME`}
if test -z &quot;&#36;{R_HOME}&quot;; then
  echo &quot;could not determine R_HOME&quot;
  exit 1
fi
CC=`&quot;&#36;{R_HOME}/bin/R&quot; CMD config CC`
CPP=`&quot;&#36;{R_HOME}/bin/R&quot; CMD config CPP`
CFLAGS=`&quot;&#36;{R_HOME}/bin/R&quot; CMD config CFLAGS`
CPPFLAGS=`&quot;&#36;{R_HOME}/bin/R&quot; CMD config CPPFLAGS`
AC_PROG_CC
AC_PROG_CPP


if test -n &quot;&#36;{ODBC_CONFIG}&quot;; then
  RODBC_CPPFLAGS=`odbc_config --cflags`
fi
CPPFLAGS=&quot;&#36;{CPPFLAGS} &#36;{RODBC_CPPFLAGS}&quot;

dnl Check the headers can be found
AC_CHECK_HEADERS(sql.h sqlext.h)
if test &quot;&#36;{ac_cv_header_sql_h}&quot; = no ||
   test &quot;&#36;{ac_cv_header_sqlext_h}&quot; = no; then
   AC_MSG_ERROR(&quot;ODBC headers sql.h and sqlext.h not found&quot;)
fi

dnl search for a library containing an ODBC function
if test [ -n &quot;&#36;{odbc_mgr}&quot; ] ; then
  AC_SEARCH_LIBS(SQLTables, &#36;{odbc_mgr}, ,
      AC_MSG_ERROR(&quot;ODBC driver manager &#36;{odbc_mgr} not found&quot;))
else
  AC_SEARCH_LIBS(SQLTables, odbc odbc32 iodbc, ,
      AC_MSG_ERROR(&quot;no ODBC driver manager found&quot;))
fi

dnl for 64-bit ODBC need SQL[U]LEN, and it is unclear where they are defined.
AC_CHECK_TYPES([SQLLEN, SQLULEN], , , [# include &lt;sql.h&gt;])
dnl for unixODBC header
AC_CHECK_SIZEOF(long, 4)

dnl substitute RODBC_CPPFLAGS and LIBS
AC_SUBST(RODBC_CPPFLAGS)
AC_SUBST(LIBS)
AC_CONFIG_HEADERS([src/config.h])
dnl and do substitution in the src/Makevars.in and src/config.h
AC_CONFIG_FILES([src/Makevars])
AC_OUTPUT</code></pre>
</div>
</blockquote>
<p>
where src/Makevars.in would be simply
</p>
<blockquote>
<div class="example">
<pre class="example1"><code>PKG_CPPFLAGS = @RODBC_CPPFLAGS@
PKG_LIBS = @LIBS@</code></pre>
</div>
</blockquote>
<p>
A user can then be advised to specify the location of the ODBC driver manager files by options like (lines broken for easier reading)
</p>
<div class="example">
<pre class="example1"><code>R CMD INSTALL &#92;
  --configure-args=&#39;--with-odbc-include=/opt/local/include &#92;
  --with-odbc-lib=/opt/local/lib --with-odbc-manager=iodbc&#39; &#92;
  RODBC</code></pre>
</div>
<p>
or by setting the environment variables <code class="calibre2">ODBC_INCLUDE</code> and <code class="calibre2">ODBC_LIBS</code>.
</p>
<hr />
<p>
<a href="" id="Using-F95-code"></a> <a href="" id="Using-F95-code-1"></a>
</p>
<h4 id="using-f95-code" class="subsection">
1.2.3 Using F95 code
</h4>
<p>
R assumes that source files with extension .f are FORTRAN 77, and passes them to the compiler specified by ‘F77’. On most but not all platforms that compiler will accept Fortran 90/95 code: some platforms have a separate Fortran 90/95 compiler and a few (by now quite rare<a href="concept-index.html#FOOT37" id="DOCF37"><sup>37</sup></a>) platforms have no Fortran 90/95 support.
</p>
<p>
This means that portable packages need to be written in correct FORTRAN 77, which will also be valid Fortran 95. See <a href="https://developer.R-project.org/Portability.html" class="uri">https://developer.R-project.org/Portability.html</a> for reference resources. In particular, <em>free source form</em> F95 code is not portable.
</p>
<p>
On some systems an alternative F95 compiler is available: from the <code class="calibre2">gcc</code> family this might be <code class="calibre2">gfortran</code> or <code class="calibre2">g95</code>. Configuring R will try to find a compiler which (from its name) appears to be a Fortran 90/95 compiler, and set it in macro ‘FC’. Note that it does not check that such a compiler is fully (or even partially) compliant with Fortran 90/95. Packages making use of Fortran 90/95 features should use file extension .f90 or .f95 for the source files: the variable <code class="calibre2">PKG_FCFLAGS</code> specifies any special flags to be used. There is no guarantee that compiled Fortran 90/95 code can be mixed with any other type of compiled code, nor that a build of R will have support for such packages.
</p>
<p>
Some (but not) all compilers specified by the ‘FC’ macro will accept Fortran 2003 or 2008 code: such code should still use file extension .f90 or .f95. For platforms using <code class="calibre2">gfortran</code>, you may need to include -std=f2003 or -std=f2008 in <code class="calibre2">PKG_FCFLAGS</code>: the default is ‘GNU Fortran’, Fortran 95 with non-standard extensions. The Oracle <code class="calibre2">f95</code> compiler ‘accepts some Fortran 2003/8 features’ (search for ‘Oracle Developer Studio 12.5: Fortran User’s Guide’ and look for §4.6).
</p>
<p>
Modern versions of Fortran support modules, whereby compiling one source file creates a module file which is then included in others. (Module files typically have a .mod extension: they do depend on the compiler used and so should never be included in a package.) This creates a dependence which <code class="calibre2">make</code> will not know about and often causes installation with a parallel make to fail. Thus it is necessary to add explicit dependencies to src/Makevars to tell <code class="calibre2">make</code> the constraints on the order of compilation. For example, if file iface.f90 creates a module ‘iface’ used by files cmi.f90 and dmi.f90 then src/Makevars needs to contain something like
</p>
<div class="example">
<pre class="example1"><code>cmi.o dmi.o: iface.o</code></pre>
</div>
<hr />
<p>
<a href="" id="Using-C_002b_002b11-code"></a> <a href="" id="Using-C_002b_002b11-code-1"></a>
</p>
<h4 id="using-c11-code" class="subsection">
1.2.4 Using C++11 code
</h4>
<p>
R can be built without a C++ compiler although one is available (but not necessarily installed) on all known R platforms. For full portability across platforms, all that can be assumed is approximate support for the C++98 standard (the widely used <code class="calibre2">g++</code> deviates considerably from the standard). Some compilers have a concept of ‘C++03’ (‘essentially a bug fix’) or ‘C++ Technical Report 1’ (TR1), an optional addition to the ‘C++03’ revision which was published in 2007. A revised standard was published in 2011 and compilers with pretty much complete implementations are available. C++11 added all of the C99 features which are not otherwise implemented in C++, and C++ compilers commonly accept C99 extensions to C++98. A minor update<a href="concept-index.html#FOOT38" id="DOCF38"><sup>38</sup></a> to C++11 (C++14) was published in December 2014. The next standard has been sent to ISO and is likely to be approved in 2017: it is informally known as C++17.
</p>
<p>
What standard a C++ compiler aims to support can be hard to determine: the value<a href="concept-index.html#FOOT39" id="DOCF39"><sup>39</sup></a> of <code class="calibre2">__cplusplus</code> may help but some compilers use it to denote a standard which is partially supported and some the latest standard which is (almost) fully supported. As from version 6, <code class="calibre2">g++</code> defaults to C++14 (with GNU extensions): earlier versions aim to support C++03 with many extensions (including support for TR1). <code class="calibre2">clang</code> with its native<a href="concept-index.html#FOOT40" id="DOCF40"><sup>40</sup></a> <code class="calibre2">libc++</code> headers and library includes many C++11 features, and does not support TR1.
</p>
<p>
Since version 3.1.0, R has provided support for C++11 in packages in addition to C++98. This support is not uniform across platforms as it depends on the capabilities of the compiler (see below). When R is configured, it will determine whether the C++ compiler supports C++11 and which compiler flags, if any, are required to enable C++11 support. For example, recent versions of <code class="calibre2">g++</code> or <code class="calibre2">clang++</code> accept the compiler flag -std=c++11, and earlier versions support a flag -std=c++0x, but the latter only provided partial support for the C++11 standard (it later became a deprecated synonym for -std=c++11).
</p>
<p>
In order to use C++11 code in a package, the package’s Makevars file (or Makevars.win on Windows) should include the line
</p>
<div class="example">
<pre class="example1"><code>CXX_STD = CXX11</code></pre>
</div>
<p>
Compilation and linking will then be done with the C++11 compiler.
</p>
<p>
Packages without a src/Makevars or src/Makefile file may specify that they require C++11 for code in the src directory by including ‘C++11’ in the ‘SystemRequirements’ field of the DESCRIPTION file, e.g.
</p>
<div class="example">
<pre class="example1"><code>SystemRequirements: C++11</code></pre>
</div>
<p>
If a package does have a src/Makevars[.win] file then setting the make variable ‘CXX_STD’ is preferred, as it allows <code class="calibre2">R CMD SHLIB</code> to work correctly in the package’s src directory.
</p>
<p>
Conversely, to ensure that the C++98 standard is assumed even when this is not the compiler default, use
</p>
<div class="example">
<pre class="example1"><code>SystemRequirements: C++98</code></pre>
</div>
<p>
or
</p>
<div class="example">
<pre class="example1"><code>CXX_STD = CXX98</code></pre>
</div>
<p>
The C++11 compiler will be used systematically by R for all C++ code if the environment variable <code class="calibre2">USE_CXX11</code> is defined (with any value). Hence this environment variable should be defined when invoking <code class="calibre2">R CMD SHLIB</code> in the absence of a Makevars file (or Makevars.win on Windows) if a C++11 compiler is required.
</p>
<p>
Further control over compilation of C++11 code can be obtained by specifying the macros ‘CXX11’ and ‘CXX11STD’ when R is configured<a href="concept-index.html#FOOT41" id="DOCF41"><sup>41</sup></a>, or in a personal or site Makevars file. If C++11 support is not available then these macros are both empty; if it is available by default, ‘CXX11’ defaults to ‘CXX’ and ‘CXX11STD’ is empty . Otherwise, ‘CXX11’ defaults to the same value as the C++ compiler ‘CXX’ and the flag ‘CXX11STD’ defaults to -std=c++11 or similar. It is possible to specify ‘CXX11’ to be a distinct compiler just for C++11–using packages, e.g. <code class="calibre2">g++</code> on Solaris. Note however that different C++ compilers (and even different versions of the same compiler) often differ in their ABI so their outputs can rarely be mixed. By setting ‘CXX11STD’ it is also possible to choose a different dialect of the standard such as -std=c++11.
</p>
<p>
As noted above, support for C++11 varies across platforms: on some platforms, it may be possible or necessary to select a different compiler for C++11, <em>via</em> personal or site Makevars files.
</p>
<p>
There is no guarantee that C++11 can be used in a package in combination with any other compiled language (even C), as the C++11 compiler may be incompatible with the native compilers for the platform. (There are known problems mixing C++11 with Fortran.)
</p>
<p>
If a package using C++11 has a <code class="calibre2">configure</code> script it is essential that it selects the correct compiler, <em>via</em> something like
</p>
<div class="example">
<pre class="example1"><code>CXX11=`&quot;&#36;{R_HOME}/bin/R&quot; CMD config CXX11`
CXX11STD=`&quot;&#36;{R_HOME}/bin/R&quot; CMD config CXX11STD`
CXX=&quot;&#36;{CXX11} &#36;{CXX11STD}&quot;
CXXFLAGS=`&quot;&#36;{R_HOME}/bin/R&quot; CMD config CXX11FLAGS`
AC_LANG(C++)</code></pre>
</div>
<p>
(paying attention to all the quotes required).
</p>
<p>
If you want to compile C++11 code in a subdirectory, make sure you pass down the macros to specify that compiler, e.g. in src/Makevars
</p>
<div class="example">
<pre class="example1"><code>sublibs:
         @(cd libs &amp;&amp; &#36;(MAKE) &#92;
            CXX=&quot;&#36;(CXX11) &#36;(CXX11STD)&quot; CXXFLAGS=&quot;&#36;(CXX11FLAGS) &#36;(CXX11PICFLAGS)&quot;)</code></pre>
</div>
<p>
Note that the mechanisms described here specify C++11 for code compiled by <code class="calibre2">R CMD SHLIB</code> as used by default by <code class="calibre2">R CMD INSTALL</code>. They do not necessarily apply if there is a src/Makefile file, nor to compilation done in vignettes or <em>via</em> other packages.
</p>
<hr />
<p>
<a href="" id="Using-C_002b_002b14-code"></a> <a href="" id="Using-C_002b_002b14-code-1"></a>
</p>
<h4 id="using-c14-code" class="subsection">
1.2.5 Using C++14 code
</h4>
<p>
Support for a C++14 has been explicitly added to R from version 3.4.0. Similar considerations to C++11 apply, except that the variables associated with the C++14 compiler use the prefix ‘CXX14’ instead of ‘CXX11’. Hence to use C++14 code in a package, the package’s Makevars file (or Makevars.win on Windows) should include the line
</p>
<div class="example">
<pre class="example1"><code>CXX_STD = CXX14</code></pre>
</div>
<p>
In the absence of a Makevars file, C++14 support can also be requested by the line:
</p>
<div class="example">
<pre class="example1"><code>SystemRequirements: C++14</code></pre>
</div>
<p>
in the DESCRIPTION file. Finally, the C++14 compiler can be used systematically by setting the environment variable <code class="calibre2">USE_CXX17</code>.
</p>
<p>
Note that code written for C++11 that emulates features of C++14 will not necessarily compile under a C++14 compiler<a href="concept-index.html#FOOT42" id="DOCF42"><sup>42</sup></a>, since the emulation typically leads to a namespace clash. In order to ensure that the code also compiles under C++14, something like the following should be done:
</p>
<div class="example">
<pre class="example1"><code>#if __cplusplus &gt;= 201402L
using std::make_unique;
#else
// your emulation
#endif</code></pre>
</div>
<p>
Code needing C++14 features would do better to test for their presence <em>via</em> ‘SD-6 feature tests’<a href="concept-index.html#FOOT43" id="DOCF43"><sup>43</sup></a>. That test could be
</p>
<div class="example">
<pre class="example1"><code>#include &lt;memory&gt; // header where this is defined
#if defined(__cpp_lib_make_unique) &amp;&amp; (__cpp_lib_make_unique &gt;= 201304)
using std::make_unique;
#else
// your emulation
#endif</code></pre>
</div>
<p>
The webpage <a href="http://en.cppreference.com/w/cpp/compiler_support" class="uri">http://en.cppreference.com/w/cpp/compiler_support</a> gives some information on which compilers are known to support recent C++ features, including those in the C++17 drafts (for which feature tests should be used).
</p>
<hr />
<p>
<a href="" id="Using-C_002b_002b17-code"></a> <a href="" id="Using-C_002b_002b17-code-1"></a>
</p>
<h4 id="using-c17-code" class="subsection">
1.2.6 Using C++17 code
</h4>
<p>
Experimental support for C++17 has been added to R version 3.4.0. The configure script tests a subset of C++17 features. At the time of writing (March 2017) both <code class="calibre2">clang 4.0.0</code> and <code class="calibre2">gcc 7.1</code> pass these tests (with flags -std=gnu++1z and -std=gnu++17 respectively chosen by the configure script). Note that the C++17 feature tests are incomplete and are subject to change in future R versions as compiler support for the standard improves.
</p>
<p>
The variables associated with the C++17 compiler use the prefix ‘CXX17’. Hence to use C++17 code in a package, the package’s Makevars file (or Makevars.win on Windows) should include the line
</p>
<div class="example">
<pre class="example1"><code>CXX_STD = CXX17</code></pre>
</div>
<p>
In the absence of a Makevars file, C++17 support can also be requested by the line:
</p>
<div class="example">
<pre class="example1"><code>SystemRequirements: C++17</code></pre>
</div>
<p>
in the DESCRIPTION file. Finally, the C++17 compiler can be used systematically by setting the environment variable <code class="calibre2">USE_CXX17</code>.
</p>
<hr />
<p>
<a href="" id="Checking-and-building-packages"></a> <a href="" id="Checking-and-building-packages-1"></a>
</p>
<h3 id="checking-and-building-packages" class="section">
1.3 Checking and building packages
</h3>
<p>
Before using these tools, please check that your package can be installed (which checked it can be loaded). <code class="calibre2">R CMD check</code> will <em>inter alia</em> do this, but you may get more detailed error messages doing the install directly.
</p>
<p>
If your package specifies an encoding in its DESCRIPTION file, you should run these tools in a locale which makes use of that encoding: they may not work at all or may work incorrectly in other locales (although UTF-8 locales will most likely work).
</p>
<blockquote>
<p>
<strong>Note:</strong> <code class="calibre2">R CMD check</code> and <code class="calibre2">R CMD build</code> run R processes with –vanilla in which none of the user’s startup files are read. If you need <code class="calibre2">R_LIBS</code> set (to find packages in a non-standard library) you can set it in the environment: also you can use the check and build environment files (as specified by the environment variables <code class="calibre2">R_CHECK_ENVIRON</code> and <code class="calibre2">R_BUILD_ENVIRON</code>; if unset, files<a href="concept-index.html#FOOT44" id="DOCF44"><sup>44</sup></a> ~/.R/check.Renviron and ~/.R/build.Renviron are used) to set environment variables when using these utilities.
</p>
</blockquote>
<blockquote>
<p>
<strong>Note to Windows users:</strong> <code class="calibre2">R CMD build</code> may make use of the Windows toolset (see the “R Installation and Administration” manual) if present and in your path, and it is required for packages which need it to install (including those with configure.win or cleanup.win scripts or a src directory) and e.g. need vignettes built.
</p>
<p>
You may need to set the environment variable <code class="calibre2">TMPDIR</code> to point to a suitable writable directory with a path not containing spaces – use forward slashes for the separators. Also, the directory needs to be on a case-honouring file system (some network-mounted file systems are not).
</p>
</blockquote>
<hr />
<p>
<a href="" id="Checking-packages"></a> <a href="" id="Checking-packages-1"></a>
</p>
<h4 id="checking-packages" class="subsection">
1.3.1 Checking packages
</h4>
<p>
<a href="" id="index-Checking-packages"></a> <a href="" id="index-R-CMD-check"></a>
</p>
<p>
Using <code class="calibre2">R CMD check</code>, the R package checker, one can test whether <em>source</em> R packages work correctly. It can be run on one or more directories, or compressed package <code class="calibre2">tar</code> archives with extension .tar.gz, .tgz, .tar.bz2 or .tar.xz.
</p>
<p>
It is strongly recommended that the final checks are run on a <code class="calibre2">tar</code> archive prepared by <code class="calibre2">R CMD build</code>.
</p>
<p>
This runs a series of checks, including
</p>
<ol>
<li>
The package is installed. This will warn about missing cross-references and duplicate aliases in help files.
</li>
<li>
The file names are checked to be valid across file systems and supported operating system platforms.
</li>
<li>
The files and directories are checked for sufficient permissions (Unix-alikes only).
</li>
<li>
The files are checked for binary executables, using a suitable version of <code class="calibre2">file</code> if available<a href="concept-index.html#FOOT45" id="DOCF45"><sup>45</sup></a>. (There may be rare false positives.)
</li>
<li>
The DESCRIPTION file is checked for completeness, and some of its entries for correctness. Unless installation tests are skipped, checking is aborted if the package dependencies cannot be resolved at run time. (You may need to set <code class="calibre2">R_LIBS</code> in the environment if dependent packages are in a separate library tree.) One check is that the package name is not that of a standard package, nor one of the defunct standard packages (‘ctest’, ‘eda’, ‘lqs’, ‘mle’, ‘modreg’, ‘mva’, ‘nls’, ‘stepfun’ and ‘ts’). Another check is that all packages mentioned in <code class="calibre2">library</code> or <code class="calibre2">require</code>s or from which the NAMESPACE file imports or are called <em>via</em> <code class="calibre2">::</code> or <code class="calibre2">:::</code> are listed (in ‘Depends’, ‘Imports’, ‘Suggests’): this is not an exhaustive check of the actual imports.
</li>
<li>
Available index information (in particular, for demos and vignettes) is checked for completeness.
</li>
<li>
<p>
The package subdirectories are checked for suitable file names and for not being empty. The checks on file names are controlled by the option –check-subdirs=value. This defaults to ‘default’, which runs the checks only if checking a tarball: the default can be overridden by specifying the value as ‘yes’ or ‘no’. Further, the check on the src directory is only run if the package does not contain a configure script (which corresponds to the value ‘yes-maybe’) and there is no src/Makefile or src/Makefile.in.
</p>
<p>
To allow a configure script to generate suitable files, files ending in ‘.in’ will be allowed in the R directory.
</p>
<p>
A warning is given for directory names that look like R package check directories – many packages have been submitted to CRAN containing these.
</p>
</li>
<li>
The R files are checked for syntax errors. Bytes which are non-ASCII are reported as warnings, but these should be regarded as errors unless it is known that the package will always be used in the same locale.
</li>
<li>
It is checked that the package can be loaded, first with the usual default packages and then only with package <strong>base</strong> already loaded. It is checked that the namespace this can be loaded in an empty session with only the <strong>base</strong> namespace loaded. (Namespaces and packages can be loaded very early in the session, before the default packages are available, so packages should work then.)
</li>
<li>
The R files are checked for correct calls to <code class="calibre2">library.dynam</code>. Package startup functions are checked for correct argument lists and (incorrect) calls to functions which modify the search path or inappropriately generate messages. The R code is checked for possible problems using <a href="https://CRAN.R-project.org/package=codetools"><strong>codetools</strong></a>. In addition, it is checked whether S3 methods have all arguments of the corresponding generic, and whether the final argument of replacement functions is called ‘value’. All foreign function calls (<code class="calibre2">.C</code>, <code class="calibre2">.Fortran</code>, <code class="calibre2">.Call</code> and <code class="calibre2">.External</code> calls) are tested to see if they have a <code class="calibre2">PACKAGE</code> argument, and if not, whether the appropriate DLL might be deduced from the namespace of the package. Any other calls are reported. (The check is generous, and users may want to supplement this by examining the output of <code class="calibre2">tools::checkFF(“mypkg”, verbose=TRUE)</code>, especially if the intention were to always use a <code class="calibre2">PACKAGE</code> argument)
</li>
<li>
The Rd files are checked for correct syntax and metadata, including the presence of the mandatory fields (<code class="calibre2">\name</code>, <code class="calibre2">\alias</code>, <code class="calibre2">\title</code> and <code class="calibre2">\description</code>). The Rd name and title are checked for being non-empty, and there is a check for missing cross-references (links).
</li>
<li>
A check is made for missing documentation entries, such as undocumented user-level objects in the package.
</li>
<li>
Documentation for functions, data sets, and S4 classes is checked for consistency with the corresponding code.
</li>
<li>
It is checked whether all function arguments given in <code class="calibre2">\usage</code> sections of Rd files are documented in the corresponding <code class="calibre2">\arguments</code> section.
</li>
<li>
The data directory is checked for non-ASCII characters and for the use of reasonable levels of compression.
</li>
<li>
<p>
C, C++ and FORTRAN source and header files<a href="concept-index.html#FOOT46" id="DOCF46"><sup>46</sup></a> are tested for portable (LF-only) line endings. If there is a Makefile or Makefile.in or Makevars or Makevars.in file under the src directory, it is checked for portable line endings and the correct use of ‘$(BLAS_LIBS)’ and ‘$(LAPACK_LIBS)’
</p>
<p>
Compiled code is checked for symbols corresponding to functions which might terminate R or write to stdout/stderr instead of the console. Note that the latter might give false positives in that the symbols might be pulled in with external libraries and could never be called. Windows<a href="concept-index.html#FOOT47" id="DOCF47"><sup>47</sup></a> users should note that the Fortran and C++ runtime libraries are examples of such external libraries.
</p>
</li>
<li>
Some checks are made of the contents of the inst/doc directory. These always include checking for files that look like leftovers, and if suitable tools (such as <code class="calibre2">qpdf</code>) are available, checking that the PDF documentation is of minimal size.
</li>
<li>
<p>
The examples provided by the package’s documentation are run. (see <a href="writing-r-documentation-files.html">Writing R documentation files</a>, for information on using <code class="calibre2">\examples</code> to create executable example code.) If there is a file tests/Examples/pkg-Ex.Rout.save, the output of running the examples is compared to that file.
</p>
<p>
Of course, released packages should be able to run at least their own examples. Each example is run in a ‘clean’ environment (so earlier examples cannot be assumed to have been run), and with the variables <code class="calibre2">T</code> and <code class="calibre2">F</code> redefined to generate an error unless they are set in the example: See <a href="./R-intro.html#Logical-vectors">Logical vectors</a> in An Introduction to R.
</p>
</li>
<li>
If the package sources contain a tests directory then the tests specified in that directory are run. (Typically they will consist of a set of .R source files and target output files .Rout.save.) Please note that the comparison will be done in the end user’s locale, so the target output files should be ASCII if at all possible. (The command line option <code class="calibre2">–test-dir=foo</code> may be used to specify tests in a non-standard location. For example, unusually slow tests could be placed in inst/slowTests and then <code class="calibre2">R CMD check –test-dir=inst/slowTests</code> would be used to run them. Other names that have been suggested are, for example, inst/testWithOracle for tests that require Oracle to be installed, inst/randomTests for tests which use random values and may occasionally fail by chance, etc.)
</li>
<li>
<p>
The code in package vignettes (see <a href="creating-r-packages.html#Writing-package-vignettes">Writing package vignettes</a>) is executed, and the vignette PDFs re-made from their sources as a check of completeness of the sources (unless there is a ‘BuildVignettes’ field in the package’s DESCRIPTION file with a false value). If there is a target output file .Rout.save in the vignette source directory, the output from running the code in that vignette is compared with the target output file and any differences are reported (but not recorded in the log file). (If the vignette sources are in the deprecated location inst/doc, do mark such target output files to not be installed in .Rinstignore.)
</p>
<p>
If there is an error<a href="concept-index.html#FOOT48" id="DOCF48"><sup>48</sup></a> in executing the R code in vignette foo.ext, a log file foo.ext.log is created in the check directory. The vignette PDFs are re-made in a copy of the package sources in the vign_test subdirectory of the check directory, so for further information on errors look in directory pkgname/vign_test/vignettes. (It is only retained if there are errors or if environment variable <code class="calibre2"><em>R_CHECK_CLEAN_VIGN_TEST</em></code> is set to a false value.)
</p>
</li>
<li>
The PDF version of the package’s manual is created (to check that the Rd files can be converted successfully). This needs LaTeX and suitable fonts and LaTeX packages to be installed. See the section ‘Making the manuals’ in the ‘R Installation and Administration’ manual’ for further details.
</li>
</ol>
<p>
All these tests are run with collation set to the <code class="calibre2">C</code> locale, and for the examples and tests with environment variable <code class="calibre2">LANGUAGE=en</code>: this is to minimize differences between platforms.
</p>
<p>
Use R CMD check –help to obtain more information about the usage of the R package checker. A subset of the checking steps can be selected by adding command-line options. It also allows customization by setting environment variables <code class="calibre2"><em>R_CHECK</em>*_</code> as described in ‘R Internals’: a set of these customizations similar to those used by CRAN can be selected by the option –as-cran (which works best if Internet access is available). Some Windows users may need to set environment variable <code class="calibre2">R_WIN_NO_JUNCTIONS</code> to a non-empty value. The test of cyclic declarations<a href="concept-index.html#FOOT49" id="DOCF49"><sup>49</sup></a>in DESCRIPTION files needs repositories (including CRAN) set: do this in ~/.Rprofile, by e.g.
</p>
<div class="example">
<pre class="example1"><code>options(repos = c(CRAN=&quot;https://cran.r-project.org&quot;))</code></pre>
</div>
<p>
One check customization which can be revealing is
</p>
<div class="example">
<pre class="example1"><code>_R_CHECK_CODETOOLS_PROFILE_=&quot;suppressLocalUnused=FALSE&quot;</code></pre>
</div>
<p>
which reports unused local assignments. Not only does this point out computations which are unnecessary because their results are unused, it also can uncover errors. (Two such are to intend to update an object by assigning a value but mistype its name or assign in the wrong scope, for example using <code class="calibre2">&lt;-</code> where <code class="calibre2">&lt;&lt;-</code> was intended.) This can give false positives, most commonly because of non-standard evaluation for formulae and because the intention is to return objects in the environment of a function for later use.
</p>
<p>
Complete checking of a package which contains a file README.md needs <code class="calibre2">pandoc</code> installed: see <a href="http://johnmacfarlane.net/pandoc/installing.html" class="uri">http://johnmacfarlane.net/pandoc/installing.html</a>. This should be reasonably current: at the time of writing CRAN used version 1.12.4.2 to process these files.
</p>
<p>
You do need to ensure that the package is checked in a suitable locale if it contains non-ASCII characters. Such packages are likely to fail some of the checks in a <code class="calibre2">C</code> locale, and <code class="calibre2">R CMD check</code> will warn if it spots the problem. You should be able to check any package in a UTF-8 locale (if one is available). Beware that although a <code class="calibre2">C</code> locale is rarely used at a console, it may be the default if logging in remotely or for batch jobs.
</p>
<blockquote>
<p>
<strong>Multiple sub-architectures:</strong> On systems which support multiple sub-architectures (principally Windows), <code class="calibre2">R CMD check</code> will install and check a package which contains compiled code under all available sub-architectures. (Use option –force-multiarch to force this for packages without compiled code, which are otherwise only checked under the main sub-architecture.) This will run the loading tests, examples and tests directory under each installed sub-architecture in turn, and give an error if any fail. Where environment variables (including perhaps <code class="calibre2">PATH</code>) need to be set differently for each sub-architecture, these can be set in architecture-specific files such as R_HOME/etc/i386/Renviron.site.
</p>
<p>
An alternative approach is to use <code class="calibre2">R CMD check –no-multiarch</code> to check the primary sub-architecture, and then to use something like <code class="calibre2">R –arch=x86_64 CMD check –extra-arch</code> or (Windows) <code class="calibre2">/path/to/R/bin/x64/Rcmd check –extra-arch</code> to run for each additional sub-architecture just the checks<a href="concept-index.html#FOOT50" id="DOCF50"><sup>50</sup></a> which differ by sub-architecture. (This approach is required for packages which are installed by <code class="calibre2">R CMD INSTALL –merge-multiarch</code>.)
</p>
<p>
Where packages need additional commands to install all the sub-architectures these can be supplied by e.g. –install-args=–force-biarch.
</p>
</blockquote>
<hr />
<p>
<a href="" id="Building-package-tarballs"></a> <a href="" id="Building-package-tarballs-1"></a>
</p>
<h4 id="building-package-tarballs" class="subsection">
1.3.2 Building package tarballs
</h4>
<p>
<a href="" id="index-Building-source-packages"></a> <a href="" id="index-R-CMD-build"></a> <a href="" id="index-Package-builder"></a> <a href="" id="index-tarballs"></a>
</p>
<p>
Packages may be distributed in source form as “tarballs” (.tar.gz files) or in binary form. The source form can be installed on all platforms with suitable tools and is the usual form for Unix-like systems; the binary form is platform-specific, and is the more common distribution form for the Windows and macOS platforms.
</p>
<p>
Using <code class="calibre2">R CMD build</code>, the R package builder, one can build R package tarballs from their sources (for example, for subsequent release).
</p>
<p>
Prior to actually building the package in the standard gzipped tar file format, a few diagnostic checks and cleanups are performed. In particular, it is tested whether object indices exist and can be assumed to be up-to-date, and C, C++ and FORTRAN source files and relevant makefiles in a src directory are tested and converted to LF line-endings if necessary.
</p>
<p>
Run-time checks whether the package works correctly should be performed using <code class="calibre2">R CMD check</code> prior to invoking the final build procedure.
</p>
<p>
<a href="" id="index-_002eRbuildignore-file"></a>
</p>
<p>
To exclude files from being put into the package, one can specify a list of exclude patterns in file .Rbuildignore in the top-level source directory. These patterns should be Perl-like regular expressions (see the help for <code class="calibre2">regexp</code> in R for the precise details), one per line, to be matched case-insensitively against the file and directory names relative to the top-level package source directory. In addition, directories from source control systems<a href="concept-index.html#FOOT51" id="DOCF51"><sup>51</sup></a> or from <code class="calibre2">eclipse</code><a href="concept-index.html#FOOT52" id="DOCF52"><sup>52</sup></a>, directories with names ending .Rcheck or Old or old and files GNUMakefile<a href="concept-index.html#FOOT53" id="DOCF53"><sup>53</sup></a>, Read-and-delete-me or with base names starting with ‘.#’, or starting and ending with ‘#’, or ending in ‘~’, ‘.bak’ or ‘.swp’, are excluded by default. In addition, those files in the R, demo and man directories which are flagged by <code class="calibre2">R CMD check</code> as having invalid names will be excluded.
</p>
<p>
Use R CMD build –help to obtain more information about the usage of the R package builder.
</p>
<p>
Unless R CMD build is invoked with the –no-build-vignettes option (or the package’s DESCRIPTION contains ‘BuildVignettes: no’ or similar), it will attempt to (re)build the vignettes (see <a href="creating-r-packages.html#Writing-package-vignettes">Writing package vignettes</a>) in the package. To do so it installs the current package into a temporary library tree, but any dependent packages need to be installed in an available library tree (see the Note: at the top of this section).
</p>
<p>
Similarly, if the .Rd documentation files contain any <code class="calibre2">\Sexpr</code> macros (see <a href="writing-r-documentation-files.html#Dynamic-pages">Dynamic pages</a>), the package will be temporarily installed to execute them. Post-execution binary copies of those pages containing build-time macros will be saved in build/partial.rdb. If there are any install-time or render-time macros, a .pdf version of the package manual will be built and installed in the build subdirectory. (This allows CRAN or other repositories to display the manual even if they are unable to install the package.) This can be suppressed by the option –no-manual or if package’s DESCRIPTION contains ‘BuildManual: no’ or similar.
</p>
<p>
One of the checks that <code class="calibre2">R CMD build</code> runs is for empty source directories. These are in most (but not all) cases unintentional, if they are intentional use the option –keep-empty-dirs (or set the environment variable <code class="calibre2"><em>R_BUILD_KEEP_EMPTY_DIRS</em></code> to ‘TRUE’, or have a ‘BuildKeepEmpty’ field with a true value in the DESCRIPTION file).
</p>
<p>
The –resave-data option allows saved images (.rda and .RData files) in the data directory to be optimized for size. It will also compress tabular files and convert .R files to saved images. It can take values <code class="calibre2">no</code>, <code class="calibre2">gzip</code> (the default if this option is not supplied, which can be changed by setting the environment variable <code class="calibre2"><em>R_BUILD_RESAVE_DATA</em></code>) and <code class="calibre2">best</code> (equivalent to giving it without a value), which chooses the most effective compression. Using <code class="calibre2">best</code> adds a dependence on <code class="calibre2">R (&gt;= 2.10)</code> to the DESCRIPTION file if <code class="calibre2">bzip2</code> or <code class="calibre2">xz</code> compression is selected for any of the files. If this is thought undesirable, –resave-data=gzip (which is the default if that option is not supplied) will do what compression it can with <code class="calibre2">gzip</code>. A package can control how its data is resaved by supplying a ‘BuildResaveData’ field (with one of the values given earlier in this paragraph) in its DESCRIPTION file.
</p>
<p>
The –compact-vignettes option will run <code class="calibre2">tools::compactPDF</code> over the PDF files in inst/doc (and its subdirectories) to losslessly compress them. This is not enabled by default (it can be selected by environment variable <code class="calibre2"><em>R_BUILD_COMPACT_VIGNETTES</em></code>) and needs <code class="calibre2">qpdf</code> (<a href="http://qpdf.sourceforge.net/" class="uri">http://qpdf.sourceforge.net/</a>) to be available.
</p>
<p>
It can be useful to run <code class="calibre2">R CMD check –check-subdirs=yes</code> on the built tarball as a final check on the contents.
</p>
<p>
Where a non-POSIX file system is in use which does not utilize execute permissions, some care is needed with permissions. This applies on Windows and to e.g. FAT-formatted drives and SMB-mounted file systems on other OSes. The ‘mode’ of the file recorded in the tarball will be whatever <code class="calibre2">file.info()</code> returns. On Windows this will record only directories as having execute permission and on other OSes it is likely that all files have reported ‘mode’ <code class="calibre2">0777</code>. A particular issue is packages being built on Windows which are intended to contain executable scripts such as configure and cleanup: <code class="calibre2">R CMD build</code> ensures those two are recorded with execute permission.
</p>
<p>
Directory build of the package sources is reserved for use by <code class="calibre2">R CMD build</code>: it contains information which may not easily be created when the package is installed, including index information on the vignettes and, rarely, information on the help pages and perhaps a copy of the PDF reference manual (see above).
</p>
<hr />
<p>
<a href="" id="Building-binary-packages"></a> <a href="" id="Building-binary-packages-1"></a>
</p>
<h4 id="building-binary-packages" class="subsection">
1.3.3 Building binary packages
</h4>
<p>
<a href="" id="index-Building-binary-packages"></a>
</p>
<p>
Binary packages are compressed copies of installed versions of packages. They contain compiled shared libraries rather than C, C++ or Fortran source code, and the R functions are included in their installed form. The format and filename are platform-specific; for example, a binary package for Windows is usually supplied as a .zip file, and for the macOS platform the default binary package file extension is .tgz.
</p>
<p>
The recommended method of building binary packages is to use
</p>
<p>
<code class="calibre2">R CMD INSTALL –build pkg</code> where pkg is either the name of a source tarball (in the usual .tar.gz format) or the location of the directory of the package source to be built. This operates by first installing the package and then packing the installed binaries into the appropriate binary package file for the particular platform.
</p>
<p>
By default, <code class="calibre2">R CMD INSTALL –build</code> will attempt to install the package into the default library tree for the local installation of R. This has two implications:
</p>
<ul>
<li>
If the installation is successful, it will overwrite any existing installation of the same package.
</li>
<li>
The default library tree must have write permission; if not, the package will not install and the binary will not be created.
</li>
</ul>
<p>
To prevent changes to the present working installation or to provide an install location with write access, create a suitably located directory with write access and use the <code class="calibre2">-l</code> option to build the package in the chosen location. The usage is then
</p>
<p>
<code class="calibre2">R CMD INSTALL -l location –build pkg</code>
</p>
<p>
where location is the chosen directory with write access. The package will be installed as a subdirectory of location, and the package binary will be created in the current directory.
</p>
<p>
Other options for <code class="calibre2">R CMD INSTALL</code> can be found using <code class="calibre2">R CMD INSTALL –help</code>, and platform-specific details for special cases are discussed in the platform-specific FAQs.
</p>
<p>
Finally, at least one web-based service is available for building binary packages from (checked) source code: WinBuilder (see <a href="https://win-builder.R-project.org/" class="uri">https://win-builder.R-project.org/</a>) is able to build Windows binaries. Note that this is intended for developers on other platforms who do not have access to Windows but wish to provide binaries for the Windows platform.
</p>
<hr />
<p>
<a href="" id="Writing-package-vignettes"></a> <a href="" id="Writing-package-vignettes-1"></a>
</p>

<h3 id="writing-package-vignettes" class="section">
1.4 Writing package vignettes
</h3>
<p>
<a href="" id="index-vignettes"></a> <a href="" id="index-Sweave"></a>
</p>
<p>
In addition to the help files in Rd format, R packages allow the inclusion of documents in arbitrary other formats. The standard location for these is subdirectory inst/doc of a source package, the contents will be copied to subdirectory doc when the package is installed. Pointers from package help indices to the installed documents are automatically created. Documents in inst/doc can be in arbitrary format, however we strongly recommend providing them in PDF format, so users on almost all platforms can easily read them. To ensure that they can be accessed from a browser (as an HTML index is provided), the file names should start with an ASCII letter and be comprised entirely of ASCII letters or digits or hyphen or underscore.
</p>
<p>
A special case is <em>package vignettes</em>. Vignettes are documents in PDF or HTML format obtained from plain text literate source files from which R knows how to extract R code and create output (in PDF/HTML or intermediate LaTeX). Vignette engines do this work, using “tangle” and “weave” functions respectively. Sweave, provided by the R distribution, is the default engine. Since R version 3.0.0, other vignette engines besides Sweave are supported; see <a href="creating-r-packages.html#Non_002dSweave-vignettes">Non-Sweave vignettes</a>.
</p>
<p>
Package vignettes have their sources in subdirectory vignettes of the package sources. Note that the location of the vignette sources only affects <code class="calibre2">R CMD build</code> and <code class="calibre2">R CMD check</code>: the tarball built by <code class="calibre2">R CMD build</code> includes in inst/doc the components intended to be installed.
</p>
<p>
Sweave vignette sources are normally given the file extension .Rnw or .Rtex, but for historical reasons extensions<a href="concept-index.html#FOOT54" id="DOCF54"><sup>54</sup></a> .Snw and .Stex are also recognized. Sweave allows the integration of LaTeX documents: see the <code class="calibre2">Sweave</code> help page in R and the <code class="calibre2">Sweave</code> vignette in package <strong>utils</strong> for details on the source document format.
</p>
<p>
Package vignettes are tested by <code class="calibre2">R CMD check</code> by executing all R code chunks they contain (except those marked for non-evaluation, e.g., with option <code class="calibre2">eval=FALSE</code> for Sweave). The R working directory for all vignette tests in <code class="calibre2">R CMD check</code> is a <em>copy</em> of the vignette source directory. Make sure all files needed to run the R code in the vignette (data sets, …) are accessible by either placing them in the inst/doc hierarchy of the source package or by using calls to <code class="calibre2">system.file()</code>. All other files needed to re-make the vignettes (such as LaTeX style files, BibTeX input files and files for any figures not created by running the code in the vignette) must be in the vignette source directory. <code class="calibre2">R CMD check</code> will check that vignette production has succeeded by comparing modification times of output files in inst/doc with the source in vignettes.
</p>
<p>
<code class="calibre2">R CMD build</code> will automatically<a href="concept-index.html#FOOT55" id="DOCF55"><sup>55</sup></a> create the (PDF or HTML versions of the) vignettes in inst/doc for distribution with the package sources. By including the vignette outputs in the package sources it is not necessary that these can be re-built at install time, i.e., the package author can use private R packages, screen snapshots and LaTeX extensions which are only available on his machine.<a href="concept-index.html#FOOT56" id="DOCF56"><sup>56</sup></a>
</p>
<p>
By default <code class="calibre2">R CMD build</code> will run <code class="calibre2">Sweave</code> on all Sweave vignette source files in vignettes. If Makefile is found in the vignette source directory, then <code class="calibre2">R CMD build</code> will try to run <code class="calibre2">make</code> after the <code class="calibre2">Sweave</code> runs, otherwise <code class="calibre2">texi2pdf</code> is run on each .tex file produced.
</p>
<p>
The first target in the Makefile should take care of both creation of PDF/HTML files and cleaning up afterwards (including after <code class="calibre2">Sweave</code>), i.e., delete all files that shall not appear in the final package archive. Note that if the <code class="calibre2">make</code> step runs R it needs to be careful to respect the environment values of <code class="calibre2">R_LIBS</code> and <code class="calibre2">R_HOME</code><a href="concept-index.html#FOOT57" id="DOCF57"><sup>57</sup></a>. Finally, if there is a Makefile and it has a ‘clean:’ target, <code class="calibre2">make clean</code> is run.
</p>
<p>
All the usual <em>caveats</em> about including a Makefile apply. It must be portable (no GNU extensions), use LF line endings and must work correctly with a parallel <code class="calibre2">make</code>: too many authors have written things like
</p>
<div class="example">
<pre class="example1"><code>## BAD EXAMPLE
all: pdf clean

pdf: ABC-intro.pdf ABC-details.pdf

%.pdf:  %.tex
        texi2dvi --pdf &#36;*

clean:
        rm *.tex ABC-details-*.pdf</code></pre>
</div>
<p>
which will start removing the source files whilst <code class="calibre2">pdflatex</code> is working.
</p>
<p>
Metadata lines can be placed in the source file, preferably in LaTeX comments in the preamble. One such is a <code class="calibre2">\VignetteIndexEntry</code> of the form
</p>
<div class="example">
<pre class="example1"><code>%&#92;VignetteIndexEntry{Using Animal}</code></pre>
</div>
<p>
Others you may see are <code class="calibre2">\VignettePackage</code> (currently ignored), <code class="calibre2">\VignetteDepends</code> and <code class="calibre2">\VignetteKeyword</code> (which replaced <code class="calibre2">\VignetteKeywords</code>). These are processed at package installation time to create the saved data frame Meta/vignette.rds, but only the <code class="calibre2">\VignetteIndexEntry</code> and <code class="calibre2">\VignetteKeyword</code> statements are currently used. The <code class="calibre2">\VignetteEngine</code> statement is described in <a href="creating-r-packages.html#Non_002dSweave-vignettes">Non-Sweave vignettes</a>.
</p>
<p>
At install time an HTML index for all vignettes in the package is automatically created from the <code class="calibre2">\VignetteIndexEntry</code> statements unless a file index.html exists in directory inst/doc. This index is linked from the HTML help index for the package. If you do supply a inst/doc/index.html file it should contain relative links only to files under the installed doc directory, or perhaps (not really an index) to HTML help files or to the DESCRIPTION file, and be valid HTML as confirmed via the <a href="https://validator.w3.org">W3C Markup Validation Service</a> or <a href="https://validator.nu/">Validator.nu</a>.
</p>
<p>
Sweave/Stangle allows the document to specify the <code class="calibre2">split=TRUE</code> option to create a single R file for each code chunk: this will not work for vignettes where it is assumed that each vignette source generates a single file with the vignette extension replaced by .R.
</p>
<p>
Do watch that PDFs are not too large – one in a CRAN package was 72MB! This is usually caused by the inclusion of overly detailed figures, which will not render well in PDF viewers. Sometimes it is much better to generate fairly high resolution bitmap (PNG, JPEG) figures and include those in the PDF document.
</p>
<p>
<a href="" id="index-_002einstall_005fextras-file"></a>
</p>
<p>
When <code class="calibre2">R CMD build</code> builds the vignettes, it copies these and the vignette sources from directory vignettes to inst/doc. To install any other files from the vignettes directory, include a file vignettes/.install_extras which specifies these as Perl-like regular expressions on one or more lines. (See the description of the .Rinstignore file for full details.)
</p>
<hr />
<p>
<a href="" id="Encodings-and-vignettes"></a> <a href="" id="Encodings-and-vignettes-1"></a>
</p>
<h4 id="encodings-and-vignettes" class="subsection">
1.4.1 Encodings and vignettes
</h4>
<p>
Vignettes will in general include descriptive text, R input, R output and figures, LaTeX include files and bibliographic references. As any of these may contain non-ASCII characters, the handling of encodings can become very complicated.
</p>
<p>
The vignette source file should be written in ASCII or contain a declaration of the encoding (see below). This applies even to comments within the source file, since vignette engines process comments to look for options and metadata lines. When an engine’s weave and tangle functions are called on the vignette source, it will be converted to the encoding of the current R session.
</p>
<p>
<code class="calibre2">Stangle()</code> will produce an R code file in the current locale’s encoding: for a non-ASCII vignette what that is is recorded in a comment at the top of the file.
</p>
<p>
<code class="calibre2">Sweave()</code> will produce a .tex file in the current encoding, or in UTF-8 if that is declared. Non-ASCII encodings need to be declared to LaTeX via a line like
</p>
<div class="example">
<pre class="example1"><code>&#92;usepackage[utf8]{inputenc}</code></pre>
</div>
<p>
(It is also possible to use the more recent ‘inputenx’ LaTeX package.) For files where this line is not needed (e.g. chapters included within the body of a larger document, or non-Sweave vignettes), the encoding may be declared using a comment like
</p>
<div class="example">
<pre class="example1"><code>%&#92;VignetteEncoding{UTF-8}</code></pre>
</div>
<p>
If the encoding is UTF-8, this can also be declared using the declaration
</p>
<div class="example">
<pre class="example1"><code>%&#92;SweaveUTF8</code></pre>
</div>
<p>
If no declaration is given in the vignette, it will be assumed to be in the encoding declared for the package. If there is no encoding declared in either place, then it is an error to use non-ASCII characters in the vignette.
</p>
<p>
In any case, be aware that LaTeX may require the ‘usepackage’ declaration.
</p>
<p>
<code class="calibre2">Sweave()</code> will also parse and evaluate the R code in each chunk. The R output will also be in the current locale (or UTF-8 if so declared), and should be covered by the ‘inputenc’ declaration. One thing people often forget is that the R output may not be ASCII even for ASCII R sources, for many possible reasons. One common one is the use of ‘fancy’ quotes: see the R help on <code class="calibre2">sQuote</code>: note carefully that it is not portable to declare UTF-8 or CP1252 to cover such quotes, as their encoding will depend on the locale used to run <code class="calibre2">Sweave()</code>: this can be circumvented by setting <code class="calibre2">options(useFancyQuotes=“UTF-8”)</code> in the vignette.
</p>
<p>
The final issue is the encoding of figures – this applies only to PDF figures and not PNG etc. The PDF figures will contain declarations for their encoding, but the Sweave option <code class="calibre2">pdf.encoding</code> may need to be set appropriately: see the help for the <code class="calibre2">pdf()</code> graphics device.
</p>
<p>
As a real example of the complexities, consider the <a href="https://CRAN.R-project.org/package=fortunes"><strong>fortunes</strong></a> package version ‘1.4-0’. That package did not have a declared encoding, and its vignette was in ASCII. However, the data it displays are read from a UTF-8 CSV file and will be assumed to be in the current encoding, so fortunes.tex will be in UTF-8 in any locale. Had <code class="calibre2">read.table</code> been told the data were UTF-8, fortunes.tex would have been in the locale’s encoding.
</p>
<hr />
<p>
<a href="" id="Non_002dSweave-vignettes"></a> <a href="" id="Non_002dSweave-vignettes-1"></a>
</p>
<h4 id="non-sweave-vignettes" class="subsection">
1.4.2 Non-Sweave vignettes
</h4>
<p>
Vignettes in formats other than Sweave are supported <em>via</em> “vignette engines”. For example <a href="https://CRAN.R-project.org/package=knitr"><strong>knitr</strong></a> version 1.1 or later can create .tex files from a variation on Sweave format, and .html files from a variation on “markdown” format. These engines replace the <code class="calibre2">Sweave()</code> function with other functions to convert vignette source files into LaTeX files for processing into .pdf, or directly into .pdf or .html files. The <code class="calibre2">Stangle()</code> function is replaced with a function that extracts the R source from a vignette.
</p>
<p>
R recognizes non-Sweave vignettes using filename extensions specified by the engine. For example, the <a href="https://CRAN.R-project.org/package=knitr"><strong>knitr</strong></a> package supports the extension .Rmd (standing for “R markdown”). The user indicates the vignette engine within the vignette source using a <code class="calibre2">\VignetteEngine</code> line, for example
</p>
<div class="example">
<pre class="example1"><code>%&#92;VignetteEngine{knitr::knitr}</code></pre>
</div>
<p>
This specifies the name of a package and an engine to use in place of Sweave in processing the vignette. As <code class="calibre2">Sweave</code> is the only engine supplied with the R distribution, the package providing any other engine must be specified in the ‘VignetteBuilder’ field of the package DESCRIPTION file, and also specified in the ‘Suggests’, ‘Imports’ or ‘Depends’ field (since its namespace must be available to build or check your package). If more than one package is specified as a builder, they will be searched in the order given there. The <strong>utils</strong> package is always implicitly appended to the list of builder packages, but may be included earlier to change the search order.
</p>
<p>
Note that a package with non-Sweave vignettes should always have a ‘VignetteBuilder’ field in the DESCRIPTION file, since this is how <code class="calibre2">R CMD check</code> recognizes that there are vignettes to be checked: packages listed there are required when the package is checked.
</p>
<p>
The vignette engine can produce .tex, .pdf, or .html files as output. If it produces .tex files, R will call <code class="calibre2">texi2pdf</code> to convert them to .pdf for display to the user (unless there is a Makefile in the vignettes directory).
</p>
<p>
Package writers who would like to supply vignette engines need to register those engines in the package <code class="calibre2">.onLoad</code> function. For example, that function could make the call
</p>
<div class="example">
<pre class="example1"><code>tools::vignetteEngine(&quot;knitr&quot;, weave = vweave, tangle = vtangle,
                      pattern = &quot;[.]Rmd&#36;&quot;, package = &quot;knitr&quot;)</code></pre>
</div>
<p>
(The actual registration in <a href="https://CRAN.R-project.org/package=knitr"><strong>knitr</strong></a> is more complicated, because it supports other input formats.) See the <code class="calibre2">?tools::vignetteEngine</code> help topic for details on engine registration.
</p>
<hr />
<p>
<a href="" id="Package-namespaces"></a> <a href="" id="Package-namespaces-1"></a>
</p>
<h3 id="package-namespaces" class="section">
1.5 Package namespaces
</h3>
<p>
<a href="" id="index-namespaces"></a>
</p>
<p>
R has a namespace management system for code in packages. This system allows the package writer to specify which variables in the package should be <em>exported</em> to make them available to package users, and which variables should be <em>imported</em> from other packages.
</p>
<p>
The namespace for a package is specified by the NAMESPACE file in the top level package directory. This file contains <em>namespace directives</em> describing the imports and exports of the namespace. Additional directives register any shared objects to be loaded and any S3-style methods that are provided. Note that although the file looks like R code (and often has R-style comments) it is not processed as R code. Only very simple conditional processing of <code class="calibre2">if</code> statements is implemented.
</p>
<p>
Packages are loaded and attached to the search path by calling <code class="calibre2">library</code> or <code class="calibre2">require</code>. Only the exported variables are placed in the attached frame. Loading a package that imports variables from other packages will cause these other packages to be loaded as well (unless they have already been loaded), but they will <em>not</em> be placed on the search path by these implicit loads. Thus code in the package can only depend on objects in its own namespace and its imports (including the <strong>base</strong> namespace) being visible<a href="concept-index.html#FOOT58" id="DOCF58"><sup>58</sup></a>.
</p>
<p>
Namespaces are <em>sealed</em> once they are loaded. Sealing means that imports and exports cannot be changed and that internal variable bindings cannot be changed. Sealing allows a simpler implementation strategy for the namespace mechanism. Sealing also allows code analysis and compilation tools to accurately identify the definition corresponding to a global variable reference in a function body.
</p>
<p>
The namespace controls the search strategy for variables used by functions in the package. If not found locally, R searches the package namespace first, then the imports, then the base namespace and then the normal search path.
</p>
<hr />
<p>
<a href="" id="Specifying-imports-and-exports"></a> <a href="" id="Specifying-imports-and-exports-1"></a>
</p>
<h4 id="specifying-imports-and-exports" class="subsection">
1.5.1 Specifying imports and exports
</h4>
<p>
Exports are specified using the <code class="calibre2">export</code> directive in the NAMESPACE file. A directive of the form
</p>
<p>
<a href="" id="index-export"></a>
</p>
<div class="example">
<pre class="example1"><code>export(f, g)</code></pre>
</div>
<p>
specifies that the variables <code class="calibre2">f</code> and <code class="calibre2">g</code> are to be exported. (Note that variable names may be quoted, and reserved words and non-standard names such as <code class="calibre2">[&lt;-.fractions</code> must be.)
</p>
<p>
For packages with many variables to export it may be more convenient to specify the names to export with a regular expression using <code class="calibre2">exportPattern</code>. The directive
</p>
<p>
<a href="" id="index-exportPattern"></a>
</p>
<div class="example">
<pre class="example1"><code>exportPattern(&quot;^[^&#92;&#92;.]&quot;)</code></pre>
</div>
<p>
exports all variables that do not start with a period. However, such broad patterns are not recommended for production code: it is better to list all exports or use narrowly-defined groups. (This pattern applies to S4 classes.) Beware of patterns which include names starting with a period: some of these are internal-only variables and should never be exported, e.g. ‘.<strong>S3MethodsTable</strong>.’ (and the code nowadays excludes known cases).
</p>
<p>
Packages implicitly import the base namespace. Variables exported from other packages with namespaces need to be imported explicitly using the directives <code class="calibre2">import</code> and <code class="calibre2">importFrom</code>. The <code class="calibre2">import</code> directive imports all exported variables from the specified package(s). Thus the directives
</p>
<p>
<a href="" id="index-import"></a>
</p>
<div class="example">
<pre class="example1"><code>import(foo, bar)</code></pre>
</div>
<p>
specifies that all exported variables in the packages <strong>foo</strong> and <strong>bar</strong> are to be imported. If only some of the exported variables from a package are needed, then they can be imported using <code class="calibre2">importFrom</code>. The directive
</p>
<p>
<a href="" id="index-importFrom"></a>
</p>
<div class="example">
<pre class="example1"><code>importFrom(foo, f, g)</code></pre>
</div>
<p>
specifies that the exported variables <code class="calibre2">f</code> and <code class="calibre2">g</code> of the package <strong>foo</strong> are to be imported. Using <code class="calibre2">importFrom</code> selectively rather than <code class="calibre2">import</code> is good practice and recommended notably when importing from packages with more than a dozen exports.
</p>
<p>
To import every symbol from a package but for a few exceptions, pass the <code class="calibre2">except</code> argument to <code class="calibre2">import</code>. The directive
</p>
<div class="example">
<pre class="example1"><code>import(foo, except=c(bar, baz))</code></pre>
</div>
<p>
imports every symbol from <strong>foo</strong> except <code class="calibre2">bar</code> and <code class="calibre2">baz</code>. The value of <code class="calibre2">except</code> should evaluate to something coercible to a character vector, after substituting each symbol for its corresponding string.
</p>
<p>
It is possible to export variables from a namespace which it has imported from other namespaces: this has to be done explicitly and not <em>via</em> <code class="calibre2">exportPattern</code>.
</p>
<p>
If a package only needs a few objects from another package it can use a fully qualified variable reference in the code instead of a formal import. A fully qualified reference to the function <code class="calibre2">f</code> in package <strong>foo</strong> is of the form <code class="calibre2">foo::f</code>. This is slightly less efficient than a formal import and also loses the advantage of recording all dependencies in the NAMESPACE file (but they still need to be recorded in the DESCRIPTION file). Evaluating <code class="calibre2">foo::f</code> will cause package <strong>foo</strong> to be loaded, but not attached, if it was not loaded already—this can be an advantage in delaying the loading of a rarely used package.
</p>
<p>
Using <code class="calibre2">foo:::f</code> instead of <code class="calibre2">foo::f</code> allows access to unexported objects. This is generally not recommended, as the semantics of unexported objects may be changed by the package author in routine maintenance.
</p>
<hr />
<p>
<a href="" id="Registering-S3-methods"></a> <a href="" id="Registering-S3-methods-1"></a>
</p>
<h4 id="registering-s3-methods" class="subsection">
1.5.2 Registering S3 methods
</h4>
<p>
The standard method for S3-style <code class="calibre2">UseMethod</code> dispatching might fail to locate methods defined in a package that is imported but not attached to the search path. To ensure that these methods are available the packages defining the methods should ensure that the generics are imported and register the methods using <code class="calibre2">S3method</code> directives. If a package defines a function <code class="calibre2">print.foo</code> intended to be used as a <code class="calibre2">print</code> method for class <code class="calibre2">foo</code>, then the directive
</p>
<p>
<a href="" id="index-S3method"></a>
</p>
<div class="example">
<pre class="example1"><code>S3method(print, foo)</code></pre>
</div>
<p>
ensures that the method is registered and available for <code class="calibre2">UseMethod</code> dispatch, and the function <code class="calibre2">print.foo</code> does not need to be exported. Since the generic <code class="calibre2">print</code> is defined in <strong>base</strong> it does not need to be imported explicitly.
</p>
<p>
(Note that function and class names may be quoted, and reserved words and non-standard names such as <code class="calibre2">[&lt;-</code> and <code class="calibre2">function</code> must be.)
</p>
<p>
It is possible to specify a third argument to S3method, the function to be used as the method, for example
</p>
<div class="example">
<pre class="example1"><code>S3method(print, check_so_symbols, .print.via.format)</code></pre>
</div>
<p>
when <code class="calibre2">print.check_so_symbols</code> is not needed.
</p>
<hr />
<p>
<a href="" id="Load-hooks"></a> <a href="" id="Load-hooks-1"></a>
</p>
<h4 id="load-hooks" class="subsection">
1.5.3 Load hooks
</h4>
<p>
<a href="" id="index-_002eonLoad"></a> <a href="" id="index-_002eonAttach"></a>
</p>
<p>
There are a number of hooks called as packages are loaded, attached, detached, and unloaded. See <code class="calibre2">help(“.onLoad”)</code> for more details.
</p>
<p>
Since loading and attaching are distinct operations, separate hooks are provided for each. These hook functions are called <code class="calibre2">.onLoad</code> and <code class="calibre2">.onAttach</code>. They both take arguments<a href="concept-index.html#FOOT59" id="DOCF59"><sup>59</sup></a> <code class="calibre2">libname</code> and <code class="calibre2">pkgname</code>; they should be defined in the namespace but not exported.
</p>
<p>
<a href="" id="index-_002eonUnload"></a> <a href="" id="index-_002eonDetach"></a> <a href="" id="index-_002eLast_002elib"></a>
</p>
<p>
Packages can use a <code class="calibre2">.onDetach</code> or <code class="calibre2">.Last.lib</code> function (provided the latter is exported from the namespace) when <code class="calibre2">detach</code> is called on the package. It is called with a single argument, the full path to the installed package. There is also a hook <code class="calibre2">.onUnload</code> which is called when the namespace is unloaded (<em>via</em> a call to <code class="calibre2">unloadNamespace</code>, perhaps called by <code class="calibre2">detach(unload = TRUE)</code>) with argument the full path to the installed package’s directory. <code class="calibre2">.onUnload</code> and <code class="calibre2">.onDetach</code> should be defined in the namespace and not exported, but <code class="calibre2">.Last.lib</code> does need to be exported.
</p>
<p>
Packages are not likely to need <code class="calibre2">.onAttach</code> (except perhaps for a start-up banner); code to set options and load shared objects should be placed in a <code class="calibre2">.onLoad</code> function, or use made of the <code class="calibre2">useDynLib</code> directive described next.
</p>
<p>
User-level hooks are also available: see the help on function <code class="calibre2">setHook</code>.
</p>
<p>
These hooks are often used incorrectly. People forget to export <code class="calibre2">.Last.lib</code>. Compiled code should be loaded in <code class="calibre2">.onLoad</code> (or <em>via</em> a <code class="calibre2">useDynLb</code> directive: see below) and unloaded in <code class="calibre2">.onUnload</code>. Do remember that a package’s namespace can be loaded without the namespace being attached (e.g. by <code class="calibre2">pkgname::fun</code>) and that a package can be detached and re-attached whilst its namespace remains loaded.
</p>
<hr />
<p>
<a href="" id="useDynLib"></a> <a href="" id="useDynLib-1"></a>
</p>
<h4 id="usedynlib" class="subsection">
1.5.4 useDynLib
</h4>
<p>
A NAMESPACE file can contain one or more <code class="calibre2">useDynLib</code> directives which allows shared objects that need to be loaded.<a href="concept-index.html#FOOT60" id="DOCF60"><sup>60</sup></a> The directive
</p>
<p>
<a href="" id="index-useDynLib"></a>
</p>
<div class="example">
<pre class="example1"><code>useDynLib(foo)</code></pre>
</div>
<p>
registers the shared object <code class="calibre2">foo</code><a href="concept-index.html#FOOT61" id="DOCF61"><sup>61</sup></a> for loading with <code class="calibre2">library.dynam</code>. Loading of registered object(s) occurs after the package code has been loaded and before running the load hook function. Packages that would only need a load hook function to load a shared object can use the <code class="calibre2">useDynLib</code> directive instead.
</p>
<p>
The <code class="calibre2">useDynLib</code> directive also accepts the names of the native routines that are to be used in R <em>via</em> the <code class="calibre2">.C</code>, <code class="calibre2">.Call</code>, <code class="calibre2">.Fortran</code> and <code class="calibre2">.External</code> interface functions. These are given as additional arguments to the directive, for example,
</p>
<div class="example">
<pre class="example1"><code>useDynLib(foo, myRoutine, myOtherRoutine)</code></pre>
</div>
<p>
By specifying these names in the <code class="calibre2">useDynLib</code> directive, the native symbols are resolved when the package is loaded and R variables identifying these symbols are added to the package’s namespace with these names. These can be used in the <code class="calibre2">.C</code>, <code class="calibre2">.Call</code>, <code class="calibre2">.Fortran</code> and <code class="calibre2">.External</code> calls in place of the name of the routine and the <code class="calibre2">PACKAGE</code> argument. For instance, we can call the routine <code class="calibre2">myRoutine</code> from R with the code
</p>
<div class="example">
<pre class="example1"><code> .Call(myRoutine, x, y)</code></pre>
</div>
<p>
rather than
</p>
<div class="example">
<pre class="example1"><code> .Call(&quot;myRoutine&quot;, x, y, PACKAGE = &quot;foo&quot;)</code></pre>
</div>
<p>
There are at least two benefits to this approach. Firstly, the symbol lookup is done just once for each symbol rather than each time the routine is invoked. Secondly, this removes any ambiguity in resolving symbols that might be present in several compiled DLLs. However, this approach is nowadays deprecated in favour of supplying registration information (see below).
</p>
<p>
In some circumstances, there will already be an R variable in the package with the same name as a native symbol. For example, we may have an R function in the package named <code class="calibre2">myRoutine</code>. In this case, it is necessary to map the native symbol to a different R variable name. This can be done in the <code class="calibre2">useDynLib</code> directive by using named arguments. For instance, to map the native symbol name <code class="calibre2">myRoutine</code> to the R variable <code class="calibre2">myRoutine_sym</code>, we would use
</p>
<div class="example">
<pre class="example1"><code>useDynLib(foo, myRoutine_sym = myRoutine, myOtherRoutine)</code></pre>
</div>
<p>
We could then call that routine from R using the command
</p>
<div class="example">
<pre class="example1"><code> .Call(myRoutine_sym, x, y)</code></pre>
</div>
<p>
Symbols without explicit names are assigned to the R variable with that name.
</p>
<p>
In some cases, it may be preferable not to create R variables in the package’s namespace that identify the native routines. It may be too costly to compute these for many routines when the package is loaded if many of these routines are not likely to be used. In this case, one can still perform the symbol resolution correctly using the DLL, but do this each time the routine is called. Given a reference to the DLL as an R variable, say <code class="calibre2">dll</code>, we can call the routine <code class="calibre2">myRoutine</code> using the expression
</p>
<div class="example">
<pre class="example1"><code> .Call(dll&#36;myRoutine, x, y)</code></pre>
</div>
<p>
The <code class="calibre2">$</code> operator resolves the routine with the given name in the DLL using a call to <code class="calibre2">getNativeSymbol</code>. This is the same computation as above where we resolve the symbol when the package is loaded. The only difference is that this is done each time in the case of <code class="calibre2">dll$myRoutine</code>.
</p>
<p>
In order to use this dynamic approach (e.g., <code class="calibre2">dll$myRoutine</code>), one needs the reference to the DLL as an R variable in the package. The DLL can be assigned to a variable by using the <code class="calibre2">variable = dllName</code> format used above for mapping symbols to R variables. For example, if we wanted to assign the DLL reference for the DLL <code class="calibre2">foo</code> in the example above to the variable <code class="calibre2">myDLL</code>, we would use the following directive in the NAMESPACE file:
</p>
<div class="example">
<pre class="example1"><code>myDLL = useDynLib(foo, myRoutine_sym = myRoutine, myOtherRoutine)</code></pre>
</div>
<p>
Then, the R variable <code class="calibre2">myDLL</code> is in the package’s namespace and available for calls such as <code class="calibre2">myDLL$dynRoutine</code> to access routines that are not explicitly resolved at load time.
</p>
<p>
If the package has registration information (see <a href="system-and-foreign-language-interfaces.html#Registering-native-routines">Registering native routines</a>), then we can use that directly rather than specifying the list of symbols again in the <code class="calibre2">useDynLib</code> directive in the NAMESPACE file. Each routine in the registration information is specified by giving a name by which the routine is to be specified along with the address of the routine and any information about the number and type of the parameters. Using the <code class="calibre2">.registration</code> argument of <code class="calibre2">useDynLib</code>, we can instruct the namespace mechanism to create R variables for these symbols. For example, suppose we have the following registration information for a DLL named <code class="calibre2">myDLL</code>:
</p>
<div class="example">
<pre class="example1"><code>static R_NativePrimitiveArgType foo_t[] = {
    REALSXP, INTSXP, STRSXP, LGLSXP
};

static const R_CMethodDef cMethods[] = {
   {&quot;foo&quot;, (DL_FUNC) &amp;foo, 4, foo_t},
   {&quot;bar_sym&quot;, (DL_FUNC) &amp;bar, 0},
   {NULL, NULL, 0, NULL}
};

static const R_CallMethodDef callMethods[] = {
   {&quot;R_call_sym&quot;, (DL_FUNC) &amp;R_call, 4},
   {&quot;R_version_sym&quot;, (DL_FUNC) &amp;R_version, 0},
   {NULL, NULL, 0}
};</code></pre>
</div>
<p>
Then, the directive in the NAMESPACE file
</p>
<div class="example">
<pre class="example1"><code>useDynLib(myDLL, .registration = TRUE)</code></pre>
</div>
<p>
causes the DLL to be loaded and also for the R variables <code class="calibre2">foo</code>, <code class="calibre2">bar_sym</code>, <code class="calibre2">R_call_sym</code> and <code class="calibre2">R_version_sym</code> to be defined in the package’s namespace.
</p>
<p>
Note that the names for the R variables are taken from the entry in the registration information and do not need to be the same as the name of the native routine. This allows the creator of the registration information to map the native symbols to non-conflicting variable names in R, e.g. <code class="calibre2">R_version</code> to <code class="calibre2">R_version_sym</code> for use in an R function such as
</p>
<div class="example">
<pre class="example1"><code>R_version &lt;- function()
{
  .Call(R_version_sym)
}</code></pre>
</div>
<p>
Using argument <code class="calibre2">.fixes</code> allows an automatic prefix to be added to the registered symbols, which can be useful when working with an existing package. For example, package <a href="https://CRAN.R-project.org/package=KernSmooth"><strong>KernSmooth</strong></a> has
</p>
<div class="example">
<pre class="example1"><code>useDynLib(KernSmooth, .registration = TRUE, .fixes = &quot;F_&quot;)</code></pre>
</div>
<p>
which makes the R variables corresponding to the FORTRAN symbols <code class="calibre2">F_bkde</code> and so on, and so avoid clashes with R code in the namespace.
</p>
<p>
<strong>NB</strong>: Using these arguments for a package which does not register native symbols merely slows down the package loading (although at the time of writing 90 CRAN packages did so). Once symbols are registered, check that the corresponding R variables are not accidentally exported by a pattern in the NAMESPACE file.
</p>
<hr />
<p>
<a href="" id="An-example"></a> <a href="" id="An-example-1"></a>
</p>
<h4 id="an-example" class="subsection">
1.5.5 An example
</h4>
<p>
As an example consider two packages named <strong>foo</strong> and <strong>bar</strong>. The R code for package <strong>foo</strong> in file foo.R is
</p>
<blockquote>
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left">
<div class="example">
<pre class="example1"><code>x &lt;- 1
f &lt;- function(y) c(x,y)
foo &lt;- function(x) .Call(&quot;foo&quot;, x, PACKAGE=&quot;foo&quot;)
print.foo &lt;- function(x, ...) cat(&quot;&lt;a foo&gt;&#92;n&quot;)</code></pre>
</div>
</td>
</tr>
</tbody>
</table>
</blockquote>
<p>
Some C code defines a C function compiled into DLL <code class="calibre2">foo</code> (with an appropriate extension). The NAMESPACE file for this package is
</p>
<blockquote>
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left">
<div class="example">
<pre class="example1"><code>useDynLib(foo)
export(f, foo)
S3method(print, foo)</code></pre>
</div>
</td>
</tr>
</tbody>
</table>
</blockquote>
<p>
The second package <strong>bar</strong> has code file bar.R
</p>
<blockquote>
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left">
<div class="example">
<pre class="example1"><code>c &lt;- function(...) sum(...)
g &lt;- function(y) f(c(y, 7))
h &lt;- function(y) y+9</code></pre>
</div>
</td>
</tr>
</tbody>
</table>
</blockquote>
<p>
and NAMESPACE file
</p>
<blockquote>
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left">
<div class="example">
<pre class="example1"><code>import(foo)
export(g, h)</code></pre>
</div>
</td>
</tr>
</tbody>
</table>
</blockquote>
<p>
Calling <code class="calibre2">library(bar)</code> loads <strong>bar</strong> and attaches its exports to the search path. Package <strong>foo</strong> is also loaded but not attached to the search path. A call to <code class="calibre2">g</code> produces
</p>
<div class="example">
<pre class="example1"><code>&gt; g(6)
[1]  1 13</code></pre>
</div>
<p>
This is consistent with the definitions of <code class="calibre2">c</code> in the two settings: in <strong>bar</strong> the function <code class="calibre2">c</code> is defined to be equivalent to <code class="calibre2">sum</code>, but in <strong>foo</strong> the variable <code class="calibre2">c</code> refers to the standard function <code class="calibre2">c</code> in <strong>base</strong>.
</p>
<hr />
<p>
<a href="" id="Namespaces-with-S4-classes-and-methods"></a> <a href="" id="Namespaces-with-S4-classes-and-methods-1"></a>
</p>
<h4 id="namespaces-with-s4-classes-and-methods" class="subsection">
1.5.6 Namespaces with S4 classes and methods
</h4>
<p>
Some additional steps are needed for packages which make use of formal (S4-style) classes and methods (unless these are purely used internally). The package should have <code class="calibre2">Depends: methods</code> in its DESCRIPTION file<a href="concept-index.html#FOOT62" id="DOCF62"><sup>62</sup></a> and <code class="calibre2">import(methods)</code> or <code class="calibre2">importFrom(methods, …)</code> plus any classes and methods which are to be exported need to be declared in the NAMESPACE file. For example, the <strong>stats4</strong> package has
</p>
<p>
<a href="" id="index-exportClasses"></a> <a href="" id="index-exportMethods"></a>
</p>
<div class="example">
<pre class="example1"><code>export(mle) # exporting methods implicitly exports the generic
importFrom(&quot;graphics&quot;, plot)
importFrom(&quot;stats&quot;, optim, qchisq)
## For these, we define methods or (AIC, BIC, nobs) an implicit generic:
importFrom(&quot;stats&quot;, AIC, BIC, coef, confint, logLik, nobs, profile,
           update, vcov)
exportClasses(mle, profile.mle, summary.mle)
## All methods for imported generics:
exportMethods(coef, confint, logLik, plot, profile, summary,
              show, update, vcov)
## implicit generics which do not have any methods here
export(AIC, BIC, nobs)</code></pre>
</div>
<p>
<a href="" id="index-exportPattern-1"></a> <a href="" id="index-exportClassPattern"></a>
</p>
<p>
All S4 classes to be used outside the package need to be listed in an <code class="calibre2">exportClasses</code> directive. Alternatively, they can be specified using <code class="calibre2">exportClassPattern</code><a href="concept-index.html#FOOT63" id="DOCF63"><sup>63</sup></a> in the same style as for <code class="calibre2">exportPattern</code>. To export methods for generics from other packages an <code class="calibre2">exportMethods</code> directive can be used.
</p>
<p>
Note that exporting methods on a generic in the namespace will also export the generic, and exporting a generic in the namespace will also export its methods. If the generic function is not local to this package, either because it was imported as a generic function or because the non-generic version has been made generic solely to add S4 methods to it (as for functions such as <code class="calibre2">plot</code> in the example above), it can be declared <em>via</em> either or both of <code class="calibre2">export</code> or <code class="calibre2">exportMethods</code>, but the latter is clearer (and is used in the <strong>stats4</strong> example above). In particular, for primitive functions there is no generic function, so <code class="calibre2">export</code> would export the primitive, which makes no sense. On the other hand, if the generic is local to this package, it is more natural to export the function itself using <code class="calibre2">export()</code>, and this <em>must</em> be done if an implicit generic is created without setting any methods for it (as is the case for <code class="calibre2">AIC</code> in <strong>stats4</strong>).
</p>
<p>
A non-local generic function is only exported to ensure that calls to the function will dispatch the methods from this package (and that is not done or required when the methods are for primitive functions). For this reason, you do not need to document such implicitly created generic functions, and <code class="calibre2">undoc</code> in package <strong>tools</strong> will not report them.
</p>
<p>
If a package uses S4 classes and methods exported from another package, but does not import the entire namespace of the other package<a href="concept-index.html#FOOT64" id="DOCF64"><sup>64</sup></a>, it needs to import the classes and methods explicitly, with directives
</p>
<p>
<a href="" id="index-importClassesFrom"></a> <a href="" id="index-importMethodsFrom"></a>
</p>
<div class="example">
<pre class="example1"><code>importClassesFrom(package, ...)
importMethodsFrom(package, ...)</code></pre>
</div>
<p>
listing the classes and functions with methods respectively. Suppose we had two small packages <strong>A</strong> and <strong>B</strong> with <strong>B</strong> using <strong>A</strong>. Then they could have <code class="calibre2">NAMESPACE</code> files
</p>
<blockquote>
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left">
<div class="example">
<pre class="example1"><code>export(f1, ng1)
exportMethods(&quot;[&quot;)
exportClasses(c1)</code></pre>
</div>
</td>
</tr>
</tbody>
</table>
</blockquote>
<p>
and
</p>
<blockquote>
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left">
<div class="example">
<pre class="example1"><code>importFrom(A, ng1)
importClassesFrom(A, c1)
importMethodsFrom(A, f1)
export(f4, f5)
exportMethods(f6, &quot;[&quot;)
exportClasses(c1, c2)</code></pre>
</div>
</td>
</tr>
</tbody>
</table>
</blockquote>
<p>
respectively.
</p>
<p>
Note that <code class="calibre2">importMethodsFrom</code> will also import any generics defined in the namespace on those methods.
</p>
<p>
It is important if you export S4 methods that the corresponding generics are available. You may for example need to import <code class="calibre2">plot</code> from <strong>graphics</strong> to make visible a function to be converted into its implicit generic. But it is better practice to make use of the generics exported by <strong>stats4</strong> as this enables multiple packages to unambiguously set methods on those generics.
</p>
<hr />
<p>
<a href="" id="Writing-portable-packages"></a> <a href="" id="Writing-portable-packages-1"></a>
</p>
<h3 id="writing-portable-packages" class="section">
1.6 Writing portable packages
</h3>
<p>
This section contains advice on writing packages to be used on multiple platforms or for distribution (for example to be submitted to a package repository such as CRAN).
</p>
<p>
Portable packages should have simple file names: use only alphanumeric ASCII characters and period (<code class="calibre2">.</code>), and avoid those names not allowed under Windows which are mentioned above.
</p>
<p>
Many of the graphics devices are platform-specific: even <code class="calibre2">X11()</code> (aka <code class="calibre2">x11()</code>) which although emulated on Windows may not be available on a Unix-alike (and is not the preferred screen device on OS X). It is rarely necessary for package code or examples to open a new device, but if essential,<a href="concept-index.html#FOOT65" id="DOCF65"><sup>65</sup></a> use <code class="calibre2">dev.new()</code>.
</p>
<p>
Use <code class="calibre2">R CMD build</code> to make the release .tar.gz file.
</p>
<p>
<code class="calibre2">R CMD check</code> provides a basic set of checks, but often further problems emerge when people try to install and use packages submitted to CRAN – many of these involve compiled code. Here are some further checks that you can do to make your package more portable.
</p>
<ul>
<li>
If your package has a configure script, provide a configure.win script to be used on Windows (an empty file if no actions are needed).
</li>
<li>
<p>
If your package has a Makevars or Makefile file, make sure that you use only portable make features. Such files should be LF-terminated<a href="concept-index.html#FOOT66" id="DOCF66"><sup>66</sup></a> (including the final line of the file) and not make use of GNU extensions. (The POSIX specification is available at <a href="http://pubs.opengroup.org/onlinepubs/9699919799/utilities/make.html" class="uri">http://pubs.opengroup.org/onlinepubs/9699919799/utilities/make.html</a>; anything not documented there should be regarded as an extension to be avoided.) Commonly misused GNU extensions are conditional inclusions (<code class="calibre2">ifeq</code> and the like), <code class="calibre2">${shell …}</code>, <code class="calibre2">${wildcard …}</code> and similar, and the use of <code class="calibre2">+=</code><a href="concept-index.html#FOOT67" id="DOCF67"><sup>67</sup></a> and <code class="calibre2">:=</code>. Also, the use of <code class="calibre2">$&lt;</code> other than in implicit rules is a GNU extension, as is the <code class="calibre2">$^</code> macro. Unfortunately makefiles which use GNU extensions often run on other platforms but do not have the intended results.
</p>
<p>
The use of <code class="calibre2">${shell …}</code> can be avoided by using backticks, e.g.
</p>
<div class="example">
<pre class="example1"><code>PKG_CPPFLAGS = `gsl-config --cflags`</code></pre>
</div>
<p>
which works in all versions of <code class="calibre2">make</code> known<a href="concept-index.html#FOOT68" id="DOCF68"><sup>68</sup></a> to be used with R.
</p>
<p>
If you really must require GNU make, declare it in the DESCRIPTION file by
</p>
<div class="example">
<pre class="example1"><code>SystemRequirements: GNU make</code></pre>
</div>
<p>
and ensure that you use the value of environment variable <code class="calibre2">MAKE</code> (and not just <code class="calibre2">make</code>) in your scripts. (On some platforms GNU make is available under a name such as <code class="calibre2">gmake</code>, and there <code class="calibre2">SystemRequirements</code> is used to set <code class="calibre2">MAKE</code>.)
</p>
<p>
If you only need GNU make for parts of the package which are rarely needed (for example to create bibliography files under vignettes), use a file called GNUmakefile rather than Makefile as GNU make (only) will use the former.
</p>
<p>
Since the only viable make for Windows is GNU make, it is permissible to use GNU extensions in files Makevars.win or Makefile.win.
</p>
</li>
<li>
<p>
Bash extensions also need to be avoided in shell scripts, including expressions in Makefiles (which are passed to the shell for processing). Some R platforms use strict<a href="concept-index.html#FOOT69" id="DOCF69"><sup>69</sup></a> Bourne shells: the R toolset on Windows and some Unix-alike OSes use <code class="calibre2">ash</code> (<a href="https://en.wikipedia.org/wiki/Almquist_shell" class="uri">https://en.wikipedia.org/wiki/Almquist_shell</a>), a rather minimal shell with few builtins. Beware of assuming that all the POSIX command-line utilities are available, especially on Windows where only a minimal set is provided for use with R. One particular issue is the use of <code class="calibre2">echo</code>, for which two behaviours are allowed (<a href="http://pubs.opengroup.org/onlinepubs/9699919799/utilities/echo.html" class="uri">http://pubs.opengroup.org/onlinepubs/9699919799/utilities/echo.html</a>) and both occur as defaults on R platforms: portable applications should not use -n (as the first argument) nor escape sequences. Another common issue is the construction
</p>
<div class="example">
<pre class="example1"><code>export FOO=value</code></pre>
</div>
<p>
which is bash-specific (first set the variable then export it by name).
</p>
</li>
<li>
<p>
Make use of the abilities of your compilers to check the standards-conformance of your code. For example, <code class="calibre2">gcc</code> and <code class="calibre2">gfortran</code><a href="concept-index.html#FOOT70" id="DOCF70"><sup>70</sup></a> can be used with options -Wall -pedantic to alert you to potential problems. This is particularly important for C++, where <code class="calibre2">g++ -Wall -pedantic</code> will alert you to the use of some of the GNU extensions which fail to compile on most other C++ compilers. If R was not configured accordingly, one can achieve this <em>via</em> personal Makevars files.
</p>
<p>
Portable C++ code needs to follow the 1998 standard (and not use features from C99), or to specify a C++11 compiler (see <a href="creating-r-packages.html#Using-C_002b_002b11-code">Using C++11 code</a>) where available (which is not the case on all R platforms).
</p>
<p>
If you use FORTRAN 77, <code class="calibre2">ftnchek</code> (<a href="http://www.dsm.fordham.edu/~ftnchek/" class="uri">http://www.dsm.fordham.edu/~ftnchek/</a>) provides thorough testing of conformance to the standard.
</p>
<p>
If using Fortran 9x with the GNU compiler, use the flags -std=f95 -Wall -pedantic which reject most GNU extensions and features from later standards.
</p>
<p>
R has tested that <code class="calibre2">DOUBLE COMPLEX</code> works (although an extension to the Fortran standards) and so is preferred to <code class="calibre2">COMPLEX*16</code>. (Fortran 9x code can use something like <code class="calibre2">COMPLEX(KIND=KIND(0.0D0))</code><a href="concept-index.html#FOOT71" id="DOCF71"><sup>71</sup></a>.)
</p>
<p>
Not all common R platforms conform to the expected standards, e.g. C99 for C code. One common area of problems is the <code class="calibre2">*printf</code> functions where Windows does not support <code class="calibre2">%lld</code>, <code class="calibre2">%Lf</code> and similar formats (and has its own formats such as <code class="calibre2">%I64d</code> for 64-bit integers). It is very rare to need to output such types, and 64-bit integers can usually be converted to doubles for output.
</p>
</li>
<li>
<p>
<code class="calibre2">R CMD check</code> performs some checks for non-portable compiler/linker flags in src/Makevars. However, it cannot check the meaning of such flags, and some are commonly accepted but with compiler-specific meanings. There are other non-portable flags which are not checked, nor are src/Makefile files and makefiles in sub-directories. As a comment in the code says
</p>
<blockquote>
<p>
It is hard to think of anything apart from -I* and -D* that is safe for general use …
</p>
</blockquote>
<p>
although -pthread is pretty close to portable. (Option -U is portable but little use on the command line as it will only cancel built-in defines (not portable) and those defined earlier on the command line (R does not use any).)
</p>
</li>
<li>
<p>
Do be very careful with passing arguments between R, C and FORTRAN code. In particular, <code class="calibre2">long</code> in C will be 32-bit on some R platforms (including 64-bit Windows), but 64-bit on most modern Unix and Linux platforms. It is rather unlikely that the use of <code class="calibre2">long</code> in C code has been thought through: if you need a longer type than <code class="calibre2">int</code> you should use a configure test for a C99/C++11 type such as <code class="calibre2">int_fast64_t</code> (and failing that, <code class="calibre2">long long</code> <a href="concept-index.html#FOOT72" id="DOCF72"><sup>72</sup></a>) and typedef your own type to be <code class="calibre2">long</code> or <code class="calibre2">long long</code>, or use another suitable type (such as <code class="calibre2">size_t</code>).
</p>
<p>
It is not safe to assume that <code class="calibre2">long</code> and pointer types are the same size, and they are not on 64-bit Windows. If you need to convert pointers to and from integers use the C99/C++11 integer types <code class="calibre2">intptr_t</code> and <code class="calibre2">uintptr_t</code> (which are defined in the header <code class="calibre2">&lt;stdint.h&gt;</code> and are not required to be implemented by the C99 standard but are used in C code by R itself).
</p>
<p>
Note that <code class="calibre2">integer</code> in FORTRAN corresponds to <code class="calibre2">int</code> in C on all R platforms.
</p>
</li>
<li>
<p>
Under no circumstances should your compiled code ever call <code class="calibre2">abort</code> or <code class="calibre2">exit</code><a href="concept-index.html#FOOT73" id="DOCF73"><sup>73</sup></a>: these terminate the user’s R process, quite possibly including all his unsaved work. One usage that could call <code class="calibre2">abort</code> is the <code class="calibre2">assert</code> macro in C or C++ functions, which should never be active in production code. The normal way to ensure that is to define the macro <code class="calibre2">NDEBUG</code>, and <code class="calibre2">R CMD INSTALL</code> does so as part of the compilation flags. If you wish to use <code class="calibre2">assert</code> during development. you can include <code class="calibre2">-UNDEBUG</code> in <code class="calibre2">PKG_CPPFLAGS</code>. Note that your own src/Makefile or makefiles in sub-directories may also need to define <code class="calibre2">NDEBUG</code>.
</p>
<p>
This applies not only to your own code but to any external software you compile in or link to.
</p>
</li>
<li>
Compiled code should not write to stdout or stderr and C++ and Fortran I/O should not be used. As with the previous item such calls may come from external software and may never be called, but package authors are often mistaken about that.
</li>
<li>
<p>
Compiled code should not call the system random number generators such as <code class="calibre2">rand</code>, <code class="calibre2">drand48</code> and <code class="calibre2">random</code><a href="concept-index.html#FOOT74" id="DOCF74"><sup>74</sup></a>, but rather use the interfaces to R’s RNGs described in <a href="the-r-api:-entry-points-for-c-code.html#Random-numbers">Random numbers</a>. In particular, if more than one package initializes the system RNG (e.g. <em>via</em> <code class="calibre2">srand</code>), they will interfere with each other.
</p>
<p>
Nor should the C++11 random number library be used.
</p>
</li>
<li>
Errors in memory allocation and reading/writing outside arrays are very common causes of crashes (e.g., segfaults) on some machines. See <a href="debugging.html#Checking-memory-access">Checking memory access</a> for tools which can be used to look for this.
</li>
<li>
<p>
Many platforms will allow unsatisfied entry points in compiled code, but will crash the application (here R) if they are ever used. Some (notably Windows) will not. Looking at the output of
</p>
<div class="example">
<pre class="example1"><code>nm -pg mypkg.so</code></pre>
</div>
<p>
and checking if any of the symbols marked <code class="calibre2">U</code> is unexpected is a good way to avoid this.
</p>
</li>
<li>
Linkers have a lot of freedom in how to resolve entry points in dynamically-loaded code, so the results may differ by platform. One area that has caused grief is packages including copies of standard system software such as <code class="calibre2">libz</code> (especially those already linked into R). In the case in point, entry point <code class="calibre2">gzgets</code> was sometimes resolved against the old version compiled into the package, sometimes against the copy compiled into R and sometimes against the system dynamic library. The only safe solution is to rename the entry points in the copy in the package. We have even seen problems with entry point name <code class="calibre2">myprintf</code>, which is a system entry point<a href="concept-index.html#FOOT75" id="DOCF75"><sup>75</sup></a> on some Linux systems.
</li>
<li>
Conflicts between symbols in DLLs are handled in very platform-specific ways. Good ways to avoid trouble are to make as many symbols as possible static (check with <code class="calibre2">nm -pg</code>), and to use names which are clearly tied to your package (which also helps users if anything does go wrong). Note that symbol names starting with <code class="calibre2">R_</code> are regarded as part of R’s namespace and should not be used in packages.
</li>
<li>
It is good practice for DLLs to register their symbols (see <a href="system-and-foreign-language-interfaces.html#Registering-native-routines">Registering native routines</a>), restrict visibility (see <a href="the-r-api:-entry-points-for-c-code.html#Controlling-visibility">Controlling visibility</a>) and not allow symbol search (see <a href="system-and-foreign-language-interfaces.html#Registering-native-routines">Registering native routines</a>). It should be possible for a DLL to have only one visible symbol, <code class="calibre2">R_init_pkgname</code>, on suitable platforms<a href="concept-index.html#FOOT76" id="DOCF76"><sup>76</sup></a>, which would completely avoid symbol conflicts.
</li>
<li>
It is not portable to call compiled code in R or other packages <em>via</em> <code class="calibre2">.Internal</code>, <code class="calibre2">.C</code>, <code class="calibre2">.Fortran</code>, <code class="calibre2">.Call</code> or <code class="calibre2">.External</code>, since such interfaces are subject to change without notice and will probably result in your code terminating the R process.
</li>
<li>
Do not use (hard or symbolic) file links in your package sources. Where possible <code class="calibre2">R CMD build</code> will replace them by copies.
</li>
<li>
If you do not yourself have a Windows system, consider submitting your source package to WinBuilder (<a href="https://win-builder.r-project.org/" class="uri">https://win-builder.r-project.org/</a>) before distribution.
</li>
<li>
It is bad practice for package code to alter the search path using <code class="calibre2">library</code>, <code class="calibre2">require</code> or <code class="calibre2">attach</code> and this often does not work as intended. For alternatives, see <a href="creating-r-packages.html#Suggested-packages">Suggested packages</a> and <code class="calibre2">with</code>.
</li>
<li>
Examples can be run interactively <em>via</em> <code class="calibre2">example</code> as well as in batch mode when checking. So they should behave appropriately in both scenarios, conditioning by <code class="calibre2">interactive()</code> the parts which need an operator or observer. For instance, progress bars<a href="concept-index.html#FOOT77" id="DOCF77"><sup>77</sup></a> are only appropriate in interactive use, as is displaying help pages or calling <code class="calibre2">View()</code> (see below).
</li>
<li>
Be careful with the order of entries in macros such as <code class="calibre2">PKG_LIBS</code>. Some linkers will re-order the entries, and behaviour can differ between dynamic and static libraries. Generally -L options should precede<a href="concept-index.html#FOOT78" id="DOCF78"><sup>78</sup></a> the libraries (typically specified by -l options) to be found from those directories, and libraries are searched once in the order they are specified. Not all linkers allow a space after -L .
</li>
<li>
<p>
Care is needed with the use of <code class="calibre2">LinkingTo</code>. This puts one or more directories on the include search path ahead of system headers but (prior to R 3.4.0) after those specified in the <code class="calibre2">CPPFLAGS</code> macro of the R build (which normally includes <code class="calibre2">-I/usr/local/include</code>, but most platforms ignore that and include it with the system headers).
</p>
<p>
Any confusion would be avoided by having <code class="calibre2">LinkingTo</code> headers in a directory named after the package. In any case, name conflicts of headers and directories under package include directories should be avoided, both between packages and between a package and system and third-party software.
</p>
</li>
<li>
The <code class="calibre2">ar</code> utility is often used in makefiles to make static libraries. Its modifier <code class="calibre2">u</code> is defined by POSIX but is disabled in GNU <code class="calibre2">ar</code> on some recent Linux distributions which use ‘deterministic mode’. The safest way to make a static library is to first remove any existing file of that name then use <code class="calibre2">ar -cr</code> and then <code class="calibre2">ranlib</code> if needed (which is system-dependent: on most systems<a href="concept-index.html#FOOT79" id="DOCF79"><sup>79</sup></a> <code class="calibre2">ar</code> always maintains a symbol table). The POSIX standard says options should be preceded by a hyphen (as in -cr), although most OSes accept them without. Note that on some systems <code class="calibre2">ar -cr</code> must have at least one file specified.
</li>
<li>
Some people have a need to set a locale. Locale names are not portable, and e.g. ‘fr_FR.utf8’ is commonly used on Linux but not accepted on either Solaris or macOS. ‘fr_FR.UTF-8’ is more portable, being accepted on recent Linux, AIX, FreeBSD, macOS and Solaris (at least). However, some Linux distributions micro-package, so locales defined by <strong>glibc</strong> (including these examples) may not be installed.
</li>
<li>
<p>
Avoid spaces in file names, not least as they can cause difficulties for external tools. A recent example was a package with a <a href="https://CRAN.R-project.org/package=knitr"><strong>knitr</strong></a> vignette that used spaces in plot names: this caused some versions of <code class="calibre2">pandoc</code> to fail with a baffling error message.
</p>
<p>
Non-ASCII filenames can also cause problems (particularly in non-UTF-8 locales).
</p>
</li>
<li>
<p>
Make sure that any version requirement for Java code is both declared in the ‘SystemRequirements’ field and tested at runtime (not least as the Java installation when the package is installed might not be the same as when the package is run and will not be for binary packages). Java 8 (aka 1.8) is available for fewer platforms than Java 7. A suitable test for packages using <a href="https://CRAN.R-project.org/package=rJava"><strong>rJava</strong></a> would be
</p>
<div class="example">
<pre class="example1"><code>.jinit()
jv &lt;- .jcall(&quot;java/lang/System&quot;, &quot;S&quot;, &quot;getProperty&quot;, &quot;java.runtime.version&quot;)
jvn &lt;- as.numeric(paste0(strsplit(jv, &quot;[.]&quot;)[[1L]][1:2], collapse = &quot;.&quot;))
if(jvn &lt; 1.8) stop(&quot;Java 8 is needed for this package but not available&quot;)</code></pre>
</div>
<p>
Some packages have stated a requirement on a particular JDK, but a package should only be requiring a JRE unless providing its own Java interface.
</p>
</li>
<li>
<p>
A package with a hard-to-satisfy system requirement is by definition not portable, annoyingly so if this is not declared in the ‘SystemRequirements’ field. The most common example is the use of <code class="calibre2">pandoc</code>, which is only available for a very limited range of platforms (and has onerous requirements to install from source) and has capabilities<a href="concept-index.html#FOOT80" id="DOCF80"><sup>80</sup></a> that vary by build but are not documented.
</p>
<p>
An external command can be an optional requirement for an imported package but needed for examples or tests in the package itself. Such usage should always be conditional on a test for existence (perhaps using <code class="calibre2">Sys.which</code>), as well as declared in the ‘SystemRequirements’ field.
</p>
</li>
<li>
Be sure to use portable encoding names: none of <code class="calibre2">utf8</code>, <code class="calibre2">mac</code> and <code class="calibre2">macroman</code> are. See the help for <code class="calibre2">file</code> for more details.
</li>
<li>
<p>
Do not invoke R by plain <code class="calibre2">R</code>, <code class="calibre2">Rscript</code> or (on Windows) <code class="calibre2">Rterm</code> in your examples, tests, vignettes, makefiles or other scripts. As pointed out in several places earlier in this manual, use something like
</p>
<div class="example">
<pre class="example1"><code>&quot;&#36;(R_HOME)/bin/Rscript&quot;
&quot;&#36;(R_HOME)/bin&#36;(R_ARCH_BIN)/Rterm&quot;</code></pre>
</div>
<p>
with appropriate quotes (as, although not recommended, <code class="calibre2">R_HOME</code> can contain spaces).
</p>
</li>
</ul>
<p>
Do be careful in what your tests (and examples) actually test. Bad practice seen in distributed packages include:
</p>
<ul>
<li>
It is not reasonable to test the time taken by a command: you cannot know how fast or how heavily loaded an R platform might be. At best you can test a ratio of times, and even that is fraught with difficulties.
</li>
<li>
<p>
Do not test the exact format of R messages (from R itself or from other packages): They change, and they can be translated.
</p>
<p>
Packages have even tested the exact format of system error messages, which are platform-dependent and perhaps locale-dependent.
</p>
</li>
<li>
If you use functions such as <code class="calibre2">View</code>, remember that in testing there is no one to look at the output. It is better to use something like one of
<div class="example">
<pre class="example1"><code>if(interactive()) View(obj) else print(head(obj))
if(interactive()) View(obj) else str(obj)</code></pre>
</div>
</li>
<li>
<p>
Only test the accuracy of results if you have done a formal error analysis. Things such as checking that probabilities numerically sum to one are silly: numerical tests should always have a tolerance. That the tests on your platform achieve a particular tolerance says little about other platforms. R is configured by default to make use of long doubles where available, but they may not be available or be too slow for routine use. Most R platforms use ‘ix86’ or ‘x86_64’ CPUs: these use extended precision registers on some but not all of their FPU instructions. Thus the achieved precision can depend on the compiler version and optimization flags—our experience is that 32-bit builds tend to be less precise than 64-bit ones. But not all platforms use those CPUs, and not all<a href="concept-index.html#FOOT81" id="DOCF81"><sup>81</sup></a> which use them configure them to allow the use of extended precision. In particular, ARM CPUs do not (currently) have extended precision nor long doubles, and long double was 64-bit on HP/PA Linux.
</p>
<p>
If you must try to establish a tolerance empirically, configure and build R with –disable-long-double and use appropriate compiler flags (such as -ffloat-store and -fexcess-precision=standard for <code class="calibre2">gcc</code>, depending on the CPU type<a href="concept-index.html#FOOT82" id="DOCF82"><sup>82</sup></a>) to mitigate the effects of extended-precision calculations.
</p>
<p>
Tests which involve random inputs or non-deterministic algorithms should normally set a seed or be tested for many seeds.
</p>
</li>
</ul>
<hr />
<p>
<a href="" id="PDF-size"></a> <a href="" id="PDF-size-1"></a>
</p>
<h4 id="pdf-size" class="subsection">
1.6.1 PDF size
</h4>
<p>
There are a several tools available to reduce the size of PDF files: often the size can be reduced substantially with no or minimal loss in quality. Not only do large files take up space: they can stress the PDF viewer and take many minutes to print (if they can be printed at all).
</p>
<p>
<code class="calibre2">qpdf</code> (<a href="http://qpdf.sourceforge.net/" class="uri">http://qpdf.sourceforge.net/</a>) can compress losslessly. It is fairly readily available (e.g. it has binaries for Windows and packages in Debian/Ubuntu/Fedora, and is installed as part of the CRAN macOS distribution of R). <code class="calibre2">R CMD build</code> has an option to run <code class="calibre2">qpdf</code> over PDF files under inst/doc and replace them if at least 10Kb and 10% is saved. The full path to the <code class="calibre2">qpdf</code> command can be supplied as environment variable <code class="calibre2">R_QPDF</code> (and is on the CRAN binary of R for macOS). It seems MiKTeX does not use PDF object compression and so <code class="calibre2">qpdf</code> can reduce considerably the files it outputs: MiKTeX can be overridden by code in the preamble of an Sweave or LaTeX file — see how this is done for the R reference manual at <a href="https://svn.r-project.org/R/trunk/doc/manual/refman.top" class="uri">https://svn.r-project.org/R/trunk/doc/manual/refman.top</a>.
</p>
<p>
Other tools can reduce the size of PDFs containing bitmap images at excessively high resolution. These are often best re-generated (for example <code class="calibre2">Sweave</code> defaults to 300 ppi, and 100–150 is more appropriate for a package manual). These tools include Adobe Acrobat (not Reader), Apple’s Preview<a href="concept-index.html#FOOT83" id="DOCF83"><sup>83</sup></a> and Ghostscript (which converts PDF to PDF by
</p>
<div class="example">
<pre class="example1"><code>ps2pdf options -dAutoRotatePages=/None in.pdf out.pdf</code></pre>
</div>
<p>
and suitable options might be
</p>
<div class="example">
<pre class="example1"><code>-dPDFSETTINGS=/ebook
-dPDFSETTINGS=/screen</code></pre>
</div>
<p>
; see <a href="http://www.ghostscript.com/doc/current/Ps2pdf.htm" class="uri">http://www.ghostscript.com/doc/current/Ps2pdf.htm</a> for more such and consider all the options for image downsampling). There have been examples in CRAN packages for which Ghostscript 9.06 and later produced much better reductions than 9.05 or earlier.
</p>
<p>
We come across occasionally large PDF files containing excessively complicated figures using PDF vector graphics: such figures are often best redesigned or failing that, output as PNG files.
</p>
<p>
Option –compact-vignettes to <code class="calibre2">R CMD build</code> defaults to value ‘qpdf’: use ‘both’ to try harder to reduce the size, provided you have Ghostscript available (see the help for <code class="calibre2">tools::compactPDF</code>).
</p>
<hr />
<p>
<a href="" id="Check-timing"></a> <a href="" id="Check-timing-1"></a>
</p>
<h4 id="check-timing" class="subsection">
1.6.2 Check timing
</h4>
<p>
There are several ways to find out where time is being spent in the check process. Start by setting the environment variable <code class="calibre2"><em>R_CHECK_TIMINGS</em></code> to ‘0’. This will report the total CPU times (not Windows) and elapsed times for installation and running examples, tests and vignettes, under each sub-architecture if appropriate. For tests and vignettes, it reports the time for each as well as the total.
</p>
<p>
Setting <code class="calibre2"><em>R_CHECK_TIMINGS</em></code> to a positive value sets a threshold (in seconds elapsed time) for reporting timings.
</p>
<p>
If you need to look in more detail at the timings for examples, use option –timings to <code class="calibre2">R CMD check</code> (this is set by –as-cran). This adds a summary to the check output for all the examples with CPU or elapsed time of more than 5 seconds. It produces a file mypkg.Rcheck/mypkg-Ex.timings containing timings for each help file: it is a tab-delimited file which can be read into R for further analysis.
</p>
<p>
Timings for the tests and vignette runs are given at the bottom of the corresponding log file: note that log files for successful vignette runs are only retained if environment variable <code class="calibre2"><em>R_CHECK_ALWAYS_LOG_VIGNETTE_OUTPUT</em></code> is set to a true value.
</p>
<hr />
<p>
<a href="" id="Encoding-issues"></a> <a href="" id="Encoding-issues-1"></a>
</p>
<h4 id="encoding-issues" class="subsection">
1.6.3 Encoding issues
</h4>
<p>
Care is needed if your package contains non-ASCII text, and in particular if it is intended to be used in more than one locale. It is possible to mark the encoding used in the DESCRIPTION file and in .Rd files, as discussed elsewhere in this manual.
</p>
<p>
First, consider carefully if you really need non-ASCII text. Many users of R will only be able to view correctly text in their native language group (e.g. Western European, Eastern European, Simplified Chinese) and ASCII.<a href="concept-index.html#FOOT84" id="DOCF84"><sup>84</sup></a>. Other characters may not be rendered at all, rendered incorrectly, or cause your R code to give an error. For .Rd documentation, marking the encoding and including ASCII transliterations is likely to do a reasonable job. The set of characters which is commonly supported is wider than it used to be around 2000, but non-Latin alphabets (Greek, Russian, Georgian, …) are still often problematic and those with double-width characters (Chinese, Japanese, Korean) often need specialist fonts to render correctly.
</p>
<p>
Several CRAN packages have messages in their R code in French (and a few in German). A better way to tackle this is to use the internationalization facilities discussed elsewhere in this manual.
</p>
<p>
Function <code class="calibre2">showNonASCIIfile</code> in package <strong>tools</strong> can help in finding non-ASCII bytes in files.
</p>
<p>
There is a portable way to have arbitrary text in character strings (only) in your R code, which is to supply them in Unicode as <code class="calibre2">\uxxxx</code> escapes. If there are any characters not in the current encoding the parser will encode the character string as UTF-8 and mark it as such. This applies also to character strings in datasets: they can be prepared using <code class="calibre2">\uxxxx</code> escapes or encoded in UTF-8 in a UTF-8 locale, or even converted to UTF-8 via ‘iconv()’. If you do this, make sure you have ‘R (&gt;= 2.10)’ (or later) in the ‘Depends’ field of the DESCRIPTION file.
</p>
<p>
R sessions running in non-UTF-8 locales will if possible re-encode such strings for display (and this is done by <code class="calibre2">RGui</code> on Windows, for example). Suitable fonts will need to be selected or made available<a href="concept-index.html#FOOT85" id="DOCF85"><sup>85</sup></a> both for the console/terminal and graphics devices such as ‘X11()’ and ‘windows()’. Using ‘postscript’ or ‘pdf’ will choose a default 8-bit encoding depending on the language of the UTF-8 locale, and your users would need to be told how to select the ‘encoding’ argument.
</p>
<p>
If you want to run <code class="calibre2">R CMD check</code> on a Unix-alike over a package that sets a package encoding in its DESCRIPTION file <em>and do not use a UTF-8 locale</em> you may need to specify a suitable locale <em>via</em> environment variable <code class="calibre2">R_ENCODING_LOCALES</code>. The default is equivalent to the value
</p>
<div class="example">
<pre class="example1"><code>&quot;latin1=en_US:latin2=pl_PL:UTF-8=en_US.UTF-8:latin9=fr_FR.iso885915@euro&quot;</code></pre>
</div>
<p>
(which is appropriate for a system based on <code class="calibre2">glibc</code>: macOS requires <code class="calibre2">latin9=fr_FR.ISO8859-15</code>) except that if the current locale is UTF-8 then the package code is translated to UTF-8 for syntax checking, so it is strongly recommended to check in a UTF-8 locale.
</p>
<hr />
<p>
<a href="" id="Portable-C-and-C_002b_002b-code"></a> <a href="" id="Portable-C-and-C_002b_002b-code-1"></a>
</p>
<h4 id="portable-c-and-c-code" class="subsection">
1.6.4 Portable C and C++ code
</h4>
<p>
Writing portable C and C++ code is mainly a matter of observing the standards (C99, C++98 or where declared C++11/14) and testing that extensions (such as POSIX functions) are supported.
</p>
<p>
Note that the ‘TR1’ C++ extensions are not part of any of these standards and the <code class="calibre2">&lt;tr1/name&gt;</code> headers are not supplied by some of the compilers used for R, including on macOS. (Use the C++11 versions instead.)
</p>
<p>
Note too that the POSIX standards only require recently-defined functions to be declared if certain macros are defined with large enough values, and on some compiler/OS combinations<a href="concept-index.html#FOOT86" id="DOCF86"><sup>86</sup></a> they are not declared otherwise. So you may need to include something like one of <a href="concept-index.html#FOOT87" id="DOCF87"><sup>87</sup></a>
</p>
<div class="example">
<pre class="example1"><code>#define _XOPEN_SOURCE 500</code></pre>
</div>
<p>
or
</p>
<div class="example">
<pre class="example1"><code>#ifdef __GLIBC__
# define _POSIX_C_SOURCE 200809L
#endif</code></pre>
</div>
<p>
before <em>any</em> headers. (<code class="calibre2">strdup</code> and <code class="calibre2">strncasecmp</code> are two such functions.)
</p>
<p>
However, some common errors are worth pointing out here. It can be helpful to look up functions at <a href="http://www.cplusplus.com/reference/" class="uri">http://www.cplusplus.com/reference/</a> or <a href="http://en.cppreference.com/w/" class="uri">http://en.cppreference.com/w/</a> and compare what is defined in the various standards.
</p>
<p>
Both the compiler and OS (<em>via</em> system header files, which may differ by architecture even for nominally the same OS) affect the compilability of C/C++ code. Compilers from the GCC, <code class="calibre2">clang</code>, Intel and Oracle Studio suites are routinely used with R, and both <code class="calibre2">clang</code> and Oracle have more than one implementation of C++ headers and library. The range of possibilities makes comprehensive empirical checking impossible, and regrettably compilers are patchy at best on warning about non-standard code.
</p>
<ul>
<li>
<p>
Mathematical functions such as <code class="calibre2">sqrt</code> are defined in C++ for floating-point arguments. It is legitimate in C++ to overload these with versions for types <code class="calibre2">float</code>, <code class="calibre2">double</code>, <code class="calibre2">long double</code> and possibly more. This means that calling <code class="calibre2">sqrt</code> on an integer type may have ‘overloading ambiguity’ as it could be promoted to any of the supported floating-point types: this is commonly seen on Solaris, but for <code class="calibre2">pow</code> also seen on macOS. (C++98 has an overload for <code class="calibre2">std::pow(&lt;double&gt;, &lt;int&gt;)</code>, but this may not be visible from the main namespace. C++11 requires additional overloads for integer types, and ambiguous overloads are more common in C++11 (and later) compiler modes.)
</p>
<p>
A not-uncommonly-seen problem is to mistakenly call <code class="calibre2">floor(x/y)</code> or <code class="calibre2">ceil(x/y)</code> for <code class="calibre2">int</code> arguments <code class="calibre2">x</code> and <code class="calibre2">y</code>. Since <code class="calibre2">x/y</code> does integer division, the result is an <code class="calibre2">int</code> and ‘overloading ambiguity’ may be reported. Some people have (pointlessly) called <code class="calibre2">floor</code> and <code class="calibre2">ceil</code> on integer arguments, which may have an ‘overloading ambiguity’.
</p>
<p>
A surprising common misuse is things like <code class="calibre2">pow(10, -3)</code>: this should be the constant <code class="calibre2">1e-3</code>.
</p>
</li>
<li>
Function <code class="calibre2">fabs</code> is defined only for floating-point types, except in C++11 which has overloads for <code class="calibre2">std::fabs</code> in &lt;cmath&gt; for integer types. Function <code class="calibre2">abs</code> is defined in C99’s &lt;stdlib.h&gt; for <code class="calibre2">int</code> and in C++98’s &lt;cstdlib&gt; for integer types, overloaded in &lt;cmath&gt; for floating-point types. C++11 has additional overloads for <code class="calibre2">std::abs</code> in &lt;cmath&gt; for integer types. The effect of calling <code class="calibre2">abs</code> with a floating-point type is implementation-specific: it may truncate to an integer.
</li>
<li>
<p>
Functions/macros such as <code class="calibre2">isnan</code>, <code class="calibre2">isinf</code> and <code class="calibre2">isfinite</code> are not required by C++98: where compilers support them they may be only in the <code class="calibre2">std</code> namespace or only in the main namespace. There is no way to make use of these functions which works with all C++ compilers currently in use on R platforms: use R’s versions such as <code class="calibre2">ISNAN</code> and <code class="calibre2">R_FINITE</code> instead.
</p>
<p>
If you must use them in C++11, beware that some compilers<a href="concept-index.html#FOOT88" id="DOCF88"><sup>88</sup></a> provide both <code class="calibre2">std::isnan</code> and <code class="calibre2">::isnan</code>, so using
</p>
<div class="example">
<pre class="example1"><code>using namespace std;</code></pre>
</div>
<p>
may cause ‘overloading ambiguity’ and you must use <code class="calibre2">std::isnan</code> <em>etc</em> explicitly.
</p>
<p>
It is an error (and make little sense, although has been seen) to call these functions for integer arguments: a few compilers give a compilation error.
</p>
</li>
<li>
<p>
The GNU C/C++ compilers support a large number of non-portable extensions. For example, <code class="calibre2">INFINITY</code> (which is in C99 but not C++98), for which R provides the portable <code class="calibre2">R_PosInf</code> (and <code class="calibre2">R_NegInf</code> for <code class="calibre2">-INFINITY</code>). And <code class="calibre2">NAN</code> is just one NaN value: in R code <code class="calibre2">NA_REAL</code> is usually what is intended, but <code class="calibre2">R_NaN</code> is also available.
</p>
<p>
Some (but not all) extensions are listed at <a href="https://gcc.gnu.org/onlinedocs/gcc/C-Extensions.html" class="uri">https://gcc.gnu.org/onlinedocs/gcc/C-Extensions.html</a> and <a href="https://gcc.gnu.org/onlinedocs/gcc/C_002b_002b-Extensions.html" class="uri">https://gcc.gnu.org/onlinedocs/gcc/C_002b_002b-Extensions.html</a>.
</p>
<p>
Other GNU extensions which have bitten package writers is the use of non-portable characters such as ‘$’ in identifiers and use of C++ headers under ext.
</p>
<p>
The GNU Fortran compiler also supports a large number of non-portable extensions, the most commonly encountered one being <code class="calibre2">ISNAN</code><a href="concept-index.html#FOOT89" id="DOCF89"><sup>89</sup></a>. Some are listed at <a href="https://gcc.gnu.org/onlinedocs/gfortran/Extensions-implemented-in-GNU-Fortran.html" class="uri">https://gcc.gnu.org/onlinedocs/gfortran/Extensions-implemented-in-GNU-Fortran.html</a>. One that frequently catches package writers is that it allows out-of-order declarations: in standard-conformant Fortran variables must be declared (explicitly or implicitly) before use in other declarations such as dimensions.
</p>
</li>
<li>
Including C-style headers in C++ code is not portable. Including the legacy header<a href="concept-index.html#FOOT90" id="DOCF90"><sup>90</sup></a> math.h in C++ code may conflict with cmath which may be included by other headers. This is particularly problematic with C++11 compilers, as functions like <code class="calibre2">sqrt</code> and <code class="calibre2">isnan</code> are defined for <code class="calibre2">double</code> arguments in math.h and for a range of types including <code class="calibre2">double</code> in cmath. Similar issues have been seen for stdlib.h and cstdlib. Including the C++ version first used to be a sufficient workaround but for some 2016 compilers only one could be included.
</li>
<li>
Variable-length arrays are C99, not supported by C++98 nor by the C++ compilers in use with R on some platforms.
</li>
<li>
The <code class="calibre2">restrict</code> qualifier is C99/C11 but not part of C++11 and not supported by some C++ compilers used with R.
</li>
<li>
<p>
Be careful to include the headers which define the functions you use. Some compilers/OSes include other system headers in their headers which are not required by the standards, and so code may compile on such systems and not on others. (A prominent example is the C++11 header <code class="calibre2">&lt;random&gt;</code> which is indirectly included by <code class="calibre2">&lt;algorithm&gt;</code> by <code class="calibre2">g++</code>. Another issue is the C header <code class="calibre2">&lt;time.h&gt;</code> which is included by other headers on Linux and Windows but not macOS nor Solaris.)
</p>
<p>
Note that <code class="calibre2">malloc</code>, <code class="calibre2">calloc</code>, <code class="calibre2">realloc</code> and <code class="calibre2">free</code> are defined by C99 in the header stdlib.h and (in the <code class="calibre2">std::</code> namespace) by C++ header cstdlib. Some earlier implementations used a header malloc.h, but that is not portable and does not exist on macOS.
</p>
<p>
This also applies to types such as <code class="calibre2">ssize_t</code>. The POSIX standards say that is declared in headers <code class="calibre2">unistd.h</code> and <code class="calibre2">sys/types.h</code>, and the latter is often included indirectly by other headers on some but not all systems.
</p>
<p>
Similarly for constants: for example <code class="calibre2">SIZE_MAX</code> is defined in <code class="calibre2">stdint.h</code> alongside <code class="calibre2">size_t</code> (according to the C99 standard: it is not part of C++98).
</p>
</li>
<li>
<p>
For C++ code, be careful to specify namespaces where needed. Many functions are defined by the standards to be in the <code class="calibre2">std</code> namespace, but <code class="calibre2">g++</code> puts many such also in the C++ main namespace. One way to do so is to use declarations such as
</p>
<div class="example">
<pre class="example1"><code>using std::floor;</code></pre>
</div>
<p>
but it is usually preferable to use explicit namespace prefixes in the code.
</p>
<p>
Examples seen in CRAN packages include
</p>
<div class="example">
<pre class="example1"><code>abs acos atan calloc ceil div exp fabs floor fmod free log malloc memcpy
memset pow printf qsort round sin sprintf sqrt strcmp strcpy strerror
strlen strncmp strtol tan trunc</code></pre>
</div>
</li>
<li>
<p>
Some C++ compilers refuse to compile constructs such as
</p>
<div class="example">
<pre class="example1"><code>      if(ptr &gt; 0) { ....}</code></pre>
</div>
<p>
which compares a pointer to the integer <code class="calibre2">0</code>. This could just use <code class="calibre2">if(ptr)</code> (pointer addresses cannot be negative) but if needed pointers can be tested against <code class="calibre2">nullptr</code> (C++11 and later) or <code class="calibre2">NULL</code>.
</p>
<p>
Note that although <code class="calibre2">nullptr</code> was only introduced in C++11, some compilers accept it in C++98 mode (but most do not).
</p>
</li>
<li>
Macros defined by the compiler/OS can cause problems. Identifiers starting with an underscore followed by an upper-case letter or another underscore are reserved for system macros and should not be used in portable code (including not as guards in C/C++ headers). Other macros, typically upper-case, may be defined by the compiler or system headers and can cause problems. The most common issue involves the names of the Intel CPU registers such as <code class="calibre2">CS</code>, <code class="calibre2">DS</code>, <code class="calibre2">ES</code>, <code class="calibre2">FS</code>, <code class="calibre2">GS</code> and <code class="calibre2">SS</code> (and more with longer abbreviations) defined on i586/x64 Solaris in &lt;sys/regset.h&gt; and often included indirectly by &lt;stdlib.h&gt; and other core headers. Further examples are <code class="calibre2">ERR</code>, <code class="calibre2">LITTLE_ENDIAN</code>, <code class="calibre2">zero</code> and <code class="calibre2">I</code> (which is defined in Solaris’ &lt;complex.h&gt; as a compiler intrinsic for the imaginary unit). Some of these can be avoided by defining <code class="calibre2">_POSIX_C_SOURCE</code> before including any system headers, but it is better to only use all-upper-case names which have a unique prefix such as the package name.
</li>
<li>
<code class="calibre2">typedef</code>s in OS headers can conflict with those in the package: examples include <code class="calibre2">ulong</code> on several OSes and <code class="calibre2">index_t</code> and <code class="calibre2">single</code> on Solaris. (Note that these may conflict with other uses as identifiers, e.g. defining a C++ function called <code class="calibre2">single</code>.)
</li>
<li>
<p>
If you use OpenMP, check carefully that you have followed the advice in the subsection on <a href="creating-r-packages.html#OpenMP-support">OpenMP support</a>. In particular, any use of OpenMP in C/C++ code will need to use
</p>
<div class="example">
<pre class="example1"><code>#ifdef _OPENMP
# include &lt;omp.h&gt;
#endif</code></pre>
</div>
<p>
Any use of OpenMP functions, e.g. <code class="calibre2">omp_set_num_threads</code> also needs to be conditioned.
</p>
<p>
And do not hardcode -lgomp: not only is that specific to the GCC family of compilers, using the correct linker flag often sets up the run-time path to the library.
</p>
</li>
<li>
<p>
Package authors commonly assume things are part of C99 when they are not: the most common example is POSIX function <code class="calibre2">strdup</code>. The most common C library on Linux, <code class="calibre2">glibc</code>, will hide the declarations of such extensions unless a ‘feature-test macro’ is defined <strong>before</strong> (almost) any system header is included. So for <code class="calibre2">strdup</code> you need
</p>
<div class="example">
<pre class="example1"><code>#define _POSIX_C_SOURCE 200809L
...
#include &lt;string.h&gt;
...
strdup call(s)</code></pre>
</div>
<p>
where the appropriate value can be found by <code class="calibre2">man strdup</code> on Linux. (Use of <code class="calibre2">strncasecmp</code> is similar.)
</p>
<p>
However, modes of <code class="calibre2">gcc</code> with ‘GNU EXTENSIONS’ (which are the default, either -std=gnu99 or -std=gnu11) declare enough macros to ensure that missing declarations are rarely seen.
</p>
<p>
This applies also to constants such as <code class="calibre2">M_PI</code> and <code class="calibre2">M_LN2</code>, which are part of the X/Open standard: to use these define <code class="calibre2">_XOPEN_SOURCE</code> before including any headers, or include the R header Rmath.h.
</p>
</li>
<li>
<p>
Similarly, package authors commonly assume things are part of C++ when they were introduced in C++11 if at all. Recent examples from CRAN packages include the C99/C++11 functions
</p>
<div class="example">
<pre class="example1"><code>erf expm1 fmin fmax lgamma lround loglp round snprintf strcasecmp trunc</code></pre>
</div>
<p>
(all of which are in the <code class="calibre2">std</code> namespace in C++11) and the POSIX functions <code class="calibre2">strdup</code> and <code class="calibre2">strncasecmp</code> and constants <code class="calibre2">M_PI</code> and <code class="calibre2">M_LN2</code> (see the previous item). R has long provided <code class="calibre2">fmax2</code>, <code class="calibre2">fmin2</code>, <code class="calibre2">fround</code>, <code class="calibre2">ftrunc</code>, <code class="calibre2">lgammafn</code> and many of the X/Open constants, declared in header Rmath.h. Uses of <code class="calibre2">erf</code> can be replaced by <code class="calibre2">pnorm</code> (see the R help page for the latter).
</p>
</li>
<li>
Using <code class="calibre2">alloca</code> portably is tricky: it is neither an ISO C nor a POSIX function. An adequately portable preamble is
<div class="example">
<pre class="example1"><code>#ifdef __GNUC__
/* Includes GCC, clang and Intel compilers */
# undef alloca
# define alloca(x) __builtin_alloca((x))
#elif defined(__sun) || defined(_AIX)
/* this is necessary (and sufficient) for Solaris 10 and AIX 6: */
# include &lt;alloca.h&gt;
#endif</code></pre>
</div>
</li>
</ul>
<p>
Some additional information for C++ is available at <a href="http://journal.r-project.org/archive/2011-2/RJournal_2011-2_Plummer.pdf" class="uri">http://journal.r-project.org/archive/2011-2/RJournal_2011-2_Plummer.pdf</a> by Martyn Plummer.
</p>
<hr />
<p>
<a href="" id="Binary-distribution"></a> <a href="" id="Binary-distribution-1"></a>
</p>
<h4 id="binary-distribution" class="subsection">
1.6.5 Binary distribution
</h4>
<p>
If you want to distribute a binary version of a package on Windows or OS X, there are further checks you need to do to check it is portable: it is all too easy to depend on external software on your own machine that other users will not have.
</p>
<p>
For Windows, check what other DLLs your package’s DLL depends on (‘imports’ from in the DLL tools’ parlance). A convenient GUI-based tool to do so is ‘Dependency Walker’ (<a href="http://www.dependencywalker.com/" class="uri">http://www.dependencywalker.com/</a>) for both 32-bit and 64-bit DLLs – note that this will report as missing links to R’s own DLLs such as R.dll and Rblas.dll. For 32-bit DLLs only, the command-line tool <code class="calibre2">pedump.exe -i</code> (in Rtools*.exe) can be used, and for the brave, the <code class="calibre2">objdump</code> tool in the appropriate toolchain will also reveal what DLLs are imported from. If you use a toolchain other than one provided by the R developers or use your own makefiles, watch out in particular for dependencies on the toolchain’s runtime DLLs such as libgfortran, libstdc++ and libgcc_s.
</p>
<p>
For macOS, using <code class="calibre2">R CMD otool -L</code> on the package’s shared object(s) in the libs directory will show what they depend on: watch for any dependencies in /usr/local/lib or /usr/local/gfortran/lib, notably libgfortran.?.dylib and libquadmath.0.dylib.
</p>
<p>
Many people (including the CRAN package repository) will not accept source packages containing binary files as the latter are a security risk. If you want to distribute a source package which needs external software on Windows or macOS, options include
</p>
<ul>
<li>
To arrange for installation of the package to download the additional software from a URL, as e.g. package <a href="https://CRAN.R-project.org/package=Cairo"><strong>Cairo</strong></a> does.
</li>
<li>
(For CRAN.) To negotiate with Uwe Ligges to host the additional components on WinBuilder, and write a configure.win file to install them.
</li>
</ul>
<p>
Be aware that license requirements will need to be met so you may need to supply the sources for the additional components (and will if your package has a GPL-like license).
</p>
<hr />
<p>
<a href="" id="Diagnostic-messages"></a> <a href="" id="Diagnostic-messages-1"></a>
</p>
<h3 id="diagnostic-messages" class="section">
1.7 Diagnostic messages
</h3>
<p>
Diagnostic messages can be made available for translation, so it is important to write them in a consistent style. Using the tools described in the next section to extract all the messages can give a useful overview of your consistency (or lack of it). Some guidelines follow.
</p>
<ul>
<li>
Messages are sentence fragments, and not viewed in isolation. So it is conventional not to capitalize the first word and not to end with a period (or other punctuation).
</li>
<li>
<p>
Try not to split up messages into small pieces. In C error messages use a single format string containing all English words in the messages.
</p>
<p>
In R error messages do not construct a message with <code class="calibre2">paste</code> (such messages will not be translated) but <em>via</em> multiple arguments to <code class="calibre2">stop</code> or <code class="calibre2">warning</code>, or <em>via</em> <code class="calibre2">gettextf</code>.
</p>
</li>
<li>
Do not use colloquialisms such as “can’t” and “don’t”.
</li>
<li>
<p>
Conventionally single quotation marks are used for quotations such as
</p>
<div class="example">
<pre class="example1"><code>&#39;ord&#39; must be a positive integer, at most the number of knots</code></pre>
</div>
<p>
and double quotation marks when referring to an R character string or a class, such as
</p>
<div class="example">
<pre class="example1"><code>&#39;format&#39; must be &quot;normal&quot; or &quot;short&quot; - using &quot;normal&quot;</code></pre>
</div>
<p>
Since ASCII does not contain directional quotation marks, it is best to use ‘’’ and let the translator (including automatic translation) use directional quotations where available. The range of quotation styles is immense: unfortunately we cannot reproduce them in a portable <code class="calibre2">texinfo</code> document. But as a taster, some languages use ‘up’ and ‘down’ (comma) quotes rather than left or right quotes, and some use guillemets (and some use what Adobe calls ‘guillemotleft’ to start and others use it to end).
</p>
<p>
In R messages it is also possible to use <code class="calibre2">sQuote</code> or <code class="calibre2">dQuote</code> as in
</p>
<div class="example">
<pre class="example1"><code>        stop(gettextf(&quot;object must be of class %s or %s&quot;,
                      dQuote(&quot;manova&quot;), dQuote(&quot;maov&quot;)),
             domain = NA)</code></pre>
</div>
</li>
<li>
<p>
Occasionally messages need to be singular or plural (and in other languages there may be no such concept or several plural forms – Slovenian has four). So avoid constructions such as was once used in <code class="calibre2">library</code>
</p>
<div class="example">
<pre class="example1"><code>if((length(nopkgs) &gt; 0) &amp;&amp; !missing(lib.loc)) {
    if(length(nopkgs) &gt; 1)
        warning(&quot;libraries &quot;,
                paste(sQuote(nopkgs), collapse = &quot;, &quot;),
                &quot; contain no packages&quot;)
    else
        warning(&quot;library &quot;, paste(sQuote(nopkgs)),
                &quot; contains no package&quot;)
}</code></pre>
</div>
<p>
and was replaced by
</p>
<div class="example">
<pre class="example1"><code>if((length(nopkgs) &gt; 0) &amp;&amp; !missing(lib.loc)) {
    pkglist &lt;- paste(sQuote(nopkgs), collapse = &quot;, &quot;)
    msg &lt;- sprintf(ngettext(length(nopkgs),
                            &quot;library %s contains no packages&quot;,
                            &quot;libraries %s contain no packages&quot;,
                            domain = &quot;R-base&quot;),
                   pkglist)
    warning(msg, domain=NA)
}</code></pre>
</div>
<p>
Note that it is much better to have complete clauses as here, since in another language one might need to say ‘There is no package in library %s’ or ‘There are no packages in libraries %s’.
</p>
</li>
</ul>
<hr />
<p>
<a href="" id="Internationalization"></a> <a href="" id="Internationalization-1"></a>
</p>
<h3 id="internationalization" class="section">
1.8 Internationalization
</h3>
<p>
There are mechanisms to translate the R- and C-level error and warning messages. There are only available if R is compiled with NLS support (which is requested by <code class="calibre2">configure</code> option –enable-nls, the default).
</p>
<p>
The procedures make use of <code class="calibre2">msgfmt</code> and <code class="calibre2">xgettext</code> which are part of GNU <code class="calibre2">gettext</code> and this will need to be installed: Windows users can find pre-compiled binaries at <a href="https://www.stats.ox.ac.uk/pub/Rtools/goodies/gettext-tools.zip" class="uri">https://www.stats.ox.ac.uk/pub/Rtools/goodies/gettext-tools.zip</a>.
</p>
<hr />
<p>
<a href="" id="C_002dlevel-messages"></a> <a href="" id="C_002dlevel-messages-1"></a>
</p>
<h4 id="c-level-messages" class="subsection">
1.8.1 C-level messages
</h4>
<p>
The process of enabling translations is
</p>
<ul>
<li>
In a header file that will be included in all the C (or C++ or Objective C/C++) files containing messages that should be translated, declare
<div class="example">
<pre class="example1"><code>#include &lt;R.h&gt;  /* to include Rconfig.h */

#ifdef ENABLE_NLS
#include &lt;libintl.h&gt;
#define _(String) dgettext (&quot;pkg&quot;, String)
/* replace pkg as appropriate */
#else
#define _(String) (String)
#endif</code></pre>
</div>
</li>
<li>
<p>
For each message that should be translated, wrap it in <code class="calibre2">_(…)</code>, for example
</p>
<div class="example">
<pre class="example1"><code>error(_(&quot;&#39;ord&#39; must be a positive integer&quot;));</code></pre>
</div>
<p>
If you want to use different messages for singular and plural forms, you need to add
</p>
<div class="example">
<pre class="example1"><code>#ifndef ENABLE_NLS
#define dngettext(pkg, String, StringP, N) (N &gt; 1 ? StringP : String)
#endif</code></pre>
</div>
<p>
and mark strings by
</p>
<div class="example">
<pre class="example1"><code>dngettext(&quot;pkg&quot;, &lt;singular string&gt;, &lt;plural string&gt;, n)</code></pre>
</div>
</li>
<li>
In the package’s src directory run
<div class="example">
<pre class="example1"><code>xgettext --keyword=_ -o pkg.pot *.c</code></pre>
</div>
</li>
</ul>
<p>
The file src/pkg.pot is the template file, and conventionally this is shipped as po/pkg.pot.
</p>
<hr />
<p>
<a href="" id="R-messages"></a> <a href="" id="R-messages-1"></a>
</p>
<h4 id="r-messages" class="subsection">
1.8.2 R messages
</h4>
<p>
Mechanisms are also available to support the automatic translation of R <code class="calibre2">stop</code>, <code class="calibre2">warning</code> and <code class="calibre2">message</code> messages. They make use of message catalogs in the same way as C-level messages, but using domain <code class="calibre2">R-pkg</code> rather than <code class="calibre2">pkg</code>. Translation of character strings inside <code class="calibre2">stop</code>, <code class="calibre2">warning</code> and <code class="calibre2">message</code> calls is automatically enabled, as well as other messages enclosed in calls to <code class="calibre2">gettext</code> or <code class="calibre2">gettextf</code>. (To suppress this, use argument <code class="calibre2">domain=NA</code>.)
</p>
<p>
Tools to prepare the R-pkg.pot file are provided in package <strong>tools</strong>: <code class="calibre2">xgettext2pot</code> will prepare a file from all strings occurring inside <code class="calibre2">gettext</code>/<code class="calibre2">gettextf</code>, <code class="calibre2">stop</code>, <code class="calibre2">warning</code> and <code class="calibre2">message</code> calls. Some of these are likely to be spurious and so the file is likely to need manual editing. <code class="calibre2">xgettext</code> extracts the actual calls and so is more useful when tidying up error messages.
</p>
<p>
The R function <code class="calibre2">ngettext</code> provides an interface to the C function of the same name: see example in the previous section. It is safest to use <code class="calibre2">domain=“R-pkg”</code> explicitly in calls to <code class="calibre2">ngettext</code>, and necessary for earlier versions of R unless they are calls directly from a function in the package.
</p>
<hr />
<p>
<a href="" id="Preparing-translations"></a> <a href="" id="Preparing-translations-1"></a>
</p>
<h4 id="preparing-translations" class="subsection">
1.8.3 Preparing translations
</h4>
<p>
Once the template files have been created, translations can be made. Conventional translations have file extension .po and are placed in the po subdirectory of the package with a name that is either ‘ll.po’ or ‘R-ll.po’ for translations of the C and R messages respectively to language with code ‘ll’.
</p>
<p>
See ‘Localization of messages’ in ‘R Installation and Administration’, for details of language codes.
</p>
<p>
There is an R function, <code class="calibre2">update_pkg_po</code> in package <strong>tools</strong>, to automate much of the maintenance of message translations. See its help for what it does in detail.
</p>
<p>
If this is called on a package with no existing translations, it creates the directory pkgdir/po, creates a template file of R messages, pkgdir/po/R-pkg.pot, within it, creates the ‘<a href="mailto:en@quot">en@quot</a>’ translation and installs that. (The ‘<a href="mailto:en@quot">en@quot</a>’ pseudo-language interprets quotes in their directional forms in suitable (e.g. UTF-8) locales.)
</p>
<p>
If the package has C source files in its src directory that are marked for translation, use
</p>
<div class="example">
<pre class="example1"><code>touch pkgdir/po/pkg.pot</code></pre>
</div>
<p>
to create a dummy template file, then call <code class="calibre2">update_pkg_po</code> again (this can also be done before it is called for the first time).
</p>
<p>
When translations to new languages are added in the pkgdir/po directory, running the same command will check and then install the translations.
</p>
<p>
If the package sources are updated, the same command will update the template files, merge the changes into the translation .po files and then installed the updated translations. You will often see that merging marks translations as ‘fuzzy’ and this is reported in the coverage statistics. As fuzzy translations are <em>not</em> used, this is an indication that the translation files need human attention.
</p>
<p>
The merged translations are run through <code class="calibre2">tools::checkPofile</code> to check that C-style formats are used correctly: if not the mismatches are reported and the broken translations are not installed.
</p>
<p>
This function needs the GNU <code class="calibre2">gettext-tools</code> installed and on the path: see its help page.
</p>
<p>
<a href="" id="index-CITATION-1"></a> <a href="" id="index-citation-1"></a>
</p>
<hr />
<p>
<a href="" id="CITATION-files"></a> <a href="" id="CITATION-files-1"></a>
</p>
<h3 id="citation-files" class="section">
1.9 CITATION files
</h3>
<p>
An installed file named CITATION will be used by the <code class="calibre2">citation()</code> function. (It should be in the inst subdirectory of the package sources.)
</p>
<p>
The CITATION file is parsed as R code (in the package’s declared encoding, or in ASCII if none is declared). If no such file is present, <code class="calibre2">citation</code> auto-generates citation information from the package DESCRIPTION metadata, and an example of what that would look like as a CITATION file can be seen in recommended package <a href="https://CRAN.R-project.org/package=nlme"><strong>nlme</strong></a> (see below): recommended packages <a href="https://CRAN.R-project.org/package=boot"><strong>boot</strong></a>, <a href="https://CRAN.R-project.org/package=cluster"><strong>cluster</strong></a> and <a href="https://CRAN.R-project.org/package=mgcv"><strong>mgcv</strong></a> have further examples.
</p>
<p>
A CITATION file will contain calls to function <code class="calibre2">bibentry</code>.
</p>
<p>
Here is that for <a href="https://CRAN.R-project.org/package=nlme"><strong>nlme</strong></a>:
</p>
<div class="example">
<pre class="example1"><code>year &lt;- sub(&quot;-.*&quot;, &quot;&quot;, meta&#36;Date)
note &lt;- sprintf(&quot;R package version %s&quot;, meta&#36;Version)

bibentry(bibtype = &quot;Manual&quot;,
         title = &quot;{nlme}: Linear and Nonlinear Mixed Effects Models&quot;,
         author = c(person(&quot;Jose&quot;, &quot;Pinheiro&quot;),
                    person(&quot;Douglas&quot;, &quot;Bates&quot;),
                    person(&quot;Saikat&quot;, &quot;DebRoy&quot;),
                    person(&quot;Deepayan&quot;, &quot;Sarkar&quot;),
                    person(&quot;R Core Team&quot;)),
         year = year,
         note = note,
         url = &quot;https://CRAN.R-project.org/package=nlme&quot;)</code></pre>
</div>
<p>
Note the way that information that may need to be updated is picked up from object <code class="calibre2">meta</code>, a parsed version of the DESCRIPTION file – it is tempting to hardcode such information, but it normally then gets outdated. See <code class="calibre2">?bibentry</code> for further details of the information which can be provided.
</p>
<p>
In case a bibentry contains LaTeX markup (e.g., for accented characters or mathematical symbols), it may be necessary to provide a text representation to be used for printing via the <code class="calibre2">textVersion</code> argument to <code class="calibre2">bibentry</code>. E.g., earlier versions of <a href="https://CRAN.R-project.org/package=nlme"><strong>nlme</strong></a> additionally used
</p>
<div class="example">
<pre class="example1"><code>         textVersion =
         paste0(&quot;Jose Pinheiro, Douglas Bates, Saikat DebRoy,&quot;,
                &quot;Deepayan Sarkar and the R Core Team (&quot;,
                year,
                &quot;). nlme: Linear and Nonlinear Mixed Effects Models. &quot;,
                note, &quot;.&quot;)</code></pre>
</div>
<p>
The CITATION file should itself produce no output when <code class="calibre2">source</code>-d.
</p>
<p>
It is desirable (and essential for CRAN) that the CITATION file does not contain calls to functions such as <code class="calibre2">packageDescription</code> which assume the package is installed in a library tree on the package search path.
</p>
<hr />
<p>
<a href="" id="Package-types"></a> <a href="" id="Package-types-1"></a>
</p>
<h3 id="package-types" class="section">
1.10 Package types
</h3>
<p>
The DESCRIPTION file has an optional field <code class="calibre2">Type</code> which if missing is assumed to be ‘Package’, the sort of extension discussed so far in this chapter. Currently one other type is recognized; there used also to be a ‘Translation’ type.
</p>
<hr />
<p>
<a href="" id="Frontend"></a> <a href="" id="Frontend-1"></a>
</p>
<h4 id="frontend" class="subsection">
1.10.1 Frontend
</h4>
<p>
This is a rather general mechanism, designed for adding new front-ends such as the former <strong>gnomeGUI</strong> package (see the Archive area on CRAN). If a configure file is found in the top-level directory of the package it is executed, and then if a Makefile is found (often generated by configure), <code class="calibre2">make</code> is called. If <code class="calibre2">R CMD INSTALL –clean</code> is used <code class="calibre2">make clean</code> is called. No other action is taken.
</p>
<p>
<code class="calibre2">R CMD build</code> can package up this type of extension, but <code class="calibre2">R CMD check</code> will check the type and skip it.
</p>
<p>
Many packages of this type need write permission for the R installation directory.
</p>
<hr />
<p>
<a href="" id="Services"></a> <a href="" id="Services-1"></a>
</p>
<h3 id="services" class="section">
1.11 Services
</h3>
<p>
Several members of the R project have set up services to assist those writing R packages, particularly those intended for public distribution.
</p>
<p>
<a href="https://win-builder.r-project.org">win-builder.r-project.org</a> offers the automated preparation of (32/64-bit) Windows binaries from well-tested source packages.
</p>
<p>
R-Forge (<a href="https://R-Forge.r-project.org">R-Forge.r-project.org</a>) and RForge (<a href="https://www.rforge.net">www.rforge.net</a>) are similar services with similar names. Both provide source-code management through SVN, daily building and checking, mailing lists and a repository that can be accessed <em>via</em> <code class="calibre2">install.packages</code> (they can be selected by <code class="calibre2">setRepositories</code> and the GUI menus that use it). Package developers have the opportunity to present their work on the basis of project websites or news announcements. Mailing lists, forums or wikis provide useRs with convenient instruments for discussions and for exchanging information between developers and/or interested useRs.
</p>
<hr />
<p>
<a href="" id="Writing-R-documentation-files"></a> <a href="" id="Writing-R-documentation-files-1"></a>
</p>
<div id="calibre_pb_6" class="calibre6">

</div>

</div>
            </section>

          </div>
        </div>
      </div>
<a href="acknowledgements.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="writing-r-documentation-files.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
