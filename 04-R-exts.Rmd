#  Creating R packages
<p><a href="" id="index-Packages"></a> <a href="" id="index-Creating-packages"></a></p>
<p>Packages provide a mechanism for loading optional code, data and documentation as needed. The R distribution itself includes about 30 packages.</p>
<p>In the following, we assume that you know the <code class="calibre2">library()</code> command, including its <code class="calibre2">lib.loc</code> argument, and we also assume basic knowledge of the <code class="calibre2">R CMD INSTALL</code> utility. Otherwise, please look at R’s help pages on</p>
<div class="example">
<pre class="example1"><code>?library
?INSTALL</code></pre>
</div>
<p>before reading on.</p>
<p>For packages which contain code to be compiled, a computing environment including a number of tools is assumed; the “R Installation and Administration” manual describes what is needed for each OS.</p>
<p>Once a source package is created, it must be installed by the command <code class="calibre2">R CMD INSTALL</code>.</p>
<p>Other types of extensions are supported (but rare): See <a href="creating-r-packages.html#Package-types">Package types</a>.</p>
<p>Some notes on terminology complete this introduction. These will help with the reading of this manual, and also in describing concepts accurately when asking for help.</p>
<p>A <em>package</em> is a directory of files which extend R, a <em>source package</em> (the master files of a package), or a tarball containing the files of a source package, or an <em>installed</em> package, the result of running <code class="calibre2">R CMD INSTALL</code> on a source package. On some platforms (notably macOS and Windows) there are also <em>binary packages</em>, a zip file or tarball containing the files of an installed package which can be unpacked rather than installing from sources.</p>
<p>A package is <strong>not</strong><a href="concept-index.html#FOOT1" id="DOCF1"><sup>1</sup></a> a <em>library</em>. The latter is used in two senses in R documentation.</p>
<ul>
<li>A directory into which packages are installed, e.g. /usr/lib/R/library: in that sense it is sometimes referred to as a <em>library directory</em> or <em>library tree</em> (since the library is a directory which contains packages as directories, which themselves contain directories).</li>
<li>That used by the operating system, as a shared, dynamic or static library or (especially on Windows) a DLL, where the second L stands for ‘library’. Installed packages may contain compiled code in what is known on Unix-alikes as a <em>shared object</em> and on Windows as a DLL. The concept of a <em>shared library</em> (<em>dynamic library</em> on macOS) as a collection of compiled code to which a package might link is also used, especially for R itself on some platforms. On most platforms these concepts are interchangeable (shared objects and DLLs can both be loaded into the R process and be linked against), but macOS distinguishes between shared objects (extension .so) and dynamic libraries (extension .dylib).</li>
</ul>
<p>There are a number of well-defined operations on source packages.</p>
<ul>
<li>The most common is <em>installation</em> which takes a source package and installs it in a library using <code class="calibre2">R CMD INSTALL</code> or <code class="calibre2">install.packages</code>.</li>
<li>Source packages can be <em>built</em>. This involves taking a source directory and creating a tarball ready for distribution, including cleaning it up and creating PDF documentation from any <em>vignettes</em> it may contain. Source packages (and most often tarballs) can be <em>checked</em>, when a test installation is done and tested (including running its examples); also, the contents of the package are tested in various ways for consistency and portability.</li>
<li><em>Compilation</em> is not a correct term for a package. Installing a source package which contains C, C++ or Fortran code will involve compiling that code. There is also the possibility of ‘byte’ compiling the R code in a package (using the facilities of package <strong>compiler</strong>): already base and recommended packages are normally byte-compiled and this can be specified for other packages. So <em>compiling</em> a package may come to mean byte-compiling its R code.</li>
<li>It used to be unambiguous to talk about <em>loading</em> an installed package using <code class="calibre2">library()</code>, but since the advent of package namespaces this has been less clear: people now often talk about <em>loading</em> the package’s namespace and then <em>attaching</em> the package so it becomes visible on the search path. Function <code class="calibre2">library</code> performs both steps, but a package’s namespace can be loaded without the package being attached (for example by calls like <code class="calibre2">splines::ns</code>).</li>
</ul>
<p>The concept of <em>lazy loading</em> of code or data is mentioned at several points. This is part of the installation, always selected for R code but optional for data. When used the R objects of the package are created at installation time and stored in a database in the R directory of the installed package, being loaded into the session at first use. This makes the R session start up faster and use less (virtual) memory.</p>
<p><a href="" id="index-CRAN"></a></p>
<p>CRAN is a network of WWW sites holding the R distributions and contributed code, especially R packages. Users of R are encouraged to join in the collaborative project and to submit their own packages to CRAN: current instructions are linked from <a href="https://CRAN.R-project.org/banner.shtml#submitting" class="uri">https://CRAN.R-project.org/banner.shtml#submitting</a>.</p>
<hr />
<p><a href="" id="Package-structure"></a> <a href="" id="Package-structure-1"></a></p>
<h3 id="package-structure" class="section">1.1 Package structure</h3>
<p><a href="" id="index-Package-structure"></a></p>
<p>The sources of an R package consists of a subdirectory containing a files DESCRIPTION and NAMESPACE, and the subdirectories R, data, demo, exec, inst, man, po, src, tests, tools and vignettes (some of which can be missing, but which should not be empty). The package subdirectory may also contain files INDEX, configure, cleanup, LICENSE, LICENCE and NEWS. Other files such as INSTALL (for non-standard installation instructions), README/README.md<a href="concept-index.html#FOOT2" id="DOCF2"><sup>2</sup></a>, or ChangeLog will be ignored by R, but may be useful to end users. The utility <code class="calibre2">R CMD build</code> may add files in a build directory (but this should not be used for other purposes).</p>
<p>Except where specifically mentioned,<a href="concept-index.html#FOOT3" id="DOCF3"><sup>3</sup></a> packages should not contain Unix-style ‘hidden’ files/directories (that is, those whose name starts with a dot).</p>
<p>The DESCRIPTION and INDEX files are described in the subsections below. The NAMESPACE file is described in the section on <a href="creating-r-packages.html#Package-namespaces">Package namespaces</a>.</p>
<p><a href="" id="index-configure-file"></a> <a href="" id="index-cleanup-file"></a></p>
<p>The optional files configure and cleanup are (Bourne) shell scripts which are, respectively, executed before and (if option --clean was given) after installation on Unix-alikes, see <a href="#Configure-and-cleanup">Configure and cleanup</a>. The analogues on Windows are configure.win and cleanup.win.</p>
<p>For the conventions for files NEWS and ChangeLog in the GNU project see <a href="https://www.gnu.org/prep/standards/standards.html#Documentation" class="uri">https://www.gnu.org/prep/standards/standards.html#Documentation</a>.</p>
<p>The package subdirectory should be given the same name as the package. Because some file systems (e.g., those on Windows and by default on OS X) are not case-sensitive, to maintain portability it is strongly recommended that case distinctions not be used to distinguish different packages. For example, if you have a package named foo, do not also create a package named Foo.</p>
<p>To ensure that file names are valid across file systems and supported operating systems, the ASCII control characters as well as the characters ‘&quot;’, ‘*’, ‘:’, ‘/’, ‘&lt;’, ‘&gt;’, ‘?’, ‘&#92;’, and ‘|’ are not allowed in file names. In addition, files with names ‘con’, ‘prn’, ‘aux’, ‘clock&#36;’, ‘nul’, ‘com1’ to ‘com9’, and ‘lpt1’ to ‘lpt9’ after conversion to lower case and stripping possible “extensions” (e.g., ‘lpt5.foo.bar’), are disallowed. Also, file names in the same directory must not differ only by case (see the previous paragraph). In addition, the basenames of ‘.Rd’ files may be used in URLs and so must be ASCII and not contain <code class="calibre2">%</code>. For maximal portability filenames should only contain only ASCII characters not excluded already (that is <code class="calibre2">A-Za-z0-9._!#&#36;%&amp;+,;=@^(){}'[]</code> — we exclude space as many utilities do not accept spaces in file paths): non-English alphabetic characters cannot be guaranteed to be supported in all locales. It would be good practice to avoid the shell metacharacters <code class="calibre2">(){}'[]&#36;~</code>: <code class="calibre2">~</code> is also used as part of ‘8.3’ filenames on Windows. In addition, packages are normally distributed as tarballs, and these have a limit on path lengths: for maximal portability 100 bytes.</p>
<p>A source package if possible should not contain binary executable files: they are not portable, and a security risk if they are of the appropriate architecture. <code class="calibre2">R CMD check</code> will warn about them<a href="concept-index.html#FOOT4" id="DOCF4"><sup>4</sup></a> unless they are listed (one filepath per line) in a file BinaryFiles at the top level of the package. Note that CRAN will not accept submissions containing binary files even if they are listed.</p>
<p>The R function <code class="calibre2">package.skeleton</code> can help to create the structure for a new package: see its help page for details.</p>
<hr />
<p><a href="" id="The-DESCRIPTION-file"></a> <a href="" id="The-DESCRIPTION-file-1"></a></p>
<h4 id="the-description-file" class="subsection">1.1.1 The DESCRIPTION file</h4>
<p><a href="" id="index-DESCRIPTION-file"></a></p>
<p>The DESCRIPTION file contains basic information about the package in the following format:</p>
<blockquote>
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><div class="example">
<pre class="smallexample"><code>Package: pkgname
Version: 0.5-1
Date: 2015-01-01
Title: My First Collection of Functions
Authors@R: c(person(&quot;Joe&quot;, &quot;Developer&quot;, role = c(&quot;aut&quot;, &quot;cre&quot;),
                     email = &quot;Joe.Developer@some.domain.net&quot;),
              person(&quot;Pat&quot;, &quot;Developer&quot;, role = &quot;aut&quot;),
              person(&quot;A.&quot;, &quot;User&quot;, role = &quot;ctb&quot;,
                     email = &quot;A.User@whereever.net&quot;))
Author: Joe Developer [aut, cre],
  Pat Developer [aut],
  A. User [ctb]
Maintainer: Joe Developer &lt;Joe.Developer@some.domain.net&gt;
Depends: R (&gt;= 3.1.0), nlme
Suggests: MASS
Description: A (one paragraph) description of what
  the package does and why it may be useful.
License: GPL (&gt;= 2)
URL: https://www.r-project.org, http://www.another.url
BugReports: https://pkgname.bugtracker.url</code></pre>
</div></td>
</tr>
</tbody>
</table>
</blockquote>
<p>The format is that of a version of a ‘Debian Control File’ (see the help for ‘read.dcf’ and <a href="https://www.debian.org/doc/debian-policy/ch-controlfields.html" class="uri">https://www.debian.org/doc/debian-policy/ch-controlfields.html</a>: R does not require encoding in UTF-8 and does not support comments starting with ‘#’). Fields start with an ASCII name immediately followed by a colon: the value starts after the colon and a space. Continuation lines (for example, for descriptions longer than one line) start with a space or tab. Field names are case-sensitive: all those used by R are capitalized.</p>
<p>For maximal portability, the DESCRIPTION file should be written entirely in ASCII — if this is not possible it must contain an ‘Encoding’ field (see below).</p>
<p>Several optional fields take <em>logical values</em>: these can be specified as ‘yes’, ‘true’, ‘no’ or ‘false’: capitalized values are also accepted.</p>
<p>The ‘Package’, ‘Version’, ‘License’, ‘Description’, ‘Title’, ‘Author’, and ‘Maintainer’ fields are mandatory, all other fields are optional. Fields ‘Author’ and ‘Maintainer’ can be auto-generated from ‘Authors@R’, and may be omitted if the latter is provided: however if they are not ASCII we recommend that they are provided.</p>
<p>The mandatory ‘Package’ field gives the name of the package. This should contain only (ASCII) letters, numbers and dot, have at least two characters and start with a letter and not end in a dot. If it needs explaining, this should be done in the ‘Description’ field (and not the ‘Title’ field).</p>
<p>The mandatory ‘Version’ field gives the version of the package. This is a sequence of at least <em>two</em> (and usually three) non-negative integers separated by single ‘.’ or ‘-’ characters. The canonical form is as shown in the example, and a version such as ‘0.01’ or ‘0.01.0’ will be handled as if it were ‘0.1-0’. It is <strong>not</strong> a decimal number, so for example <code class="calibre2">0.9 &lt; 0.75</code> since <code class="calibre2">9 &lt; 75</code>.</p>
<p>The mandatory ‘License’ field is discussed in the next subsection.</p>
<p>The mandatory ‘Title’ field should give a <em>short</em> description of the package. Some package listings may truncate the title to 65 characters. It should use <em>title case</em> (that is, use capitals for the principal words: <code class="calibre2">tools::toTitleCase</code> can help you with this), not use any markup, not have any continuation lines, and not end in a period (unless part of …). Do not repeat the package name: it is often used prefixed by the name. Refer to other packages and external software in single quotes, and to book titles (and similar) in double quotes.</p>
<p>The mandatory ‘Description’ field should give a <em>comprehensive</em> description of what the package does. One can use several (complete) sentences, but only one paragraph. It should be intelligible to all the intended readership (e.g. for a CRAN package to all CRAN users). It is good practice not to start with the package name, ‘This package’ or similar. As with the ‘Title’ field, double quotes should be used for quotations (including titles of books and articles), and single quotes for non-English usage, including names of other packages and external software. This field should also be used for explaining the package name if necessary. URLs should be enclosed in angle brackets, e.g. ‘&lt;https://www.r-project.org&gt;’: see also <a href="#Specifying-URLs">Specifying URLs</a>.</p>
<p>The mandatory ‘Author’ field describes who wrote <em>the package</em>. It is a plain text field intended for human readers, but not for automatic processing (such as extracting the email addresses of all listed contributors: for that use ‘Authors@R’). Note that all significant contributors must be included: if you wrote an R wrapper for the work of others included in the src directory, you are not the sole (and maybe not even the main) author.</p>
<p>The mandatory ‘Maintainer’ field should give a <em>single</em> name followed by a <em>valid</em> (RFC 2822) email address in angle brackets. It should not end in a period or comma. This field is what is reported by the <code class="calibre2">maintainer</code> function and used by <code class="calibre2">bug.report</code>. For a CRAN package it should be a <em>person</em>, not a mailing list and not a corporate entity: do ensure that it is valid and will remain valid for the lifetime of the package.</p>
<p>Note that the <em>display name</em> (the part before the address in angle brackets) should be enclosed in double quotes if it contains non-alphanumeric characters such as comma or period. (The current standard, RFC 5322, allows periods but RFC 2822 did not.)</p>
<p>Both ‘Author’ and ‘Maintainer’ fields can be omitted if a suitable ‘Authors@R’ field is given. This field can be used to provide a refined and machine-readable description of the package “authors” (in particular specifying their precise <em>roles</em>), via suitable R code. It should create an object of class <code class="calibre2">&quot;person&quot;</code>, by either a call to <code class="calibre2">person</code> or a series of calls (one per “author”) concatenated by <code class="calibre2">c()</code>: see the example DESCRIPTION file above. The roles can include ‘&quot;aut&quot;’ (author) for full authors, ‘&quot;cre&quot;’ (creator) for the package maintainer, and ‘&quot;ctb&quot;’ (contributor) for other contributors, ‘&quot;cph&quot;’ (copyright holder), among others. See <code class="calibre2">?person</code> for more information. Note that no role is assumed by default. Auto-generated package citation information takes advantage of this specification. The ‘Author’ and ‘Maintainer’ fields are auto-generated from it if needed when building<a href="concept-index.html#FOOT5" id="DOCF5"><sup>5</sup></a> or installing.</p>
<p><a href="" id="index-COPYRIGHTS"></a></p>
<p>An optional ‘Copyright’ field can be used where the copyright holder(s) are not the authors. If necessary, this can refer to an installed file: the convention is to use file inst/COPYRIGHTS.</p>
<p>The optional ‘Date’ field gives the <em>release date</em> of the current version of the package. It is strongly recommended<a href="concept-index.html#FOOT6" id="DOCF6"><sup>6</sup></a> to use the ‘yyyy-mm-dd’ format conforming to the ISO 8601 standard.</p>
<p>The ‘Depends’, ‘Imports’, ‘Suggests’, ‘Enhances’, ‘LinkingTo’ and ‘Additional_repositories’ fields are discussed in a later subsection.</p>
<p>Dependencies external to the R system should be listed in the ‘SystemRequirements’ field, possibly amplified in a separate README file.</p>
<p>The ‘URL’ field may give a list of URLs separated by commas or whitespace, for example the homepage of the author or a page where additional material describing the software can be found. These URLs are converted to active hyperlinks in CRAN package listings. See <a href="#Specifying-URLs">Specifying URLs</a>.</p>
<p>The ‘BugReports’ field may contain a single URL to which bug reports about the package should be submitted. This URL will be used by <code class="calibre2">bug.report</code> instead of sending an email to the maintainer. A browser is opened for a ‘http://’ or ‘https://’ URL. As from R 3.4.0, <code class="calibre2">bug.report</code> will try to extract an email address (preferably from a ‘mailto:’ URL or enclosed in angle brackets).</p>
<p>Base and recommended packages (i.e., packages contained in the R source distribution or available from CRAN and recommended to be included in every binary distribution of R) have a ‘Priority’ field with value ‘base’ or ‘recommended’, respectively. These priorities must not be used by other packages.</p>
<p>A ‘Collate’ field can be used for controlling the collation order for the R code files in a package when these are processed for package installation. The default is to collate according to the ‘C’ locale. If present, the collate specification must list <em>all</em> R code files in the package (taking possible OS-specific subdirectories into account, see <a href="#Package-subdirectories">Package subdirectories</a>) as a whitespace separated list of file paths relative to the R subdirectory. Paths containing white space or quotes need to be quoted. An OS-specific collation field (‘Collate.unix’ or ‘Collate.windows’) will be used in preference to ‘Collate’.</p>
<p>The ‘LazyData’ logical field controls whether the R datasets use lazy-loading. A ‘LazyLoad’ field was used in versions prior to 2.14.0, but now is ignored.</p>
<p>The ‘KeepSource’ logical field controls if the package code is sourced using <code class="calibre2">keep.source = TRUE</code> or <code class="calibre2">FALSE</code>: it might be needed exceptionally for a package designed to always be used with <code class="calibre2">keep.source = TRUE</code>.</p>
<p>The ‘ByteCompile’ logical field controls if the package code is to be byte-compiled on installation: the default is currently not to, so this may be useful for a package known to benefit particularly from byte-compilation (which can take quite a long time and increases the installed size of the package). It is used for the recommended packages, as they are byte-compiled when R is installed and for consistency should be byte-compiled when updated. This can be overridden by installing with flag --no-byte-compile.</p>
<p>The ‘ZipData’ logical field was used to control whether the automatic Windows build would zip up the data directory or not prior to R 2.13.0: it is now ignored.</p>
<p>The ‘Biarch’ logical field is used on Windows to select the <code class="calibre2">INSTALL</code> option --force-biarch for this package.</p>
<p>The ‘BuildVignettes’ logical field can be set to a false value to stop <code class="calibre2">R CMD build</code> from attempting to build the vignettes, as well as preventing<a href="concept-index.html#FOOT7" id="DOCF7"><sup>7</sup></a> <code class="calibre2">R CMD check</code> from testing this. This should only be used exceptionally, for example if the PDFs include large figures which are not part of the package sources (and hence only in packages which do not have an Open Source license).</p>
<p>The ‘VignetteBuilder’ field names (in a comma-separated list) packages that provide an engine for building vignettes. These may include the current package, or ones listed in ‘Depends’, ‘Suggests’ or ‘Imports’. The <strong>utils</strong> package is always implicitly appended. See <a href="writing-package-vignettes.html#Non_002dSweave-vignettes">Non-Sweave vignettes</a> for details.</p>
<p>If the DESCRIPTION file is not entirely in ASCII it should contain an ‘Encoding’ field specifying an encoding. This is used as the encoding of the DESCRIPTION file itself and of the R and NAMESPACE files, and as the default encoding of .Rd files. The examples are assumed to be in this encoding when running <code class="calibre2">R CMD check</code>, and it is used for the encoding of the <code class="calibre2">CITATION</code> file. Only encoding names <code class="calibre2">latin1</code>, <code class="calibre2">latin2</code> and <code class="calibre2">UTF-8</code> are known to be portable. (Do not specify an encoding unless one is actually needed: doing so makes the package <em>less</em> portable. If a package has a specified encoding, you should run <code class="calibre2">R CMD build</code> etc in a locale using that encoding.)</p>
<p>The ‘NeedsCompilation’ field should be set to <code class="calibre2">&quot;yes&quot;</code> if the package contains code which to be compiled, otherwise <code class="calibre2">&quot;no&quot;</code> (when the package could be installed from source on any platform without additional tools). This is used by <code class="calibre2">install.packages(type = &quot;both&quot;)</code> in R &gt;= 2.15.2 on platforms where binary packages are the norm: it is normally set by <code class="calibre2">R CMD build</code> or the repository assuming compilation is required if and only if the package has a src directory.</p>
<p>The ‘OS_type’ field specifies the OS(es) for which the package is intended. If present, it should be one of <code class="calibre2">unix</code> or <code class="calibre2">windows</code>, and indicates that the package can only be installed on a platform with ‘.Platform&#36;OS.type’ having that value.</p>
<p>The ‘Type’ field specifies the type of the package: see <a href="creating-r-packages.html#Package-types">Package types</a>.</p>
<p>One can add subject classifications for the content of the package using the fields ‘Classification/ACM’ or ‘Classification/ACM-2012’ (using the Computing Classification System of the Association for Computing Machinery, <a href="http://www.acm.org/about/class/" class="uri">http://www.acm.org/about/class/</a>; the former refers to the 1998 version), ‘Classification/JEL’ (the Journal of Economic Literature Classification System, <a href="https://www.aeaweb.org/econlit/jelCodes.php" class="uri">https://www.aeaweb.org/econlit/jelCodes.php</a>, or ‘Classification/MSC’ or ‘Classification/MSC-2010’ (the Mathematics Subject Classification of the American Mathematical Society, <a href="http://www.ams.org/msc/" class="uri">http://www.ams.org/msc/</a>; the former refers to the 2000 version). The subject classifications should be comma-separated lists of the respective classification codes, e.g., ‘Classification/ACM: G.4, H.2.8, I.5.1’.</p>
<p>A ‘Language’ field can be used to indicate if the package documentation is not in English: this should be a comma-separated list of standard (not private use or grandfathered) IETF language tags as currently defined by RFC 5646 (<a href="https://tools.ietf.org/html/rfc5646" class="uri">https://tools.ietf.org/html/rfc5646</a>, see also <a href="https://en.wikipedia.org/wiki/IETF_language_tag" class="uri">https://en.wikipedia.org/wiki/IETF_language_tag</a>), i.e., use language subtags which in essence are 2-letter ISO 639-1 (<a href="https://en.wikipedia.org/wiki/ISO_639-1" class="uri">https://en.wikipedia.org/wiki/ISO_639-1</a>) or 3-letter ISO 639-3 (<a href="https://en.wikipedia.org/wiki/ISO_639-3" class="uri">https://en.wikipedia.org/wiki/ISO_639-3</a>) language codes.</p>
<p>An ‘RdMacros’ field can be used to hold a comma-separated list of packages from which the current package will import Rd macro definitions. These will be imported after the system macros, in the order listed in the ‘RdMacros’ field, before any macro definitions in the current package are loaded. Macro definitions in individual .Rd files in the man directory are loaded last, and are local to later parts of that file. In case of duplicates, the last loaded definition will be used<a href="concept-index.html#FOOT8" id="DOCF8"><sup>8</sup></a> Both <code class="calibre2">R CMD Rd2pdf</code> and <code class="calibre2">R CMD Rdconv</code> have an optional flag --RdMacros=pkglist. The option is also a comma-separated list of package names, and has priority over the value given in DESCRIPTION. Packages using Rd macros should depend on R 3.2.0 or later.</p>
<blockquote>
<p><strong>Note:</strong> There should be no ‘Built’ or ‘Packaged’ fields, as these are added by the package management tools.</p>
</blockquote>
<p>There is no restriction on the use of other fields not mentioned here (but using other capitalizations of these field names would cause confusion). Fields <code class="calibre2">Note</code>, <code class="calibre2">Contact</code> (for contacting the authors/developers<a href="concept-index.html#FOOT9" id="DOCF9"><sup>9</sup></a>) and <code class="calibre2">MailingList</code> are in common use. Some repositories (including CRAN and R-forge) add their own fields.</p>
<hr />
<p><a href="" id="Licensing"></a> <a href="" id="Licensing-1"></a></p>
<h4 id="licensing" class="subsection">1.1.2 Licensing</h4>
<p>Licensing for a package which might be distributed is an important but potentially complex subject.</p>
<p>It is very important that you include license information! Otherwise, it may not even be legally correct for others to distribute copies of the package, let alone use it.</p>
<p>The package management tools use the concept of ‘free or open source software’ (FOSS, e.g., <a href="https://en.wikipedia.org/wiki/FOSS" class="uri">https://en.wikipedia.org/wiki/FOSS</a>) licenses: the idea being that some users of R and its packages want to restrict themselves to such software. Others need to ensure that there are no restrictions stopping them using a package, e.g. forbidding commercial or military use. It is a central tenet of FOSS software that there are no restrictions on users nor usage.</p>
<p>Do not use the ‘License’ field for information on copyright holders: if needed, use a ‘Copyright’ field.</p>
<p>The mandatory ‘License’ field in the DESCRIPTION file should specify the license of the package in a standardized form. Alternatives are indicated <em>via</em> vertical bars. Individual specifications must be one of</p>
<ul>
<li><p>One of the “standard” short specifications</p>
<div class="example">
<pre class="example1"><code>GPL-2 GPL-3 LGPL-2 LGPL-2.1 LGPL-3 AGPL-3 Artistic-2.0
BSD_2_clause BSD_3_clause MIT</code></pre>
</div>
<p>as made available <em>via</em> <a href="https://www.R-project.org/Licenses/" class="uri">https://www.R-project.org/Licenses/</a> and contained in subdirectory share/licenses of the R source or home directory.</p></li>
<li><p>The names or abbreviations of other licenses contained in the license data base in file share/licenses/license.db in the R source or home directory, possibly (for versioned licenses) followed by a version restriction of the form ‘(op v)’ with ‘op’ one of the comparison operators ‘&lt;’, ‘&lt;=’, ‘&gt;’, ‘&gt;=’, ‘==’, or ‘!=’ and ‘v’ a numeric version specification (strings of non-negative integers separated by ‘.’), possibly combined <em>via</em> ‘,’ (see below for an example). For versioned licenses, one can also specify the name followed by the version, or combine an existing abbreviation and the version with a ‘-’.</p>
<p>Abbreviations <code class="calibre2">GPL</code> and <code class="calibre2">LGPL</code> are ambiguous and usually taken to mean any version of the license: but it is better not to use them.</p></li>
<li>One of the strings ‘file LICENSE’ or ‘file LICENCE’ referring to a file named LICENSE or LICENCE in the package (source and installation) top-level directory.</li>
<li>The string ‘Unlimited’, meaning that there are no restrictions on distribution or use other than those imposed by relevant laws (including copyright laws).</li>
</ul>
<p>If a package license <em>restricts</em> a base license (where permitted, e.g., using GPL-3 or AGPL-3 with an attribution clause), the additional terms should be placed in file LICENSE (or LICENCE), and the string ‘+ file LICENSE’ (or ‘+ file LICENCE’, respectively) should be appended to the corresponding individual license specification. Note that several commonly used licenses do not permit restrictions: this includes GPL-2 and hence any specification which includes it.</p>
<p>Examples of standardized specifications include</p>
<div class="example">
<pre class="example1"><code>License: GPL-2
License: LGPL (&gt;= 2.0, &lt; 3) | Mozilla Public License
License: GPL-2 | file LICENCE
License: GPL (&gt;= 2) | BSD_3_clause + file LICENSE
License: Artistic-2.0 | AGPL-3 + file LICENSE</code></pre>
</div>
<p>Please note in particular that “Public domain” is not a valid license, since it is not recognized in some jurisdictions.</p>
<p>Please ensure that the license you choose also covers any dependencies (including system dependencies) of your package: it is particularly important that any restrictions on the use of such dependencies are evident to people reading your DESCRIPTION file.</p>
<p>Fields ‘License_is_FOSS’ and ‘License_restricts_use’ may be added by repositories where information cannot be computed from the name of the license. ‘License_is_FOSS: yes’ is used for licenses which are known to be FOSS, and ‘License_restricts_use’ can have values ‘yes’ or ‘no’ if the LICENSE file is known to restrict users or usage, or known not to. These are used by, e.g., the <code class="calibre2">available.packages</code> filters.</p>
<p><a href="" id="index-LICENSE-file"></a> <a href="" id="index-LICENCE-file"></a></p>
<p>The optional file LICENSE/LICENCE contains a copy of the license of the package. To avoid any confusion only include such a file if it is referred to in the ‘License’ field of the DESCRIPTION file.</p>
<p>Whereas you should feel free to include a license file in your <em>source</em> distribution, please do not arrange to <em>install</em> yet another copy of the GNU COPYING or COPYING.LIB files but refer to the copies on <a href="https://www.R-project.org/Licenses/" class="uri">https://www.R-project.org/Licenses/</a> and included in the R distribution (in directory share/licenses). Since files named LICENSE or LICENCE <em>will</em> be installed, do not use these names for standard license files. To include comments about the licensing rather than the body of a license, use a file named something like LICENSE.note.</p>
<p>A few “standard” licenses are rather license templates which need additional information to be completed <em>via</em> ‘+ file LICENSE’.</p>
<hr />
<p><a href="" id="Package-Dependencies"></a> <a href="" id="Package-Dependencies-1"></a></p>
<h4 id="package-dependencies" class="subsection">1.1.3 Package Dependencies</h4>
<p>The ‘Depends’ field gives a comma-separated list of package names which this package depends on. Those packages will be attached before the current package when <code class="calibre2">library</code> or <code class="calibre2">require</code> is called. Each package name may be optionally followed by a comment in parentheses specifying a version requirement. The comment should contain a comparison operator, whitespace and a valid version number, e.g. ‘MASS (&gt;= 3.1-20)’.</p>
<p>The ‘Depends’ field can also specify a dependence on a certain version of R — e.g., if the package works only with R version 3.0.0 or later, include ‘R (&gt;= 3.0.0)’ in the ‘Depends’ field. You can also require a certain SVN revision for R-devel or R-patched, e.g. ‘R (&gt;= 2.14.0), R (&gt;= r56550)’ requires a version later than R-devel of late July 2011 (including released versions of 2.14.0).</p>
<p>It makes no sense to declare a dependence on <code class="calibre2">R</code> without a version specification, nor on the package <strong>base</strong>: this is an R package and package <strong>base</strong> is always available.</p>
<p>A package or ‘R’ can appear more than once in the ‘Depends’ field, for example to give upper and lower bounds on acceptable versions.</p>
<p>Both <code class="calibre2">library</code> and the R package checking facilities use this field: hence it is an error to use improper syntax or misuse the ‘Depends’ field for comments on other software that might be needed. The R <code class="calibre2">INSTALL</code> facilities check if the version of R used is recent enough for the package being installed, and the list of packages which is specified will be attached (after checking version requirements) before the current package.</p>
<p>The ‘Imports’ field lists packages whose namespaces are imported from (as specified in the NAMESPACE file) but which do not need to be attached. Namespaces accessed by the ‘::’ and ‘:::’ operators must be listed here, or in ‘Suggests’ or ‘Enhances’ (see below). Ideally this field will include all the standard packages that are used, and it is important to include S4-using packages (as their class definitions can change and the DESCRIPTION file is used to decide which packages to re-install when this happens). Packages declared in the ‘Depends’ field should not also be in the ‘Imports’ field. Version requirements can be specified and are checked when the namespace is loaded (since R &gt;= 3.0.0).</p>
<p>The ‘Suggests’ field uses the same syntax as ‘Depends’ and lists packages that are not necessarily needed. This includes packages used only in examples, tests or vignettes (see <a href="#Writing-package-vignettes">Writing package vignettes</a>), and packages loaded in the body of functions. E.g., suppose an example<a href="concept-index.html#FOOT10" id="DOCF10"><sup>10</sup></a> from package <strong>foo</strong> uses a dataset from package <strong>bar</strong>. Then it is not necessary to have <strong>bar</strong> use <strong>foo</strong> unless one wants to execute all the examples/tests/vignettes: it is useful to have <strong>bar</strong>, but not necessary. Version requirements can be specified but should be checked by the code which uses the package.</p>
<p>Finally, the ‘Enhances’ field lists packages “enhanced” by the package at hand, e.g., by providing methods for classes from these packages, or ways to handle objects from these packages (so several packages have ‘Enhances: chron’ because they can handle datetime objects from <a href="https://CRAN.R-project.org/package=chron"><strong>chron</strong></a> even though they prefer R’s native datetime functions). Version requirements can be specified, but are currently not used. Such packages cannot be required to check the package: any tests which use them must be conditional on the presence of the package. (If your tests use e.g. a dataset from another package it should be in ‘Suggests’ and not ‘Enhances’.)</p>
<p>The general rules are</p>
<ul>
<li>A package should be listed in only one of these fields.</li>
<li>Packages whose namespace only is needed to load the package using <code class="calibre2">library(pkgname)</code> should be listed in the ‘Imports’ field and not in the ‘Depends’ field. Packages listed in <code class="calibre2">imports</code> or <code class="calibre2">importFrom</code> directives in the NAMESPACE file should almost always be in ‘Imports’ and not ‘Depends’.</li>
<li>Packages that need to be attached to successfully load the package using <code class="calibre2">library(pkgname)</code> must be listed in the ‘Depends’ field.</li>
<li>All packages that are needed<a href="concept-index.html#FOOT11" id="DOCF11"><sup>11</sup></a> to successfully run <code class="calibre2">R CMD check</code> on the package must be listed in one of ‘Depends’ or ‘Suggests’ or ‘Imports’. Packages used to run examples or tests conditionally (e.g. <em>via</em> <code class="calibre2">if(require(pkgname))</code>) should be listed in ‘Suggests’ or ‘Enhances’. (This allows checkers to ensure that all the packages needed for a complete check are installed.)</li>
</ul>
<p>In particular, packages providing “only” data for examples or vignettes should be listed in ‘Suggests’ rather than ‘Depends’ in order to make lean installations possible.</p>
<p>Version dependencies in the ‘Depends’ and ‘Imports’ fields are used by <code class="calibre2">library</code> when it loads the package, and <code class="calibre2">install.packages</code> checks versions for the ‘Depends’, ‘Imports’ and (for <code class="calibre2">dependencies = TRUE</code>) ‘Suggests’ fields.</p>
<p>It is increasingly important that the information in these fields is complete and accurate: it is for example used to compute which packages depend on an updated package and which packages can safely be installed in parallel.</p>
<p>This scheme was developed before all packages had namespaces (R 2.14.0 in October 2011), and good practice changed once that was in place.</p>
<p>Field ‘Depends’ should nowadays be used rarely, only for packages which are intended to be put on the search path to make their facilities available to the end user (and not to the package itself): for example it makes sense that a user of package <a href="https://CRAN.R-project.org/package=latticeExtra"><strong>latticeExtra</strong></a> would want the functions of package <a href="https://CRAN.R-project.org/package=lattice"><strong>lattice</strong></a> made available.</p>
<p>Almost always packages mentioned in ‘Depends’ should also be imported from in the NAMESPACE file: this ensures that any needed parts of those packages are available when some other package imports the current package.</p>
<p>The ‘Imports’ field should not contain packages which are not imported from (<em>via</em> the NAMESPACE file or <code class="calibre2">::</code> or <code class="calibre2">:::</code> operators), as all the packages listed in that field need to be installed for the current package to be installed. (This is checked by <code class="calibre2">R CMD check</code>.)</p>
<p>R code in the package should call <code class="calibre2">library</code> or <code class="calibre2">require</code> only exceptionally. Such calls are never needed for packages listed in ‘Depends’ as they will already be on the search path. It used to be common practice to use <code class="calibre2">require</code> calls for packages listed in ‘Suggests’ in functions which used their functionality, but nowadays it is better to access such functionality <em>via</em> <code class="calibre2">::</code> calls.</p>
<p>A package that wishes to make use of header files in other packages needs to declare them as a comma-separated list in the field ‘LinkingTo’ in the DESCRIPTION file. For example</p>
<div class="example">
<pre class="example1"><code>LinkingTo: link1, link2</code></pre>
</div>
<p>The ‘LinkingTo’ field can have a version requirement which is checked at installation.</p>
<p>Specifying a package in ‘LinkingTo’ suffices if these are C++ headers containing source code or static linking is done at installation: the packages do not need to be (and usually should not be) listed in the ‘Depends’ or ‘Imports’ fields. This includes CRAN package <a href="https://CRAN.R-project.org/package=BH"><strong>BH</strong></a> and almost all users of <a href="https://CRAN.R-project.org/package=RcppArmadillo"><strong>RcppArmadillo</strong></a> and <a href="https://CRAN.R-project.org/package=RcppEigen"><strong>RcppEigen</strong></a>.</p>
<p>For another use of ‘LinkingTo’ see <a href="system-and-foreign-language-interfaces.html#Linking-to-native-routines-in-other-packages">Linking to native routines in other packages</a>.</p>
<p>The ‘Additional_repositories’ field is a comma-separated list of repository URLs where the packages named in the other fields may be found. It is currently used by <code class="calibre2">R CMD check</code> to check that the packages can be found, at least as source packages (which can be installed on any platform).</p>
<hr />
<p><a href="" id="Suggested-packages"></a> <a href="" id="Suggested-packages-1"></a></p>
<h4 id="suggested-packages" class="subsection">1.1.3.1 Suggested packages</h4>
<p>Note that someone wanting to run the examples/tests/vignettes may not have a suggested package available (and it may not even be possible to install it for that platform). The recommendation used to be to make their use conditional <em>via</em> <code class="calibre2">if(require(&quot;pkgname&quot;))</code>: this is OK if that conditioning is done in examples/tests/vignettes, although using <code class="calibre2">if(requireNamespace(&quot;pkgname&quot;))</code> is preferred, if possible.</p>
<p>However, using <code class="calibre2">require</code> for conditioning <em>in package code</em> is not good practice as it alters the search path for the rest of the session and relies on functions in that package not being masked by other <code class="calibre2">require</code> or <code class="calibre2">library</code> calls. It is better practice to use code like</p>
<div class="example">
<pre class="example1"><code>   if (requireNamespace(&quot;rgl&quot;, quietly = TRUE)) {
      rgl::plot3d(...)
   } else {
      ## do something else not involving rgl.
   }</code></pre>
</div>
<p>Note the use of <code class="calibre2">rgl::</code> as that object would not necessarily be visible (and if it is, it need not be the one from that namespace: <code class="calibre2">plot3d</code> occurs in several other packages). If the intention is to give an error if the suggested package is not available, simply use e.g. <code class="calibre2">rgl::plot3d</code>.</p>
<p>Note that the recommendation to use suggested packages conditionally in tests does also apply to packages used to manage test suites: a notorious example was <a href="https://CRAN.R-project.org/package=testthat"><strong>testthat</strong></a> which in version 1.0.0 contained illegal C++ code and hence could not be installed on standards-compliant platforms.</p>
<p>Some people have assumed that a ‘recommended’ package in ‘Suggests’ can safely be used unconditionally, but this is not so. (R can be installed without recommended packages, and which packages are ‘recommended’ may change.)</p>
<p>As noted above, packages in ‘Enhances’ <em>must</em> be used conditionally and hence objects within them should always be accessed <em>via</em> <code class="calibre2">::</code>.</p>
<hr />
<p><a href="" id="The-INDEX-file"></a> <a href="" id="The-INDEX-file-1"></a></p>
<h4 id="the-index-file" class="subsection">1.1.4 The INDEX file</h4>
<p><a href="" id="index-INDEX-file"></a></p>
<p>The optional file INDEX contains a line for each sufficiently interesting object in the package, giving its name and a description (functions such as print methods not usually called explicitly might not be included). Normally this file is missing and the corresponding information is automatically generated from the documentation sources (using <code class="calibre2">tools::Rdindex()</code>) when installing from source.</p>
<p>The file is part of the information given by <code class="calibre2">library(help = pkgname)</code>.</p>
<p>Rather than editing this file, it is preferable to put customized information about the package into an overview help page (see <a href="writing-r-documentation-files.html#Documenting-packages">Documenting packages</a>) and/or a vignette (see <a href="#Writing-package-vignettes">Writing package vignettes</a>).</p>
<hr />
<p><a href="" id="Package-subdirectories"></a> <a href="" id="Package-subdirectories-1"></a></p>
<h4 id="package-subdirectories" class="subsection">1.1.5 Package subdirectories</h4>
<p><a href="" id="index-Package-subdirectories"></a></p>
<p>The R subdirectory contains R code files, only. The code files to be installed must start with an ASCII (lower or upper case) letter or digit and have one of the extensions<a href="concept-index.html#FOOT12" id="DOCF12"><sup>12</sup></a> .R, .S, .q, .r, or .s. We recommend using .R, as this extension seems to be not used by any other software. It should be possible to read in the files using <code class="calibre2">source()</code>, so R objects must be created by assignments. Note that there need be no connection between the name of the file and the R objects created by it. Ideally, the R code files should only directly assign R objects and definitely should not call functions with side effects such as <code class="calibre2">require</code> and <code class="calibre2">options</code>. If computations are required to create objects these can use code ‘earlier’ in the package (see the ‘Collate’ field) plus functions in the ‘Depends’ packages provided that the objects created do not depend on those packages except <em>via</em> namespace imports.</p>
<p>Two exceptions are allowed: if the R subdirectory contains a file sysdata.rda (a saved image of one or more R objects: please use suitable compression as suggested by <code class="calibre2">tools::resaveRdaFiles</code>, and see also the ‘SysDataCompression’ DESCRIPTION field.) this will be lazy-loaded into the namespace environment – this is intended for system datasets that are not intended to be user-accessible <em>via</em> <code class="calibre2">data</code>. Also, files ending in ‘.in’ will be allowed in the R directory to allow a configure script to generate suitable files.</p>
<p>Only ASCII characters (and the control characters tab, formfeed, LF and CR) should be used in code files. Other characters are accepted in comments<a href="concept-index.html#FOOT13" id="DOCF13"><sup>13</sup></a>, but then the comments may not be readable in e.g. a UTF-8 locale. Non-ASCII characters in object names will normally<a href="concept-index.html#FOOT14" id="DOCF14"><sup>14</sup></a> fail when the package is installed. Any byte will be allowed in a quoted character string but <code class="calibre2">&#92;uxxxx</code> escapes should be used for non-ASCII characters. However, non-ASCII character strings may not be usable in some locales and may display incorrectly in others.</p>
<p><a href="" id="index-library_002edynam"></a></p>
<p>Various R functions in a package can be used to initialize and clean up. See <a href="writing-package-vignettes.html#Load-hooks">Load hooks</a>.</p>
<p>The man subdirectory should contain (only) documentation files for the objects in the package in <em>R documentation</em> (Rd) format. The documentation filenames must start with an ASCII (lower or upper case) letter or digit and have the extension .Rd (the default) or .rd. Further, the names must be valid in ‘file://’ URLs, which means<a href="concept-index.html#FOOT15" id="DOCF15"><sup>15</sup></a> they must be entirely ASCII and not contain ‘%’. See <a href="writing-r-documentation-files.html">Writing R documentation files</a>, for more information. Note that all user-level objects in a package should be documented; if a package pkg contains user-level objects which are for “internal” use only, it should provide a file pkg-internal.Rd which documents all such objects, and clearly states that these are not meant to be called by the user. See e.g. the sources for package <strong>grid</strong> in the R distribution. Note that packages which use internal objects extensively should not export those objects from their namespace, when they do not need to be documented (see <a href="creating-r-packages.html#Package-namespaces">Package namespaces</a>).</p>
<p>Having a man directory containing no documentation files may give an installation error.</p>
<p>The man subdirectory may contain a subdirectory named macros; this will contain source for user-defined Rd macros. (See <a href="writing-r-documentation-files.html#User_002ddefined-macros">User-defined macros</a>.) These use the Rd format, but may not contain anything but macro definitions, comments and whitespace.</p>
<p>The R and man subdirectories may contain OS-specific subdirectories named unix or windows.</p>
<p>The sources and headers for the compiled code are in src, plus optionally a file Makevars or Makefile. When a package is installed using <code class="calibre2">R CMD INSTALL</code>, <code class="calibre2">make</code> is used to control compilation and linking into a shared object for loading into R. There are default <code class="calibre2">make</code> variables and rules for this (determined when R is configured and recorded in R_HOME/etcR_ARCH/Makeconf), providing support for C, C++, FORTRAN 77, Fortran 9x<a href="concept-index.html#FOOT16" id="DOCF16"><sup>16</sup></a>, Objective C and Objective C++<a href="concept-index.html#FOOT17" id="DOCF17"><sup>17</sup></a> with associated extensions .c, .cc or .cpp, .f, .f90 or .f95, .m, and .mm, respectively. We recommend using .h for headers, also for C++<a href="concept-index.html#FOOT18" id="DOCF18"><sup>18</sup></a> or Fortran 9x include files. (Use of extension .C for C++ is no longer supported.) Files in the src directory should not be hidden (start with a dot), and hidden files will under some versions of R be ignored.</p>
<p>It is not portable (and may not be possible at all) to mix all these languages in a single package, and we do not support using both C++ and Fortran 9x. Because R itself uses it, we know that C and FORTRAN 77 can be used together and mixing C and C++ seems to be widely successful.</p>
<p>If your code needs to depend on the platform there are certain defines which can used in C or C++. On all Windows builds (even 64-bit ones) ‘_WIN32’ will be defined: on 64-bit Windows builds also ‘_WIN64’, and on macOS ‘__APPLE__’ is defined.<a href="concept-index.html#FOOT19" id="DOCF19"><sup>19</sup></a></p>
<p>The default rules can be tweaked by setting macros<a href="concept-index.html#FOOT20" id="DOCF20"><sup>20</sup></a> in a file src/Makevars (see <a href="#Using-Makevars">Using Makevars</a>). Note that this mechanism should be general enough to eliminate the need for a package-specific src/Makefile. If such a file is to be distributed, considerable care is needed to make it general enough to work on all R platforms. If it has any targets at all, it should have an appropriate first target named ‘all’ and a (possibly empty) target ‘clean’ which removes all files generated by running <code class="calibre2">make</code> (to be used by ‘R CMD INSTALL --clean’ and ‘R CMD INSTALL --preclean’). There are platform-specific file names on Windows: src/Makevars.win takes precedence over src/Makevars and src/Makefile.win must be used. Some <code class="calibre2">make</code> programs require makefiles to have a complete final line, including a newline.</p>
<p>A few packages use the src directory for purposes other than making a shared object (e.g. to create executables). Such packages should have files src/Makefile and src/Makefile.win (unless intended for only Unix-alikes or only Windows).</p>
<p>In very special cases packages may create binary files other than the shared objects/DLLs in the src directory. Such files will not be installed in a multi-architecture setting since <code class="calibre2">R CMD INSTALL --libs-only</code> is used to merge multiple sub-architectures and it only copies shared objects/DLLs. If a package wants to install other binaries (for example executable programs), it should provide an R script src/install.libs.R which will be run as part of the installation in the <code class="calibre2">src</code> build directory <em>instead of</em> copying the shared objects/DLLs. The script is run in a separate R environment containing the following variables: <code class="calibre2">R_PACKAGE_NAME</code> (the name of the package), <code class="calibre2">R_PACKAGE_SOURCE</code> (the path to the source directory of the package), <code class="calibre2">R_PACKAGE_DIR</code> (the path of the target installation directory of the package), <code class="calibre2">R_ARCH</code> (the arch-dependent part of the path, often empty), <code class="calibre2">SHLIB_EXT</code> (the extension of shared objects) and <code class="calibre2">WINDOWS</code> (<code class="calibre2">TRUE</code> on Windows, <code class="calibre2">FALSE</code> elsewhere). Something close to the default behavior could be replicated with the following src/install.libs.R file:</p>
<div class="example">
<pre class="example1"><code>files &lt;- Sys.glob(paste0(&quot;*&quot;, SHLIB_EXT))
dest &lt;- file.path(R_PACKAGE_DIR, paste0(&#39;libs&#39;, R_ARCH))
dir.create(dest, recursive = TRUE, showWarnings = FALSE)
file.copy(files, dest, overwrite = TRUE)
if(file.exists(&quot;symbols.rds&quot;))
    file.copy(&quot;symbols.rds&quot;, dest, overwrite = TRUE)</code></pre>
</div>
<p>On the other hand, executable programs could be installed along the lines of</p>
<div class="example">
<pre class="example1"><code>execs &lt;- c(&quot;one&quot;, &quot;two&quot;, &quot;three&quot;)
if(WINDOWS) execs &lt;- paste0(execs, &quot;.exe&quot;)
if ( any(file.exists(execs)) ) {
  dest &lt;- file.path(R_PACKAGE_DIR,  paste0(&#39;bin&#39;, R_ARCH))
  dir.create(dest, recursive = TRUE, showWarnings = FALSE)
  file.copy(execs, dest, overwrite = TRUE)
}</code></pre>
</div>
<p>Note the use of architecture-specific subdirectories of bin where needed.</p>
<p>The data subdirectory is for data files: See <a href="#Data-in-packages">Data in packages</a>.</p>
<p>The demo subdirectory is for R scripts (for running <em>via</em> <code class="calibre2">demo()</code>) that demonstrate some of the functionality of the package. Demos may be interactive and are not checked automatically, so if testing is desired use code in the tests directory to achieve this. The script files must start with a (lower or upper case) letter and have one of the extensions .R or .r. If present, the demo subdirectory should also have a 00Index file with one line for each demo, giving its name and a description separated by a tab or at least three spaces. (This index file is not generated automatically.) Note that a demo does not have a specified encoding and so should be an ASCII file (see <a href="creating-r-packages.html#Encoding-issues">Encoding issues</a>). Function <code class="calibre2">demo()</code> will use the package encoding if there is one, but this is mainly useful for non-ASCII comments.</p>
<p><a href="" id="index-_002eRinstignore-file"></a></p>
<p>The contents of the inst subdirectory will be copied recursively to the installation directory. Subdirectories of inst should not interfere with those used by R (currently, R, data, demo, exec, libs, man, help, html and Meta, and earlier versions used latex, R-ex). The copying of the inst happens after src is built so its Makefile can create files to be installed. To exclude files from being installed, one can specify a list of exclude patterns in file .Rinstignore in the top-level source directory. These patterns should be Perl-like regular expressions (see the help for <code class="calibre2">regexp</code> in R for the precise details), one per line, to be matched case-insensitively against the file and directory paths, e.g. doc/.*[.]png&#36; will exclude all PNG files in inst/doc based on the extension.</p>
<p>Note that with the exceptions of INDEX, LICENSE/LICENCE and NEWS, information files at the top level of the package will <em>not</em> be installed and so not be known to users of Windows and macOS compiled packages (and not seen by those who use <code class="calibre2">R CMD INSTALL</code> or <code class="calibre2">install.packages</code> on the tarball). So any information files you wish an end user to see should be included in inst. Note that if the named exceptions also occur in inst, the version in inst will be that seen in the installed package.</p>
<p><a href="" id="index-CITATION"></a> <a href="" id="index-citation"></a> <a href="" id="index-NEWS_002eRd"></a> <a href="" id="index-news"></a></p>
<p>Things you might like to add to inst are a CITATION file for use by the <code class="calibre2">citation</code> function, and a NEWS.Rd file for use by the <code class="calibre2">news</code> function. See its help page for the specific format restrictions of the NEWS.Rd file.</p>
<p><a href="" id="index-AUTHORS"></a> <a href="" id="index-COPYRIGHTS-1"></a></p>
<p>Another file sometimes needed in inst is AUTHORS or COPYRIGHTS to specify the authors or copyright holders when this is too complex to put in the DESCRIPTION file.</p>
<p>Subdirectory tests is for additional package-specific test code, similar to the specific tests that come with the R distribution. Test code can either be provided directly in a .R (or .r as from R 3.4.0) file, or <em>via</em> a .Rin file containing code which in turn creates the corresponding .R file (e.g., by collecting all function objects in the package and then calling them with the strangest arguments). The results of running a .R file are written to a .Rout file. If there is a corresponding<a href="concept-index.html#FOOT21" id="DOCF21"><sup>21</sup></a> .Rout.save file, these two are compared, with differences being reported but not causing an error. The directory tests is copied to the check area, and the tests are run with the copy as the working directory and with <code class="calibre2">R_LIBS</code> set to ensure that the copy of the package installed during testing will be found by <code class="calibre2">library(pkg_name)</code>. Note that the package-specific tests are run in a vanilla R session without setting the random-number seed, so tests which use random numbers will need to set the seed to obtain reproducible results (and it can be helpful to do so in all cases, to avoid occasional failures when tests are run).</p>
<p>If directory tests has a subdirectory Examples containing a file <code class="calibre2">pkg-Ex.Rout.save</code>, this is compared to the output file for running the examples when the latter are checked. Reference output should be produced without having the --timings option set (and note that --as-cran sets it).</p>
<p>Subdirectory exec could contain additional executable scripts the package needs, typically scripts for interpreters such as the shell, Perl, or Tcl. NB: only files (and not directories) under exec are installed (and those with names starting with a dot are ignored), and they are all marked as executable (mode <code class="calibre2">755</code>, moderated by ‘umask’) on POSIX platforms. Note too that this is not suitable for executable <em>programs</em> since some platforms (including Windows) support multiple architectures using the same installed package directory.</p>
<p>Subdirectory po is used for files related to <em>localization</em>: see <a href="writing-package-vignettes.html#Internationalization">Internationalization</a>.</p>
<p>Subdirectory tools is the preferred place for auxiliary files needed during configuration, and also for sources need to re-create scripts (e.g. M4 files for <code class="calibre2">autoconf</code>).</p>
<hr />
<p><a href="" id="Data-in-packages"></a> <a href="" id="Data-in-packages-1"></a></p>
<h4 id="data-in-packages" class="subsection">1.1.6 Data in packages</h4>
<p>The data subdirectory is for data files, either to be made available <em>via</em> lazy-loading or for loading using <code class="calibre2">data()</code>. (The choice is made by the ‘LazyData’ field in the DESCRIPTION file: the default is not to do so.) It should not be used for other data files needed by the package, and the convention has grown up to use directory inst/extdata for such files.</p>
<p>Data files can have one of three types as indicated by their extension: plain R code (.R or .r), tables (.tab, .txt, or .csv, see <code class="calibre2">?data</code> for the file formats, and note that .csv is <strong>not</strong> the standard<a href="concept-index.html#FOOT22" id="DOCF22"><sup>22</sup></a> CSV format), or <code class="calibre2">save()</code> images (.RData or .rda). The files should not be hidden (have names starting with a dot). Note that R code should be “self-sufficient” and not make use of extra functionality provided by the package, so that the data file can also be used without having to load the package or its namespace.</p>
<p>Images (extensions .RData<a href="concept-index.html#FOOT23" id="DOCF23"><sup>23</sup></a> or .rda) can contain references to the namespaces of packages that were used to create them. Preferably there should be no such references in data files, and in any case they should only be to packages listed in the <code class="calibre2">Depends</code> and <code class="calibre2">Imports</code> fields, as otherwise it may be impossible to install the package. To check for such references, load all the images into a vanilla R session, and look at the output of <code class="calibre2">loadedNamespaces()</code>.</p>
<p>If your data files are large and you are not using ‘LazyData’ you can speed up installation by providing a file datalist in the data subdirectory. This should have one line per topic that <code class="calibre2">data()</code> will find, in the format ‘foo’ if <code class="calibre2">data(foo)</code> provides ‘foo’, or ‘foo: bar bah’ if <code class="calibre2">data(foo)</code> provides ‘bar’ and ‘bah’. <code class="calibre2">R CMD build</code> will automatically add a datalist file to data directories of over 1Mb, using the function <code class="calibre2">tools::add_datalist</code>.</p>
<p>Tables (.tab, .txt, or .csv files) can be compressed by <code class="calibre2">gzip</code>, <code class="calibre2">bzip2</code> or <code class="calibre2">xz</code>, optionally with additional extension .gz, .bz2 or .xz.</p>
<p>If your package is to be distributed, do consider the resource implications of large datasets for your users: they can make packages very slow to download and use up unwelcome amounts of storage space, as well as taking many seconds to load. It is normally best to distribute large datasets as .rda images prepared by <code class="calibre2">save(, compress = TRUE)</code> (the default). Using <code class="calibre2">bzip2</code> or <code class="calibre2">xz</code> compression will usually reduce the size of both the package tarball and the installed package, in some cases by a factor of two or more.</p>
<p>Package <strong>tools</strong> has a couple of functions to help with data images: <code class="calibre2">checkRdaFiles</code> reports on the way the image was saved, and <code class="calibre2">resaveRdaFiles</code> will re-save with a different type of compression, including choosing the best type for that particular image.</p>
<p>Some packages using ‘LazyData’ will benefit from using a form of compression other than <code class="calibre2">gzip</code> in the installed lazy-loading database. This can be selected by the --data-compress option to <code class="calibre2">R CMD INSTALL</code> or by using the ‘LazyDataCompression’ field in the DESCRIPTION file. Useful values are <code class="calibre2">bzip2</code>, <code class="calibre2">xz</code> and the default, <code class="calibre2">gzip</code>. The only way to discover which is best is to try them all and look at the size of the pkgname/data/Rdata.rdb file.</p>
<p>Lazy-loading is not supported for very large datasets (those which when serialized exceed 2GB, the limit for the format on 32-bit platforms).</p>
<p>The analogue for sysdata.rda is field ‘SysDataCompression’: the default is <code class="calibre2">xz</code> for files bigger than 1MB otherwise <code class="calibre2">gzip</code>.</p>
<hr />
<p><a href="" id="Non_002dR-scripts-in-packages"></a> <a href="" id="Non_002dR-scripts-in-packages-1"></a></p>
<h4 id="non-r-scripts-in-packages" class="subsection">1.1.7 Non-R scripts in packages</h4>
<p>Code which needs to be compiled (C, C++, FORTRAN, Fortran 95 …) is included in the src subdirectory and discussed elsewhere in this document.</p>
<p>Subdirectory exec could be used for scripts for interpreters such as the shell, BUGS, JavaScript, Matlab, Perl, php (<a href="https://CRAN.R-project.org/package=amap"><strong>amap</strong></a>), Python or Tcl (<a href="https://CRAN.R-project.org/package=Simile"><strong>Simile</strong></a>), or even R. However, it seems more common to use the inst directory, for example WriteXLS/inst/Perl, NMF/inst/m-files, RnavGraph/inst/tcl, RProtoBuf/inst/python and emdbook/inst/BUGS and gridSVG/inst/js.</p>
<p>Java code is a special case: except for very small programs, .java files should be byte-compiled (to a .class file) and distributed as part of a .jar file: the conventional location for the .jar file(s) is inst/java. It is desirable (and required under an Open Source license) to make the Java source files available: this is best done in a top-level java directory in the package—the source files should not be installed.</p>
<p>If your package requires one of these interpreters or an extension then this should be declared in the ‘SystemRequirements’ field of its DESCRIPTION file. (Users of Java most often do so <em>via</em> <a href="https://CRAN.R-project.org/package=rJava"><strong>rJava</strong></a>, when depending on/importing that suffices.)</p>
<p>Windows and Mac users should be aware that the Tcl extensions ‘BWidget’ and ‘Tktable’ which are currently included with the R for Windows and in the macOS installers <em>are</em> extensions and do need to be declared for users of other platforms (and that ‘Tktable’ is less widely available than it used to be, including not in the main repositories for major Linux distributions).</p>
<p>‘BWidget’ needs to be installed by the user on other OSes. This is fairly easy to do: first find the Tcl/Tk search path:</p>
<div class="example">
<pre class="example1"><code>library(tcltk)
strsplit(tclvalue(&#39;auto_path&#39;), &quot; &quot;)[[1]]</code></pre>
</div>
<p>then download the sources from <a href="http://sourceforge.net/projects/tcllib/files/BWidget/" class="uri">http://sourceforge.net/projects/tcllib/files/BWidget/</a> and at the command line run something like</p>
<div class="example">
<pre class="example1"><code>tar xf bwidget-1.9.8.tar.gz
sudo mv bwidget-1.9.8 /usr/local/lib</code></pre>
</div>
<p>substituting a location on the Tcl/Tk search path for /usr/local/lib if needed.</p>
<hr />
<p><a href="" id="Specifying-URLs"></a> <a href="" id="Specifying-URLs-1"></a></p>
<h4 id="specifying-urls" class="subsection">1.1.8 Specifying URLs</h4>
<p>URLs in many places in the package documentation will be converted to clickable hyperlinks in at least some of their renderings. So care is needed that their forms are correct and portable.</p>
<p>The full URL should be given, including the scheme (often ‘http://’ or ‘https://’) and a final ‘/’ for references to directories.</p>
<p>Spaces in URLs are not portable and how they are handled does vary by HTTP server and by client. There should be no space in the host part of an ‘http://’ URL, and spaces in the remainder should be encoded, with each space replaced by ‘%20’.</p>
<p>Other characters may benefit from being encoded: see the help on <code class="calibre2">URLencode()</code>.</p>
<p>The canonical URL for a CRAN package is</p>
<div class="example">
<pre class="example1"><code>https://cran.r-project.org/package=pkgname</code></pre>
</div>
<p>and not a version starting ‘http://cran.r-project.org/web/packages/pkgname’.</p>
<hr />
<p><a href="" id="Configure-and-cleanup"></a> <a href="" id="Configure-and-cleanup-1"></a></p>
<h3 id="configure-and-cleanup" class="section">1.2 Configure and cleanup</h3>
<p>Note that most of this section is specific to Unix-alikes: see the comments later on about the Windows port of R.</p>
<p>If your package needs some system-dependent configuration before installation you can include an executable (Bourne<a href="concept-index.html#FOOT24" id="DOCF24"><sup>24</sup></a>) shell script configure in your package which (if present) is executed by <code class="calibre2">R CMD INSTALL</code> before any other action is performed. This can be a script created by the Autoconf mechanism, but may also be a script written by yourself. Use this to detect if any nonstandard libraries are present such that corresponding code in the package can be disabled at install time rather than giving error messages when the package is compiled or used. To summarize, the full power of Autoconf is available for your extension package (including variable substitution, searching for libraries, etc.).</p>
<p>Under a Unix-alike only, an executable (Bourne shell) script cleanup is executed as the last thing by <code class="calibre2">R CMD INSTALL</code> if option --clean was given, and by <code class="calibre2">R CMD build</code> when preparing the package for building from its source.</p>
<p>As an example consider we want to use functionality provided by a (C or FORTRAN) library <code class="calibre2">foo</code>. Using Autoconf, we can create a configure script which checks for the library, sets variable <code class="calibre2">HAVE_FOO</code> to <code class="calibre2">TRUE</code> if it was found and to <code class="calibre2">FALSE</code> otherwise, and then substitutes this value into output files (by replacing instances of ‘@HAVE_FOO@’ in input files with the value of <code class="calibre2">HAVE_FOO</code>). For example, if a function named <code class="calibre2">bar</code> is to be made available by linking against library <code class="calibre2">foo</code> (i.e., using -lfoo), one could use</p>
<div class="example">
<pre class="example1"><code>AC_CHECK_LIB(foo, fun, [HAVE_FOO=TRUE], [HAVE_FOO=FALSE])
AC_SUBST(HAVE_FOO)
......
AC_CONFIG_FILES([foo.R])
AC_OUTPUT</code></pre>
</div>
<p>in configure.ac (assuming Autoconf 2.50 or later).</p>
<p>The definition of the respective R function in foo.R.in could be</p>
<div class="example">
<pre class="example1"><code>foo &lt;- function(x) {
    if(!@HAVE_FOO@)
      stop(&quot;Sorry, library ‘foo’ is not available&quot;)
    ...</code></pre>
</div>
<p>From this file <code class="calibre2">configure</code> creates the actual R source file foo.R looking like</p>
<div class="example">
<pre class="example1"><code>foo &lt;- function(x) {
    if(!FALSE)
      stop(&quot;Sorry, library ‘foo’ is not available&quot;)
    ...</code></pre>
</div>
<p>if library <code class="calibre2">foo</code> was not found (with the desired functionality). In this case, the above R code effectively disables the function.</p>
<p>One could also use different file fragments for available and missing functionality, respectively.</p>
<p>You will very likely need to ensure that the same C compiler and compiler flags are used in the configure tests as when compiling R or your package. Under a Unix-alike, you can achieve this by including the following fragment early in configure.ac (<em>before</em> calling <code class="calibre2">AC_PROG_CC</code>)</p>
<div class="example">
<pre class="example1"><code>: &#36;{R_HOME=`R RHOME`}
if test -z &quot;&#36;{R_HOME}&quot;; then
  echo &quot;could not determine R_HOME&quot;
  exit 1
fi
CC=`&quot;&#36;{R_HOME}/bin/R&quot; CMD config CC`
CFLAGS=`&quot;&#36;{R_HOME}/bin/R&quot; CMD config CFLAGS`
CPPFLAGS=`&quot;&#36;{R_HOME}/bin/R&quot; CMD config CPPFLAGS`</code></pre>
</div>
<p>(Using ‘&#36;{R_HOME}/bin/R’ rather than just ‘R’ is necessary in order to use the correct version of R when running the script as part of <code class="calibre2">R CMD INSTALL</code>, and the quotes since ‘&#36;{R_HOME}’ might contain spaces.)</p>
<p>If your code does load checks then you may also need</p>
<div class="example">
<pre class="example1"><code>LDFLAGS=`&quot;&#36;{R_HOME}/bin/R&quot; CMD config LDFLAGS`</code></pre>
</div>
<p>and packages written with C++ need to pick up the details for the C++ compiler and switch the current language to C++ by something like</p>
<div class="example">
<pre class="example1"><code>CXX=`&quot;&#36;{R_HOME}/bin/R&quot; CMD config CXX`
CXXFLAGS=`&quot;&#36;{R_HOME}/bin/R&quot; CMD config CXXFLAGS`
AC_LANG(C++)</code></pre>
</div>
<p>The latter is important, as for example C headers may not be available to C++ programs or may not be written to avoid C++ name-mangling.</p>
<p><a href="" id="index-R-CMD-config"></a></p>
<p>You can use <code class="calibre2">R CMD config</code> for getting the value of the basic configuration variables, and also the header and library flags necessary for linking a front-end executable program against R, see R CMD config --help for details.</p>
<p>To check for an external BLAS library using the <code class="calibre2">ACX_BLAS</code> macro from the official Autoconf Macro Archive, one can simply do</p>
<div class="example">
<pre class="example1"><code>F77=`&quot;&#36;{R_HOME}/bin/R&quot; CMD config F77`
AC_PROG_F77
FLIBS=`&quot;&#36;{R_HOME}/bin/R&quot; CMD config FLIBS`
ACX_BLAS([], AC_MSG_ERROR([could not find your BLAS library], 1))</code></pre>
</div>
<p>Note that <code class="calibre2">FLIBS</code> as determined by R must be used to ensure that FORTRAN 77 code works on all R platforms. Calls to the Autoconf macro <code class="calibre2">AC_F77_LIBRARY_LDFLAGS</code>, which would overwrite <code class="calibre2">FLIBS</code>, must not be used (and hence e.g. removed from <code class="calibre2">ACX_BLAS</code>). (Recent versions of Autoconf in fact allow an already set <code class="calibre2">FLIBS</code> to override the test for the FORTRAN linker flags.)</p>
<p><strong>N.B.</strong>: If the <code class="calibre2">configure</code> script creates files, e.g. src/Makevars, you do need a <code class="calibre2">cleanup</code> script to remove them. Otherwise <code class="calibre2">R CMD build</code> may ship the files that are created. For example, package <a href="https://CRAN.R-project.org/package=RODBC"><strong>RODBC</strong></a> has</p>
<div class="example">
<pre class="example1"><code>#!/bin/sh

rm -f config.* src/Makevars src/config.h</code></pre>
</div>
<p>As this example shows, <code class="calibre2">configure</code> often creates working files such as config.log.</p>
<p>If your configure script needs auxiliary files, it is recommended that you ship them in a tools directory (as R itself does).</p>
<p>You should bear in mind that the configure script will not be used on Windows systems. If your package is to be made publicly available, please give enough information for a user on a non-Unix-alike platform to configure it manually, or provide a configure.win script to be used on that platform. (Optionally, there can be a cleanup.win script. Both should be shell scripts to be executed by <code class="calibre2">ash</code>, which is a minimal version of Bourne-style <code class="calibre2">sh</code>.) When configure.win is run the environment variables <code class="calibre2">R_HOME</code> (which uses ‘/’ as the file separator), <code class="calibre2">R_ARCH</code> and Use <code class="calibre2">R_ARCH_BIN</code> will be set. Use <code class="calibre2">R_ARCH</code> to decide if this is a 64-bit build (its value there is ‘/x64’) and to install DLLs to the correct place (&#36;{R_HOME}/libs&#36;{R_ARCH}). Use <code class="calibre2">R_ARCH_BIN</code> to find the correct place under the bin directory, e.g. &#36;{R_HOME}/bin&#36;{R_ARCH_BIN}/Rscript.exe.</p>
<p>In some rare circumstances, the configuration and cleanup scripts need to know the location into which the package is being installed. An example of this is a package that uses C code and creates two shared object/DLLs. Usually, the object that is dynamically loaded by R is linked against the second, dependent, object. On some systems, we can add the location of this dependent object to the object that is dynamically loaded by R. This means that each user does not have to set the value of the <code class="calibre2">LD_LIBRARY_PATH</code> (or equivalent) environment variable, but that the secondary object is automatically resolved. Another example is when a package installs support files that are required at run time, and their location is substituted into an R data structure at installation time. <a href="" id="index-R_005fLIBRARY_005fDIR"></a> <a href="" id="index-R_005fPACKAGE_005fDIR"></a> <a href="" id="index-R_005fPACKAGE_005fNAME"></a> The names of the top-level library directory (i.e., specifiable <em>via</em> the ‘-l’ argument) and the directory of the package itself are made available to the installation scripts <em>via</em> the two shell/environment variables <code class="calibre2">R_LIBRARY_DIR</code> and <code class="calibre2">R_PACKAGE_DIR</code>. Additionally, the name of the package (e.g. ‘survival’ or ‘MASS’) being installed is available from the environment variable <code class="calibre2">R_PACKAGE_NAME</code>. (Currently the value of <code class="calibre2">R_PACKAGE_DIR</code> is always <code class="calibre2">&#36;{R_LIBRARY_DIR}/&#36;{R_PACKAGE_NAME}</code>, but this used not to be the case when versioned installs were allowed. Its main use is in configure.win scripts for the installation path of external software’s DLLs.) Note that the value of <code class="calibre2">R_PACKAGE_DIR</code> may contain spaces and other shell-unfriendly characters, and so should be quoted in makefiles and configure scripts.</p>
<p>One of the more tricky tasks can be to find the headers and libraries of external software. One tool which is increasingly available on Unix-alikes (but not by default on macOS) to do this is <code class="calibre2">pkg-config</code>. The configure script will need to test for the presence of the command itself (see for example package <a href="https://CRAN.R-project.org/package=Cairo"><strong>Cairo</strong></a>), and if present it can be asked if the software is installed, of a suitable version and for compilation/linking flags by e.g.</p>
<div class="example">
<pre class="example1"><code>&#36; pkg-config --exists ‘QtCore &gt;= 4.0.0’  # check the status
&#36; pkg-config --modversion QtCore
4.7.1
&#36; pkg-config --cflags QtCore
-DQT_SHARED -I/usr/include/QtCore
&#36; pkg-config --libs QtCore
-lQtCore</code></pre>
</div>
<p>Note that <code class="calibre2">pkg-config --libs</code> gives the information required to link against the default version of that library (usually the dynamic one), and <code class="calibre2">pkg-config --static</code> is needed if the static library is to be used.</p>
<p>Sometimes the name by which the software is known to <code class="calibre2">pkg-config</code> is not what one might expect (e.g. ‘gtk+-2.0’ even for 2.22). To get a complete list use</p>
<div class="example">
<pre class="example1"><code>pkg-config --list-all | sort</code></pre>
</div>
<hr />
<p><a href="" id="Using-Makevars"></a> <a href="" id="Using-Makevars-1"></a></p>
<h4 id="using-makevars" class="subsection">1.2.1 Using Makevars</h4>
<p>Sometimes writing your own configure script can be avoided by supplying a file Makevars: also one of the most common uses of a configure script is to make Makevars from Makevars.in.</p>
<p>A Makevars file is a makefile and is used as one of several makefiles by <code class="calibre2">R CMD SHLIB</code> (which is called by <code class="calibre2">R CMD INSTALL</code> to compile code in the src directory). It should be written if at all possible in a portable style, in particular (except for Makevars.win) without the use of GNU extensions.</p>
<p>The most common use of a Makevars file is to set additional preprocessor options (for example include paths) for C/C++ files <em>via</em> <code class="calibre2">PKG_CPPFLAGS</code>, and additional compiler flags by setting <code class="calibre2">PKG_CFLAGS</code>, <code class="calibre2">PKG_CXXFLAGS</code>, <code class="calibre2">PKG_FFLAGS</code> or <code class="calibre2">PKG_FCFLAGS</code>, for C, C++, FORTRAN or Fortran 9x respectively (see <a href="system-and-foreign-language-interfaces.html#Creating-shared-objects">Creating shared objects</a>).</p>
<p><strong>N.B.</strong>: Include paths are preprocessor options, not compiler options, and <strong>must</strong> be set in <code class="calibre2">PKG_CPPFLAGS</code> as otherwise platform-specific paths (e.g. ‘-I/usr/local/include’) will take precedence.</p>
<p>Makevars can also be used to set flags for the linker, for example ‘-L’ and ‘-l’ options, <em>via</em> <code class="calibre2">PKG_LIBS</code>.</p>
<p>When writing a Makevars file for a package you intend to distribute, take care to ensure that it is not specific to your compiler: flags such as -O2 -Wall -pedantic (and all other -W flags: for the Oracle compilers these are used to pass arguments to compiler phases) are all specific to GCC.</p>
<p>Also, do not set variables such as <code class="calibre2">CPPFLAGS</code>, <code class="calibre2">CFLAGS</code> etc.: these should be settable by users (sites) through appropriate personal (site-wide) Makevars files.</p>
<p>There are some macros<a href="concept-index.html#FOOT25" id="DOCF25"><sup>25</sup></a> which are set whilst configuring the building of R itself and are stored in R_HOME/etcR_ARCH/Makeconf. That makefile is included as a Makefile <em>after</em> Makevars[.win], and the macros it defines can be used in macro assignments and make command lines in the latter. These include</p>
<dl>
<dt><code class="calibre2">FLIBS</code></dt>
<dd><p><a href="" id="index-FLIBS"></a></p>
<p>A macro containing the set of libraries need to link FORTRAN code. This may need to be included in <code class="calibre2">PKG_LIBS</code>: it will normally be included automatically if the package contains FORTRAN source files.</p>
</dd>
<dt><code class="calibre2">BLAS_LIBS</code></dt>
<dd><p><a href="" id="index-BLAS_005fLIBS"></a></p>
<p>A macro containing the BLAS libraries used when building R. This may need to be included in <code class="calibre2">PKG_LIBS</code>. Beware that if it is empty then the R executable will contain all the double-precision and double-complex BLAS routines, but no single-precision nor complex routines. If <code class="calibre2">BLAS_LIBS</code> is included, then <code class="calibre2">FLIBS</code> also needs to be<a href="concept-index.html#FOOT26" id="DOCF26"><sup>26</sup></a> included following it, as most BLAS libraries are written at least partially in FORTRAN.</p>
</dd>
<dt><code class="calibre2">LAPACK_LIBS</code></dt>
<dd><p><a href="" id="index-LAPACK_005fLIBS"></a></p>
<p>A macro containing the LAPACK libraries (and paths where appropriate) used when building R. This may need to be included in <code class="calibre2">PKG_LIBS</code>. It may point to a dynamic library <code class="calibre2">libRlapack</code> which contains the main double-precision LAPACK routines as well as those double-complex LAPACK routines needed to build R, or it may point to an external LAPACK library, or may be empty if an external BLAS library also contains LAPACK.</p>
<p>[<code class="calibre2">libRlapack</code> includes all the double-precision LAPACK routines which were current in 2003: a list of which routines are included is in file src/modules/lapack/README. Note that an external LAPACK/BLAS library need not do so, as some were ‘deprecated’ (and not compiled by default) in LAPACK 3.6.0 in late 2015.]</p>
<p>For portability, the macros <code class="calibre2">BLAS_LIBS</code> and <code class="calibre2">FLIBS</code> should always be included <em>after</em> <code class="calibre2">LAPACK_LIBS</code> (and in that order).</p>
</dd>
<dt><code class="calibre2">SAFE_FFLAGS</code></dt>
<dd><p><a href="" id="index-SAFE_005fFFLAGS"></a></p>
<p>A macro containing flags which are needed to circumvent over-optimization of FORTRAN code: it is typically ‘-g -O2 -ffloat-store’ on ‘ix86’ platforms using <code class="calibre2">gfortran</code>. Note that this is <strong>not</strong> an additional flag to be used as part of <code class="calibre2">PKG_FFLAGS</code>, but a replacement for <code class="calibre2">FFLAGS</code>, and that it is intended for the FORTRAN 77 compiler ‘F77’ and not necessarily for the Fortran 90/95 compiler ‘FC’. See the example later in this section.</p>
</dd>
</dl>
<p><a href="" id="index-OBJECTS"></a></p>
<p>Setting certain macros in Makevars will prevent <code class="calibre2">R CMD SHLIB</code> setting them: in particular if Makevars sets ‘OBJECTS’ it will not be set on the <code class="calibre2">make</code> command line. This can be useful in conjunction with implicit rules to allow other types of source code to be compiled and included in the shared object. It can also be used to control the set of files which are compiled, either by excluding some files in src or including some files in subdirectories. For example</p>
<div class="example">
<pre class="example1"><code>OBJECTS = 4dfp/endianio.o 4dfp/Getifh.o R4dfp-object.o</code></pre>
</div>
<p>Note that Makevars should not normally contain targets, as it is included before the default makefile and <code class="calibre2">make</code> will call the first target, intended to be <code class="calibre2">all</code> in the default makefile. If you really need to circumvent that, use a suitable (phony) target <code class="calibre2">all</code> before any actual targets in Makevars.[win]: for example package <a href="https://CRAN.R-project.org/package=fastICA"><strong>fastICA</strong></a> used to have</p>
<div class="example">
<pre class="example1"><code>PKG_LIBS = @BLAS_LIBS@

SLAMC_FFLAGS=&#36;(R_XTRA_FFLAGS) &#36;(FPICFLAGS) &#36;(SHLIB_FFLAGS) &#36;(SAFE_FFLAGS)

all: &#36;(SHLIB)

slamc.o: slamc.f
        &#36;(F77) &#36;(SLAMC_FFLAGS) -c -o slamc.o slamc.f</code></pre>
</div>
<p>needed to ensure that the LAPACK routines find some constants without infinite looping. The Windows equivalent was</p>
<div class="example">
<pre class="example1"><code>all: &#36;(SHLIB)

slamc.o: slamc.f
        &#36;(F77) &#36;(SAFE_FFLAGS) -c -o slamc.o slamc.f</code></pre>
</div>
<p>(since the other macros are all empty on that platform, and R’s internal BLAS was not used). Note that the first target in Makevars will be called, but for back-compatibility it is best named <code class="calibre2">all</code>.</p>
<p>If you want to create and then link to a library, say using code in a subdirectory, use something like</p>
<div class="example">
<pre class="example1"><code>.PHONY: all mylibs

all: &#36;(SHLIB)
&#36;(SHLIB): mylibs

mylibs:
        (cd subdir; &#36;(MAKE))</code></pre>
</div>
<p>Be careful to create all the necessary dependencies, as there is no guarantee that the dependencies of <code class="calibre2">all</code> will be run in a particular order (and some of the CRAN build machines use multiple CPUs and parallel makes). In particular,</p>
<div class="example">
<pre class="example1"><code>all: mylibs</code></pre>
</div>
<p>does <strong>not</strong> suffice.</p>
<p>Note that on Windows it is required that Makevars[.win] does create a DLL: this is needed as it is the only reliable way to ensure that building a DLL succeeded. If you want to use the src directory for some purpose other than building a DLL, use a Makefile.win file.</p>
<p>It is sometimes useful to have a target ‘clean’ in Makevars or Makevars.win: this will be used by <code class="calibre2">R CMD build</code> to clean up (a copy of) the package sources. When it is run by <code class="calibre2">build</code> it will have fewer macros set, in particular not <code class="calibre2">&#36;(SHLIB)</code>, nor <code class="calibre2">&#36;(OBJECTS)</code> unless set in the file itself. It would also be possible to add tasks to the target ‘shlib-clean’ which is run by <code class="calibre2">R CMD INSTALL</code> and <code class="calibre2">R CMD SHLIB</code> with options --clean and --preclean.</p>
<p>If you want to run R code in Makevars, e.g. to find configuration information, please do ensure that you use the correct copy of <code class="calibre2">R</code> or <code class="calibre2">Rscript</code>: there might not be one in the path at all, or it might be the wrong version or architecture. The correct way to do this is <em>via</em></p>
<div class="example">
<pre class="example1"><code>&quot;&#36;(R_HOME)/bin&#36;(R_ARCH_BIN)/Rscript&quot; filename
&quot;&#36;(R_HOME)/bin&#36;(R_ARCH_BIN)/Rscript&quot; -e ‘R expression’</code></pre>
</div>
<p>where <code class="calibre2">&#36;(R_ARCH_BIN)</code> is only needed currently on Windows.</p>
<p>Environment or make variables can be used to select different macros for 32- and 64-bit code, for example (GNU <code class="calibre2">make</code> syntax, allowed on Windows)</p>
<div class="example">
<pre class="example1"><code>ifeq &quot;&#36;(WIN)&quot; &quot;64&quot;
PKG_LIBS = value for 64-bit Windows
else
PKG_LIBS = value for 32-bit Windows
endif</code></pre>
</div>
<p>On Windows there is normally a choice between linking to an import library or directly to a DLL. Where possible, the latter is much more reliable: import libraries are tied to a specific toolchain, and in particular on 64-bit Windows two different conventions have been commonly used. So for example instead of</p>
<div class="example">
<pre class="example1"><code>PKG_LIBS = -L&#36;(XML_DIR)/lib -lxml2</code></pre>
</div>
<p>one can use</p>
<div class="example">
<pre class="example1"><code>PKG_LIBS = -L&#36;(XML_DIR)/bin -lxml2</code></pre>
</div>
<p>since on Windows <code class="calibre2">-lxxx</code> will look in turn for</p>
<div class="example">
<pre class="example1"><code>libxxx.dll.a
xxx.dll.a
libxxx.a
xxx.lib
libxxx.dll
xxx.dll</code></pre>
</div>
<p>where the first and second are conventionally import libraries, the third and fourth often static libraries (with <code class="calibre2">.lib</code> intended for Visual C++), but might be import libraries. See for example <a href="https://sourceware.org/binutils/docs-2.20/ld/WIN32.html#WIN32" class="uri">https://sourceware.org/binutils/docs-2.20/ld/WIN32.html#WIN32</a>.</p>
<p>The fly in the ointment is that the DLL might not be named libxxx.dll, and in fact on 32-bit Windows there is a libxml2.dll whereas on one build for 64-bit Windows the DLL is called libxml2-2.dll. Using import libraries can cover over these differences but can cause equal difficulties.</p>
<p>If static libraries are available they can save a lot of problems with run-time finding of DLLs, especially when binary packages are to be distributed and even more when these support both architectures. Where using DLLs is unavoidable we normally arrange (<em>via</em> configure.win) to ship them in the same directory as the package DLL.</p>
<hr />
<p><a href="" id="OpenMP-support"></a> <a href="" id="OpenMP-support-1"></a></p>
<h4 id="openmp-support" class="subsection">1.2.1.1 OpenMP support</h4>
<p><a href="" id="index-OpenMP"></a></p>
<p>There is some support for packages which wish to use OpenMP<a href="concept-index.html#FOOT27" id="DOCF27"><sup>27</sup></a>. The <code class="calibre2">make</code> macros</p>
<div class="example">
<pre class="example1"><code>SHLIB_OPENMP_CFLAGS
SHLIB_OPENMP_CXXFLAGS
SHLIB_OPENMP_FCFLAGS
SHLIB_OPENMP_FFLAGS</code></pre>
</div>
<p>are available for use in src/Makevars or src/Makevars.win. Include the appropriate macro in <code class="calibre2">PKG_CFLAGS</code>, <code class="calibre2">PKG_CPPFLAGS</code> and so on, and also in <code class="calibre2">PKG_LIBS</code>. C/C++ code that needs to be conditioned on the use of OpenMP can be used inside <code class="calibre2">#ifdef _OPENMP</code>: note that some toolchains used for R (including that of macOS and some others using <code class="calibre2">clang</code><a href="concept-index.html#FOOT28" id="DOCF28"><sup>28</sup></a>) have no OpenMP support at all, not even omp.h.</p>
<p>For example, a package with C code written for OpenMP should have in src/Makevars the lines</p>
<div class="example">
<pre class="example1"><code>PKG_CFLAGS = &#36;(SHLIB_OPENMP_CFLAGS)
PKG_LIBS = &#36;(SHLIB_OPENMP_CFLAGS)</code></pre>
</div>
<p>Note that the macro <code class="calibre2">SHLIB_OPENMP_CXXFLAGS</code> applies to the default C++ compiler and not necessarily to the C++11/14/17 compiler: users of the latter should do their own <code class="calibre2">configure</code> checks (an example is available in CRAN package <a href="https://CRAN.R-project.org/package=ARTP2"><strong>ARTP2</strong></a>).</p>
<p>Some care is needed when compilers are from different families which may use different OpenMP runtimes (e.g. <code class="calibre2">clang</code> <em>vs</em> GCC including <code class="calibre2">gfortran</code>, although it is currently possible to use the <code class="calibre2">clang</code> runtime with GCC but not <em>vice versa</em>). For a package with Fortran 77 code using OpenMP the appropriate lines are</p>
<div class="example">
<pre class="example1"><code>PKG_FFLAGS = &#36;(SHLIB_OPENMP_FFLAGS)
PKG_LIBS = &#36;(SHLIB_OPENMP_CFLAGS)</code></pre>
</div>
<p>as the C compiler will be used to link the package code (and there is no guarantee that this will work everywhere). (This does not apply to Fortran 9x code, where <code class="calibre2">SHLIB_OPENMP_FCFLAGS</code> should be used in both <code class="calibre2">PKG_FCFLAGS</code> and <code class="calibre2">PKG_LIBS</code>.)</p>
<p>For portability, any C/C++ code using the <code class="calibre2">omp_*</code> functions should include the omp.h header: some compilers (but not all) include it when OpenMP mode is switched on (e.g. <em>via</em> flag -fopenmp).</p>
<p>There is nothing<a href="concept-index.html#FOOT29" id="DOCF29"><sup>29</sup></a> to say what version of OpenMP is supported: version 3.1 (and much of 4.0) is supported by recent versions<a href="concept-index.html#FOOT30" id="DOCF30"><sup>30</sup></a> of the Linux, Windows and Solaris platforms, but portable packages cannot assume that end users have recent versions.<a href="concept-index.html#FOOT31" id="DOCF31"><sup>31</sup></a> macOS currently uses Apple builds of <code class="calibre2">clang</code> with no OpenMP support (even if invoked as <code class="calibre2">gcc</code> and despite the <code class="calibre2">man</code> page including the flag -fopenmp for that command). <a href="http://www.openmp.org/resources/openmp-compilers" class="uri">http://www.openmp.org/resources/openmp-compilers</a> gives some idea of what compilers support what versions.</p>
<p>The performance of OpenMP varies substantially between platforms. The Windows implementation has substantial overheads<a href="concept-index.html#FOOT32" id="DOCF32"><sup>32</sup></a>, so is only beneficial if quite substantial tasks are run in parallel. Also, on Windows new threads are started with the default<a href="concept-index.html#FOOT33" id="DOCF33"><sup>33</sup></a> FPU control word, so computations done on OpenMP threads will not make use of extended-precision arithmetic which is the default for the main process.</p>
<p>Calling any of the R API from threaded code is ‘for experts only’: they will need to read the source code to determine if it is thread-safe. In particular, code which makes use of the stack-checking mechanism must not be called from threaded code.</p>
<p>Packages are not standard-alone programs, and an R process could contain more than one OpenMP-enabled package as well as other components (for example, an optimized BLAS) making use of OpenMP. So careful consideration needs to be given to resource usage. OpenMP works with parallel regions, and for most implementations the default is to use as many threads as ‘CPUs’ for such regions. Parallel regions can be nested, although it is common to use only a single thread below the first level. The correctness of the detected number of ‘CPUs’ and the assumption that the R process is entitled to use them all are both dubious assumptions. The best way to limit resources is to limit the overall number of threads available to OpenMP in the R process: this can be done via environment variable <code class="calibre2">OMP_THREAD_LIMIT</code>, where implemented.<a href="concept-index.html#FOOT34" id="DOCF34"><sup>34</sup></a> Alternatively, the number of threads per region can be limited by the environment variable <code class="calibre2">OMP_NUM_THREADS</code> or API call <code class="calibre2">omp_set_num_threads</code>, or, better, for the regions in your code as part of their specification. E.g. R uses</p>
<div class="example">
<pre class="example1"><code>#pragma omp parallel for num_threads(nthreads) …</code></pre>
</div>
<p>That way you only control your own code and not that of other OpenMP users.</p>
<hr />
<p><a href="" id="Using-pthreads"></a> <a href="" id="Using-pthreads-1"></a></p>
<h4 id="using-pthreads" class="subsection">1.2.1.2 Using pthreads</h4>
<p>There is no direct support for the POSIX threads (more commonly known as <code class="calibre2">pthreads</code>): by the time we considered adding it several packages were using it unconditionally so it seems that nowadays it is universally available on POSIX operating systems (hence not Windows).</p>
<p>For reasonably recent versions of <code class="calibre2">gcc</code> and <code class="calibre2">clang</code> the correct specification is</p>
<div class="example">
<pre class="example1"><code>PKG_CPPFLAGS = -pthread
PKG_LIBS = -pthread</code></pre>
</div>
<p>(and the plural version is also accepted on some systems/versions). For other platforms the specification is</p>
<div class="example">
<pre class="example1"><code>PKG_CPPFLAGS = -D_REENTRANT
PKG_LIBS = -lpthread</code></pre>
</div>
<p>(and note that the library name is singular). This is what -pthread does on all known current platforms (although earlier versions of OpenBSD used a different library name).</p>
<p>For a tutorial see <a href="https://computing.llnl.gov/tutorials/pthreads/" class="uri">https://computing.llnl.gov/tutorials/pthreads/</a>.</p>
<p>POSIX threads are not normally used on Windows, which has its own native concepts of threads. However, there are two projects implementing <code class="calibre2">pthreads</code> on top of Windows, <code class="calibre2">pthreads-w32</code> and <code class="calibre2">winpthreads</code> (part of the MinGW-w64 project).</p>
<p>Whether Windows toolchains implement <code class="calibre2">pthreads</code> is up to the toolchain provider. A <code class="calibre2">make</code> variable <code class="calibre2">SHLIB_PTHREAD_FLAGS</code> is available: this should be included in both <code class="calibre2">PKG_CPPFLAGS</code> (or the Fortran or F9x equivalents) and <code class="calibre2">PKG_LIBS</code>.</p>
<p>The presence of a working <code class="calibre2">pthreads</code> implementation cannot be unambiguously determined without testing for yourself: however, that ‘_REENTRANT’ is defined<a href="concept-index.html#FOOT35" id="DOCF35"><sup>35</sup></a> in C/C++ code is a good indication.</p>
<p>Note that not all <code class="calibre2">pthreads</code> implementations are equivalent as parts are optional (see <a href="http://pubs.opengroup.org/onlinepubs/009695399/basedefs/pthread.h.html" class="uri">http://pubs.opengroup.org/onlinepubs/009695399/basedefs/pthread.h.html</a>): for example, macOS lacks the ‘Barriers’ option.</p>
<p>See also the comments on thread-safety and performance under OpenMP: on all known R platforms OpenMP is implemented <em>via</em> <code class="calibre2">pthreads</code> and the known performance issues are in the latter.</p>
<hr />
<p><a href="" id="Compiling-in-sub_002ddirectories"></a> <a href="" id="Compiling-in-sub_002ddirectories-1"></a></p>
<h4 id="compiling-in-sub-directories" class="subsection">1.2.1.3 Compiling in sub-directories</h4>
<p>Package authors fairly often want to organize code in sub-directories of src, for example if they are including a separate piece of external software to which this is an R interface.</p>
<p>One simple way is simply to set <code class="calibre2">OBJECTS</code> to be all the objects that need to be compiled, including in sub-directories. For example, CRAN package <a href="https://CRAN.R-project.org/package=RSiena"><strong>RSiena</strong></a> has</p>
<div class="example">
<pre class="smallexample"><code>SOURCES = &#36;(wildcard data/*.cpp network/*.cpp utils/*.cpp model/*.cpp model/*/*.cpp model/*/*/*.cpp)

OBJECTS = siena07utilities.o siena07internals.o siena07setup.o siena07models.o &#36;(SOURCES:.cpp=.o)</code></pre>
</div>
<p>One problem with that approach is that unless GNU make extensions are used, the source files need to be listed and kept up-to-date. As in the following from CRAN package <a href="https://CRAN.R-project.org/package=lossDev"><strong>lossDev</strong></a>:</p>
<div class="example">
<pre class="smallexample"><code>OBJECTS.samplers = samplers/ExpandableArray.o samplers/Knots.o &#92;
  samplers/RJumpSpline.o samplers/RJumpSplineFactory.o &#92;
  samplers/RealSlicerOV.o samplers/SliceFactoryOV.o samplers/MNorm.o
OBJECTS.distributions = distributions/DSpline.o &#92;
  distributions/DChisqrOV.o distributions/DTOV.o &#92;
  distributions/DNormOV.o distributions/DUnifOV.o distributions/RScalarDist.o
OBJECTS.root = RJump.o

OBJECTS = &#36;(OBJECTS.samplers) &#36;(OBJECTS.distributions) &#36;(OBJECTS.root)</code></pre>
</div>
<p>Where the subdirectory is self-contained code with a suitable makefile, the best approach is something like</p>
<div class="example">
<pre class="smallexample"><code>PKG_LIBS = -LCsdp/lib -lsdp &#36;(LAPACK_LIBS) &#36;(BLAS_LIBS) &#36;(FLIBS)

&#36;(SHLIB): Csdp/lib/libsdp.a

Csdp/lib/libsdp.a:      
        @(cd Csdp/lib &amp;&amp; &#36;(MAKE) libsdp.a &#92;
          CC=&quot;&#36;(CC)&quot; CFLAGS=&quot;&#36;(CFLAGS) &#36;(CPICFLAGS)&quot; AR=&quot;&#36;(AR)&quot; RANLIB=&quot;&#36;(RANLIB)&quot;)</code></pre>
</div>
<p>Note the quotes: the macros can contain spaces, e.g. <code class="calibre2">CC = &quot;gcc -m64 -std=gnu99&quot;</code>. Several authors have forgotten about parallel makes: the static library in the subdirectory must be made before the shared object (<code class="calibre2">&#36;(SHLIB)</code>) and so the latter must depend on the former. Others forget the need<a href="concept-index.html#FOOT36" id="DOCF36"><sup>36</sup></a> for position-independent code.</p>
<p>We really do not recommend using src/Makefile instead of src/Makevars, and as the example above shows, it is not necessary.</p>
<hr />
<p><a href="" id="Configure-example"></a> <a href="" id="Configure-example-1"></a></p>
<h4 id="configure-example" class="subsection">1.2.2 Configure example</h4>
<p>It may be helpful to give an extended example of using a configure script to create a src/Makevars file: this is based on that in the <a href="https://CRAN.R-project.org/package=RODBC"><strong>RODBC</strong></a> package.</p>
<p>The configure.ac file follows: configure is created from this by running <code class="calibre2">autoconf</code> in the top-level package directory (containing configure.ac).</p>
<blockquote>
<div class="example">
<pre class="smallexample"><code>AC_INIT([RODBC], 1.1.8) dnl package name, version

dnl A user-specifiable option
odbc_mgr=&quot;&quot;
AC_ARG_WITH([odbc-manager],
            AC_HELP_STRING([--with-odbc-manager=MGR],
                           [specify the ODBC manager, e.g. odbc or iodbc]),
            [odbc_mgr=&#36;withval])

if test &quot;&#36;odbc_mgr&quot; = &quot;odbc&quot; ; then
  AC_PATH_PROGS(ODBC_CONFIG, odbc_config)
fi

dnl Select an optional include path, from a configure option
dnl or from an environment variable.
AC_ARG_WITH([odbc-include],
            AC_HELP_STRING([--with-odbc-include=INCLUDE_PATH],
                           [the location of ODBC header files]),
            [odbc_include_path=&#36;withval])
RODBC_CPPFLAGS=&quot;-I.&quot;
if test [ -n &quot;&#36;odbc_include_path&quot; ] ; then
   RODBC_CPPFLAGS=&quot;-I. -I&#36;{odbc_include_path}&quot;
else
  if test [ -n &quot;&#36;{ODBC_INCLUDE}&quot; ] ; then
     RODBC_CPPFLAGS=&quot;-I. -I&#36;{ODBC_INCLUDE}&quot;
  fi
fi

dnl ditto for a library path
AC_ARG_WITH([odbc-lib],
            AC_HELP_STRING([--with-odbc-lib=LIB_PATH],
                           [the location of ODBC libraries]),
            [odbc_lib_path=&#36;withval])
if test [ -n &quot;&#36;odbc_lib_path&quot; ] ; then
   LIBS=&quot;-L&#36;odbc_lib_path &#36;{LIBS}&quot;
else
  if test [ -n &quot;&#36;{ODBC_LIBS}&quot; ] ; then
     LIBS=&quot;-L&#36;{ODBC_LIBS} &#36;{LIBS}&quot;
  else
    if test -n &quot;&#36;{ODBC_CONFIG}&quot;; then
      odbc_lib_path=`odbc_config --libs | sed s/-lodbc//`
      LIBS=&quot;&#36;{odbc_lib_path} &#36;{LIBS}&quot;
    fi
  fi
fi

dnl Now find the compiler and compiler flags to use
: &#36;{R_HOME=`R RHOME`}
if test -z &quot;&#36;{R_HOME}&quot;; then
  echo &quot;could not determine R_HOME&quot;
  exit 1
fi
CC=`&quot;&#36;{R_HOME}/bin/R&quot; CMD config CC`
CPP=`&quot;&#36;{R_HOME}/bin/R&quot; CMD config CPP`
CFLAGS=`&quot;&#36;{R_HOME}/bin/R&quot; CMD config CFLAGS`
CPPFLAGS=`&quot;&#36;{R_HOME}/bin/R&quot; CMD config CPPFLAGS`
AC_PROG_CC
AC_PROG_CPP


if test -n &quot;&#36;{ODBC_CONFIG}&quot;; then
  RODBC_CPPFLAGS=`odbc_config --cflags`
fi
CPPFLAGS=&quot;&#36;{CPPFLAGS} &#36;{RODBC_CPPFLAGS}&quot;

dnl Check the headers can be found
AC_CHECK_HEADERS(sql.h sqlext.h)
if test &quot;&#36;{ac_cv_header_sql_h}&quot; = no ||
   test &quot;&#36;{ac_cv_header_sqlext_h}&quot; = no; then
   AC_MSG_ERROR(&quot;ODBC headers sql.h and sqlext.h not found&quot;)
fi

dnl search for a library containing an ODBC function
if test [ -n &quot;&#36;{odbc_mgr}&quot; ] ; then
  AC_SEARCH_LIBS(SQLTables, &#36;{odbc_mgr}, ,
      AC_MSG_ERROR(&quot;ODBC driver manager &#36;{odbc_mgr} not found&quot;))
else
  AC_SEARCH_LIBS(SQLTables, odbc odbc32 iodbc, ,
      AC_MSG_ERROR(&quot;no ODBC driver manager found&quot;))
fi

dnl for 64-bit ODBC need SQL[U]LEN, and it is unclear where they are defined.
AC_CHECK_TYPES([SQLLEN, SQLULEN], , , [# include &lt;sql.h&gt;])
dnl for unixODBC header
AC_CHECK_SIZEOF(long, 4)

dnl substitute RODBC_CPPFLAGS and LIBS
AC_SUBST(RODBC_CPPFLAGS)
AC_SUBST(LIBS)
AC_CONFIG_HEADERS([src/config.h])
dnl and do substitution in the src/Makevars.in and src/config.h
AC_CONFIG_FILES([src/Makevars])
AC_OUTPUT</code></pre>
</div>
</blockquote>
<p>where src/Makevars.in would be simply</p>
<blockquote>
<div class="example">
<pre class="example1"><code>PKG_CPPFLAGS = @RODBC_CPPFLAGS@
PKG_LIBS = @LIBS@</code></pre>
</div>
</blockquote>
<p>A user can then be advised to specify the location of the ODBC driver manager files by options like (lines broken for easier reading)</p>
<div class="example">
<pre class="example1"><code>R CMD INSTALL &#92;
  --configure-args=&#39;--with-odbc-include=/opt/local/include &#92;
  --with-odbc-lib=/opt/local/lib --with-odbc-manager=iodbc&#39; &#92;
  RODBC</code></pre>
</div>
<p>or by setting the environment variables <code class="calibre2">ODBC_INCLUDE</code> and <code class="calibre2">ODBC_LIBS</code>.</p>
<hr />
<p><a href="" id="Using-F95-code"></a> <a href="" id="Using-F95-code-1"></a></p>
<h4 id="using-f95-code" class="subsection">1.2.3 Using F95 code</h4>
<p>R assumes that source files with extension .f are FORTRAN 77, and passes them to the compiler specified by ‘F77’. On most but not all platforms that compiler will accept Fortran 90/95 code: some platforms have a separate Fortran 90/95 compiler and a few (by now quite rare<a href="concept-index.html#FOOT37" id="DOCF37"><sup>37</sup></a>) platforms have no Fortran 90/95 support.</p>
<p>This means that portable packages need to be written in correct FORTRAN 77, which will also be valid Fortran 95. See <a href="https://developer.R-project.org/Portability.html" class="uri">https://developer.R-project.org/Portability.html</a> for reference resources. In particular, <em>free source form</em> F95 code is not portable.</p>
<p>On some systems an alternative F95 compiler is available: from the <code class="calibre2">gcc</code> family this might be <code class="calibre2">gfortran</code> or <code class="calibre2">g95</code>. Configuring R will try to find a compiler which (from its name) appears to be a Fortran 90/95 compiler, and set it in macro ‘FC’. Note that it does not check that such a compiler is fully (or even partially) compliant with Fortran 90/95. Packages making use of Fortran 90/95 features should use file extension .f90 or .f95 for the source files: the variable <code class="calibre2">PKG_FCFLAGS</code> specifies any special flags to be used. There is no guarantee that compiled Fortran 90/95 code can be mixed with any other type of compiled code, nor that a build of R will have support for such packages.</p>
<p>Some (but not) all compilers specified by the ‘FC’ macro will accept Fortran 2003 or 2008 code: such code should still use file extension .f90 or .f95. For platforms using <code class="calibre2">gfortran</code>, you may need to include -std=f2003 or -std=f2008 in <code class="calibre2">PKG_FCFLAGS</code>: the default is ‘GNU Fortran’, Fortran 95 with non-standard extensions. The Oracle <code class="calibre2">f95</code> compiler ‘accepts some Fortran 2003/8 features’ (search for ‘Oracle Developer Studio 12.5: Fortran User’s Guide’ and look for §4.6).</p>
<p>Modern versions of Fortran support modules, whereby compiling one source file creates a module file which is then included in others. (Module files typically have a .mod extension: they do depend on the compiler used and so should never be included in a package.) This creates a dependence which <code class="calibre2">make</code> will not know about and often causes installation with a parallel make to fail. Thus it is necessary to add explicit dependencies to src/Makevars to tell <code class="calibre2">make</code> the constraints on the order of compilation. For example, if file iface.f90 creates a module ‘iface’ used by files cmi.f90 and dmi.f90 then src/Makevars needs to contain something like</p>
<div class="example">
<pre class="example1"><code>cmi.o dmi.o: iface.o</code></pre>
</div>
<hr />
<p><a href="" id="Using-C_002b_002b11-code"></a> <a href="" id="Using-C_002b_002b11-code-1"></a></p>
<h4 id="using-c11-code" class="subsection">1.2.4 Using C++11 code</h4>
<p>R can be built without a C++ compiler although one is available (but not necessarily installed) on all known R platforms. For full portability across platforms, all that can be assumed is approximate support for the C++98 standard (the widely used <code class="calibre2">g++</code> deviates considerably from the standard). Some compilers have a concept of ‘C++03’ (‘essentially a bug fix’) or ‘C++ Technical Report 1’ (TR1), an optional addition to the ‘C++03’ revision which was published in 2007. A revised standard was published in 2011 and compilers with pretty much complete implementations are available. C++11 added all of the C99 features which are not otherwise implemented in C++, and C++ compilers commonly accept C99 extensions to C++98. A minor update<a href="concept-index.html#FOOT38" id="DOCF38"><sup>38</sup></a> to C++11 (C++14) was published in December 2014. The next standard has been sent to ISO and is likely to be approved in 2017: it is informally known as C++17.</p>
<p>What standard a C++ compiler aims to support can be hard to determine: the value<a href="concept-index.html#FOOT39" id="DOCF39"><sup>39</sup></a> of <code class="calibre2">__cplusplus</code> may help but some compilers use it to denote a standard which is partially supported and some the latest standard which is (almost) fully supported. As from version 6, <code class="calibre2">g++</code> defaults to C++14 (with GNU extensions): earlier versions aim to support C++03 with many extensions (including support for TR1). <code class="calibre2">clang</code> with its native<a href="concept-index.html#FOOT40" id="DOCF40"><sup>40</sup></a> <code class="calibre2">libc++</code> headers and library includes many C++11 features, and does not support TR1.</p>
<p>Since version 3.1.0, R has provided support for C++11 in packages in addition to C++98. This support is not uniform across platforms as it depends on the capabilities of the compiler (see below). When R is configured, it will determine whether the C++ compiler supports C++11 and which compiler flags, if any, are required to enable C++11 support. For example, recent versions of <code class="calibre2">g++</code> or <code class="calibre2">clang++</code> accept the compiler flag -std=c++11, and earlier versions support a flag -std=c++0x, but the latter only provided partial support for the C++11 standard (it later became a deprecated synonym for -std=c++11).</p>
<p>In order to use C++11 code in a package, the package’s Makevars file (or Makevars.win on Windows) should include the line</p>
<div class="example">
<pre class="example1"><code>CXX_STD = CXX11</code></pre>
</div>
<p>Compilation and linking will then be done with the C++11 compiler.</p>
<p>Packages without a src/Makevars or src/Makefile file may specify that they require C++11 for code in the src directory by including ‘C++11’ in the ‘SystemRequirements’ field of the DESCRIPTION file, e.g.</p>
<div class="example">
<pre class="example1"><code>SystemRequirements: C++11</code></pre>
</div>
<p>If a package does have a src/Makevars[.win] file then setting the make variable ‘CXX_STD’ is preferred, as it allows <code class="calibre2">R CMD SHLIB</code> to work correctly in the package’s src directory.</p>
<p>Conversely, to ensure that the C++98 standard is assumed even when this is not the compiler default, use</p>
<div class="example">
<pre class="example1"><code>SystemRequirements: C++98</code></pre>
</div>
<p>or</p>
<div class="example">
<pre class="example1"><code>CXX_STD = CXX98</code></pre>
</div>
<p>The C++11 compiler will be used systematically by R for all C++ code if the environment variable <code class="calibre2">USE_CXX11</code> is defined (with any value). Hence this environment variable should be defined when invoking <code class="calibre2">R CMD SHLIB</code> in the absence of a Makevars file (or Makevars.win on Windows) if a C++11 compiler is required.</p>
<p>Further control over compilation of C++11 code can be obtained by specifying the macros ‘CXX11’ and ‘CXX11STD’ when R is configured<a href="concept-index.html#FOOT41" id="DOCF41"><sup>41</sup></a>, or in a personal or site Makevars file. If C++11 support is not available then these macros are both empty; if it is available by default, ‘CXX11’ defaults to ‘CXX’ and ‘CXX11STD’ is empty . Otherwise, ‘CXX11’ defaults to the same value as the C++ compiler ‘CXX’ and the flag ‘CXX11STD’ defaults to -std=c++11 or similar. It is possible to specify ‘CXX11’ to be a distinct compiler just for C++11–using packages, e.g. <code class="calibre2">g++</code> on Solaris. Note however that different C++ compilers (and even different versions of the same compiler) often differ in their ABI so their outputs can rarely be mixed. By setting ‘CXX11STD’ it is also possible to choose a different dialect of the standard such as -std=c++11.</p>
<p>As noted above, support for C++11 varies across platforms: on some platforms, it may be possible or necessary to select a different compiler for C++11, <em>via</em> personal or site Makevars files.</p>
<p>There is no guarantee that C++11 can be used in a package in combination with any other compiled language (even C), as the C++11 compiler may be incompatible with the native compilers for the platform. (There are known problems mixing C++11 with Fortran.)</p>
<p>If a package using C++11 has a <code class="calibre2">configure</code> script it is essential that it selects the correct compiler, <em>via</em> something like</p>
<div class="example">
<pre class="example1"><code>CXX11=`&quot;&#36;{R_HOME}/bin/R&quot; CMD config CXX11`
CXX11STD=`&quot;&#36;{R_HOME}/bin/R&quot; CMD config CXX11STD`
CXX=&quot;&#36;{CXX11} &#36;{CXX11STD}&quot;
CXXFLAGS=`&quot;&#36;{R_HOME}/bin/R&quot; CMD config CXX11FLAGS`
AC_LANG(C++)</code></pre>
</div>
<p>(paying attention to all the quotes required).</p>
<p>If you want to compile C++11 code in a subdirectory, make sure you pass down the macros to specify that compiler, e.g. in src/Makevars</p>
<div class="example">
<pre class="example1"><code>sublibs:
         @(cd libs &amp;&amp; &#36;(MAKE) &#92;
            CXX=&quot;&#36;(CXX11) &#36;(CXX11STD)&quot; CXXFLAGS=&quot;&#36;(CXX11FLAGS) &#36;(CXX11PICFLAGS)&quot;)</code></pre>
</div>
<p>Note that the mechanisms described here specify C++11 for code compiled by <code class="calibre2">R CMD SHLIB</code> as used by default by <code class="calibre2">R CMD INSTALL</code>. They do not necessarily apply if there is a src/Makefile file, nor to compilation done in vignettes or <em>via</em> other packages.</p>
<hr />
<p><a href="" id="Using-C_002b_002b14-code"></a> <a href="" id="Using-C_002b_002b14-code-1"></a></p>
<h4 id="using-c14-code" class="subsection">1.2.5 Using C++14 code</h4>
<p>Support for a C++14 has been explicitly added to R from version 3.4.0. Similar considerations to C++11 apply, except that the variables associated with the C++14 compiler use the prefix ‘CXX14’ instead of ‘CXX11’. Hence to use C++14 code in a package, the package’s Makevars file (or Makevars.win on Windows) should include the line</p>
<div class="example">
<pre class="example1"><code>CXX_STD = CXX14</code></pre>
</div>
<p>In the absence of a Makevars file, C++14 support can also be requested by the line:</p>
<div class="example">
<pre class="example1"><code>SystemRequirements: C++14</code></pre>
</div>
<p>in the DESCRIPTION file. Finally, the C++14 compiler can be used systematically by setting the environment variable <code class="calibre2">USE_CXX17</code>.</p>
<p>Note that code written for C++11 that emulates features of C++14 will not necessarily compile under a C++14 compiler<a href="concept-index.html#FOOT42" id="DOCF42"><sup>42</sup></a>, since the emulation typically leads to a namespace clash. In order to ensure that the code also compiles under C++14, something like the following should be done:</p>
<div class="example">
<pre class="example1"><code>#if __cplusplus &gt;= 201402L
using std::make_unique;
#else
// your emulation
#endif</code></pre>
</div>
<p>Code needing C++14 features would do better to test for their presence <em>via</em> ‘SD-6 feature tests’<a href="concept-index.html#FOOT43" id="DOCF43"><sup>43</sup></a>. That test could be</p>
<div class="example">
<pre class="example1"><code>#include &lt;memory&gt; // header where this is defined
#if defined(__cpp_lib_make_unique) &amp;&amp; (__cpp_lib_make_unique &gt;= 201304)
using std::make_unique;
#else
// your emulation
#endif</code></pre>
</div>
<p>The webpage <a href="http://en.cppreference.com/w/cpp/compiler_support" class="uri">http://en.cppreference.com/w/cpp/compiler_support</a> gives some information on which compilers are known to support recent C++ features, including those in the C++17 drafts (for which feature tests should be used).</p>
<hr />
<p><a href="" id="Using-C_002b_002b17-code"></a> <a href="" id="Using-C_002b_002b17-code-1"></a></p>
<h4 id="using-c17-code" class="subsection">1.2.6 Using C++17 code</h4>
<p>Experimental support for C++17 has been added to R version 3.4.0. The configure script tests a subset of C++17 features. At the time of writing (March 2017) both <code class="calibre2">clang 4.0.0</code> and <code class="calibre2">gcc 7.1</code> pass these tests (with flags -std=gnu++1z and -std=gnu++17 respectively chosen by the configure script). Note that the C++17 feature tests are incomplete and are subject to change in future R versions as compiler support for the standard improves.</p>
<p>The variables associated with the C++17 compiler use the prefix ‘CXX17’. Hence to use C++17 code in a package, the package’s Makevars file (or Makevars.win on Windows) should include the line</p>
<div class="example">
<pre class="example1"><code>CXX_STD = CXX17</code></pre>
</div>
<p>In the absence of a Makevars file, C++17 support can also be requested by the line:</p>
<div class="example">
<pre class="example1"><code>SystemRequirements: C++17</code></pre>
</div>
<p>in the DESCRIPTION file. Finally, the C++17 compiler can be used systematically by setting the environment variable <code class="calibre2">USE_CXX17</code>.</p>
<hr />
<p><a href="" id="Checking-and-building-packages"></a> <a href="" id="Checking-and-building-packages-1"></a></p>
<h3 id="checking-and-building-packages" class="section">1.3 Checking and building packages</h3>
<p>Before using these tools, please check that your package can be installed (which checked it can be loaded). <code class="calibre2">R CMD check</code> will <em>inter alia</em> do this, but you may get more detailed error messages doing the install directly.</p>
<p>If your package specifies an encoding in its DESCRIPTION file, you should run these tools in a locale which makes use of that encoding: they may not work at all or may work incorrectly in other locales (although UTF-8 locales will most likely work).</p>
<blockquote>
<p><strong>Note:</strong> <code class="calibre2">R CMD check</code> and <code class="calibre2">R CMD build</code> run R processes with --vanilla in which none of the user’s startup files are read. If you need <code class="calibre2">R_LIBS</code> set (to find packages in a non-standard library) you can set it in the environment: also you can use the check and build environment files (as specified by the environment variables <code class="calibre2">R_CHECK_ENVIRON</code> and <code class="calibre2">R_BUILD_ENVIRON</code>; if unset, files<a href="concept-index.html#FOOT44" id="DOCF44"><sup>44</sup></a> ~/.R/check.Renviron and ~/.R/build.Renviron are used) to set environment variables when using these utilities.</p>
</blockquote>
<blockquote>
<p><strong>Note to Windows users:</strong> <code class="calibre2">R CMD build</code> may make use of the Windows toolset (see the “R Installation and Administration” manual) if present and in your path, and it is required for packages which need it to install (including those with configure.win or cleanup.win scripts or a src directory) and e.g. need vignettes built.</p>
<p>You may need to set the environment variable <code class="calibre2">TMPDIR</code> to point to a suitable writable directory with a path not containing spaces – use forward slashes for the separators. Also, the directory needs to be on a case-honouring file system (some network-mounted file systems are not).</p>
</blockquote>
<hr />
<p><a href="" id="Checking-packages"></a> <a href="" id="Checking-packages-1"></a></p>
<h4 id="checking-packages" class="subsection">1.3.1 Checking packages</h4>
<p><a href="" id="index-Checking-packages"></a> <a href="" id="index-R-CMD-check"></a></p>
<p>Using <code class="calibre2">R CMD check</code>, the R package checker, one can test whether <em>source</em> R packages work correctly. It can be run on one or more directories, or compressed package <code class="calibre2">tar</code> archives with extension .tar.gz, .tgz, .tar.bz2 or .tar.xz.</p>
<p>It is strongly recommended that the final checks are run on a <code class="calibre2">tar</code> archive prepared by <code class="calibre2">R CMD build</code>.</p>
<p>This runs a series of checks, including</p>
<ol>
<li>The package is installed. This will warn about missing cross-references and duplicate aliases in help files.</li>
<li>The file names are checked to be valid across file systems and supported operating system platforms.</li>
<li>The files and directories are checked for sufficient permissions (Unix-alikes only).</li>
<li>The files are checked for binary executables, using a suitable version of <code class="calibre2">file</code> if available<a href="concept-index.html#FOOT45" id="DOCF45"><sup>45</sup></a>. (There may be rare false positives.)</li>
<li>The DESCRIPTION file is checked for completeness, and some of its entries for correctness. Unless installation tests are skipped, checking is aborted if the package dependencies cannot be resolved at run time. (You may need to set <code class="calibre2">R_LIBS</code> in the environment if dependent packages are in a separate library tree.) One check is that the package name is not that of a standard package, nor one of the defunct standard packages (‘ctest’, ‘eda’, ‘lqs’, ‘mle’, ‘modreg’, ‘mva’, ‘nls’, ‘stepfun’ and ‘ts’). Another check is that all packages mentioned in <code class="calibre2">library</code> or <code class="calibre2">require</code>s or from which the NAMESPACE file imports or are called <em>via</em> <code class="calibre2">::</code> or <code class="calibre2">:::</code> are listed (in ‘Depends’, ‘Imports’, ‘Suggests’): this is not an exhaustive check of the actual imports.</li>
<li>Available index information (in particular, for demos and vignettes) is checked for completeness.</li>
<li><p>The package subdirectories are checked for suitable file names and for not being empty. The checks on file names are controlled by the option --check-subdirs=value. This defaults to ‘default’, which runs the checks only if checking a tarball: the default can be overridden by specifying the value as ‘yes’ or ‘no’. Further, the check on the src directory is only run if the package does not contain a configure script (which corresponds to the value ‘yes-maybe’) and there is no src/Makefile or src/Makefile.in.</p>
<p>To allow a configure script to generate suitable files, files ending in ‘.in’ will be allowed in the R directory.</p>
<p>A warning is given for directory names that look like R package check directories – many packages have been submitted to CRAN containing these.</p></li>
<li>The R files are checked for syntax errors. Bytes which are non-ASCII are reported as warnings, but these should be regarded as errors unless it is known that the package will always be used in the same locale.</li>
<li>It is checked that the package can be loaded, first with the usual default packages and then only with package <strong>base</strong> already loaded. It is checked that the namespace this can be loaded in an empty session with only the <strong>base</strong> namespace loaded. (Namespaces and packages can be loaded very early in the session, before the default packages are available, so packages should work then.)</li>
<li>The R files are checked for correct calls to <code class="calibre2">library.dynam</code>. Package startup functions are checked for correct argument lists and (incorrect) calls to functions which modify the search path or inappropriately generate messages. The R code is checked for possible problems using <a href="https://CRAN.R-project.org/package=codetools"><strong>codetools</strong></a>. In addition, it is checked whether S3 methods have all arguments of the corresponding generic, and whether the final argument of replacement functions is called ‘value’. All foreign function calls (<code class="calibre2">.C</code>, <code class="calibre2">.Fortran</code>, <code class="calibre2">.Call</code> and <code class="calibre2">.External</code> calls) are tested to see if they have a <code class="calibre2">PACKAGE</code> argument, and if not, whether the appropriate DLL might be deduced from the namespace of the package. Any other calls are reported. (The check is generous, and users may want to supplement this by examining the output of <code class="calibre2">tools::checkFF(&quot;mypkg&quot;, verbose=TRUE)</code>, especially if the intention were to always use a <code class="calibre2">PACKAGE</code> argument)</li>
<li>The Rd files are checked for correct syntax and metadata, including the presence of the mandatory fields (<code class="calibre2">&#92;name</code>, <code class="calibre2">&#92;alias</code>, <code class="calibre2">&#92;title</code> and <code class="calibre2">&#92;description</code>). The Rd name and title are checked for being non-empty, and there is a check for missing cross-references (links).</li>
<li>A check is made for missing documentation entries, such as undocumented user-level objects in the package.</li>
<li>Documentation for functions, data sets, and S4 classes is checked for consistency with the corresponding code.</li>
<li>It is checked whether all function arguments given in <code class="calibre2">&#92;usage</code> sections of Rd files are documented in the corresponding <code class="calibre2">&#92;arguments</code> section.</li>
<li>The data directory is checked for non-ASCII characters and for the use of reasonable levels of compression.</li>
<li><p>C, C++ and FORTRAN source and header files<a href="concept-index.html#FOOT46" id="DOCF46"><sup>46</sup></a> are tested for portable (LF-only) line endings. If there is a Makefile or Makefile.in or Makevars or Makevars.in file under the src directory, it is checked for portable line endings and the correct use of ‘&#36;(BLAS_LIBS)’ and ‘&#36;(LAPACK_LIBS)’</p>
<p>Compiled code is checked for symbols corresponding to functions which might terminate R or write to stdout/stderr instead of the console. Note that the latter might give false positives in that the symbols might be pulled in with external libraries and could never be called. Windows<a href="concept-index.html#FOOT47" id="DOCF47"><sup>47</sup></a> users should note that the Fortran and C++ runtime libraries are examples of such external libraries.</p></li>
<li>Some checks are made of the contents of the inst/doc directory. These always include checking for files that look like leftovers, and if suitable tools (such as <code class="calibre2">qpdf</code>) are available, checking that the PDF documentation is of minimal size.</li>
<li><p>The examples provided by the package’s documentation are run. (see <a href="writing-r-documentation-files.html">Writing R documentation files</a>, for information on using <code class="calibre2">&#92;examples</code> to create executable example code.) If there is a file tests/Examples/pkg-Ex.Rout.save, the output of running the examples is compared to that file.</p>
<p>Of course, released packages should be able to run at least their own examples. Each example is run in a ‘clean’ environment (so earlier examples cannot be assumed to have been run), and with the variables <code class="calibre2">T</code> and <code class="calibre2">F</code> redefined to generate an error unless they are set in the example: See <a href="./R-intro.html#Logical-vectors">Logical vectors</a> in An Introduction to R.</p></li>
<li>If the package sources contain a tests directory then the tests specified in that directory are run. (Typically they will consist of a set of .R source files and target output files .Rout.save.) Please note that the comparison will be done in the end user’s locale, so the target output files should be ASCII if at all possible. (The command line option <code class="calibre2">--test-dir=foo</code> may be used to specify tests in a non-standard location. For example, unusually slow tests could be placed in inst/slowTests and then <code class="calibre2">R CMD check --test-dir=inst/slowTests</code> would be used to run them. Other names that have been suggested are, for example, inst/testWithOracle for tests that require Oracle to be installed, inst/randomTests for tests which use random values and may occasionally fail by chance, etc.)</li>
<li><p>The code in package vignettes (see <a href="#Writing-package-vignettes">Writing package vignettes</a>) is executed, and the vignette PDFs re-made from their sources as a check of completeness of the sources (unless there is a ‘BuildVignettes’ field in the package’s DESCRIPTION file with a false value). If there is a target output file .Rout.save in the vignette source directory, the output from running the code in that vignette is compared with the target output file and any differences are reported (but not recorded in the log file). (If the vignette sources are in the deprecated location inst/doc, do mark such target output files to not be installed in .Rinstignore.)</p>
<p>If there is an error<a href="concept-index.html#FOOT48" id="DOCF48"><sup>48</sup></a> in executing the R code in vignette foo.ext, a log file foo.ext.log is created in the check directory. The vignette PDFs are re-made in a copy of the package sources in the vign_test subdirectory of the check directory, so for further information on errors look in directory pkgname/vign_test/vignettes. (It is only retained if there are errors or if environment variable <code class="calibre2">_R_CHECK_CLEAN_VIGN_TEST_</code> is set to a false value.)</p></li>
<li>The PDF version of the package’s manual is created (to check that the Rd files can be converted successfully). This needs LaTeX and suitable fonts and LaTeX packages to be installed. See the section ‘Making the manuals’ in the ‘R Installation and Administration’ manual’ for further details.</li>
</ol>
<p>All these tests are run with collation set to the <code class="calibre2">C</code> locale, and for the examples and tests with environment variable <code class="calibre2">LANGUAGE=en</code>: this is to minimize differences between platforms.</p>
<p>Use R CMD check --help to obtain more information about the usage of the R package checker. A subset of the checking steps can be selected by adding command-line options. It also allows customization by setting environment variables <code class="calibre2">_R_CHECK_*_</code> as described in ‘R Internals’: a set of these customizations similar to those used by CRAN can be selected by the option --as-cran (which works best if Internet access is available). Some Windows users may need to set environment variable <code class="calibre2">R_WIN_NO_JUNCTIONS</code> to a non-empty value. The test of cyclic declarations<a href="concept-index.html#FOOT49" id="DOCF49"><sup>49</sup></a>in DESCRIPTION files needs repositories (including CRAN) set: do this in ~/.Rprofile, by e.g.</p>
<div class="example">
<pre class="example1"><code>options(repos = c(CRAN=&quot;https://cran.r-project.org&quot;))</code></pre>
</div>
<p>One check customization which can be revealing is</p>
<div class="example">
<pre class="example1"><code>_R_CHECK_CODETOOLS_PROFILE_=&quot;suppressLocalUnused=FALSE&quot;</code></pre>
</div>
<p>which reports unused local assignments. Not only does this point out computations which are unnecessary because their results are unused, it also can uncover errors. (Two such are to intend to update an object by assigning a value but mistype its name or assign in the wrong scope, for example using <code class="calibre2">&lt;-</code> where <code class="calibre2">&lt;&lt;-</code> was intended.) This can give false positives, most commonly because of non-standard evaluation for formulae and because the intention is to return objects in the environment of a function for later use.</p>
<p>Complete checking of a package which contains a file README.md needs <code class="calibre2">pandoc</code> installed: see <a href="http://johnmacfarlane.net/pandoc/installing.html" class="uri">http://johnmacfarlane.net/pandoc/installing.html</a>. This should be reasonably current: at the time of writing CRAN used version 1.12.4.2 to process these files.</p>
<p>You do need to ensure that the package is checked in a suitable locale if it contains non-ASCII characters. Such packages are likely to fail some of the checks in a <code class="calibre2">C</code> locale, and <code class="calibre2">R CMD check</code> will warn if it spots the problem. You should be able to check any package in a UTF-8 locale (if one is available). Beware that although a <code class="calibre2">C</code> locale is rarely used at a console, it may be the default if logging in remotely or for batch jobs.</p>
<blockquote>
<p><strong>Multiple sub-architectures:</strong> On systems which support multiple sub-architectures (principally Windows), <code class="calibre2">R CMD check</code> will install and check a package which contains compiled code under all available sub-architectures. (Use option --force-multiarch to force this for packages without compiled code, which are otherwise only checked under the main sub-architecture.) This will run the loading tests, examples and tests directory under each installed sub-architecture in turn, and give an error if any fail. Where environment variables (including perhaps <code class="calibre2">PATH</code>) need to be set differently for each sub-architecture, these can be set in architecture-specific files such as R_HOME/etc/i386/Renviron.site.</p>
<p>An alternative approach is to use <code class="calibre2">R CMD check --no-multiarch</code> to check the primary sub-architecture, and then to use something like <code class="calibre2">R --arch=x86_64 CMD check --extra-arch</code> or (Windows) <code class="calibre2">/path/to/R/bin/x64/Rcmd check --extra-arch</code> to run for each additional sub-architecture just the checks<a href="concept-index.html#FOOT50" id="DOCF50"><sup>50</sup></a> which differ by sub-architecture. (This approach is required for packages which are installed by <code class="calibre2">R CMD INSTALL --merge-multiarch</code>.)</p>
<p>Where packages need additional commands to install all the sub-architectures these can be supplied by e.g. --install-args=--force-biarch.</p>
</blockquote>
<hr />
<p><a href="" id="Building-package-tarballs"></a> <a href="" id="Building-package-tarballs-1"></a></p>
<h4 id="building-package-tarballs" class="subsection">1.3.2 Building package tarballs</h4>
<p><a href="" id="index-Building-source-packages"></a> <a href="" id="index-R-CMD-build"></a> <a href="" id="index-Package-builder"></a> <a href="" id="index-tarballs"></a></p>
<p>Packages may be distributed in source form as “tarballs” (.tar.gz files) or in binary form. The source form can be installed on all platforms with suitable tools and is the usual form for Unix-like systems; the binary form is platform-specific, and is the more common distribution form for the Windows and macOS platforms.</p>
<p>Using <code class="calibre2">R CMD build</code>, the R package builder, one can build R package tarballs from their sources (for example, for subsequent release).</p>
<p>Prior to actually building the package in the standard gzipped tar file format, a few diagnostic checks and cleanups are performed. In particular, it is tested whether object indices exist and can be assumed to be up-to-date, and C, C++ and FORTRAN source files and relevant makefiles in a src directory are tested and converted to LF line-endings if necessary.</p>
<p>Run-time checks whether the package works correctly should be performed using <code class="calibre2">R CMD check</code> prior to invoking the final build procedure.</p>
<p><a href="" id="index-_002eRbuildignore-file"></a></p>
<p>To exclude files from being put into the package, one can specify a list of exclude patterns in file .Rbuildignore in the top-level source directory. These patterns should be Perl-like regular expressions (see the help for <code class="calibre2">regexp</code> in R for the precise details), one per line, to be matched case-insensitively against the file and directory names relative to the top-level package source directory. In addition, directories from source control systems<a href="concept-index.html#FOOT51" id="DOCF51"><sup>51</sup></a> or from <code class="calibre2">eclipse</code><a href="concept-index.html#FOOT52" id="DOCF52"><sup>52</sup></a>, directories with names ending .Rcheck or Old or old and files GNUMakefile<a href="concept-index.html#FOOT53" id="DOCF53"><sup>53</sup></a>, Read-and-delete-me or with base names starting with ‘.#’, or starting and ending with ‘#’, or ending in ‘~’, ‘.bak’ or ‘.swp’, are excluded by default. In addition, those files in the R, demo and man directories which are flagged by <code class="calibre2">R CMD check</code> as having invalid names will be excluded.</p>
<p>Use R CMD build --help to obtain more information about the usage of the R package builder.</p>
<p>Unless R CMD build is invoked with the --no-build-vignettes option (or the package’s DESCRIPTION contains ‘BuildVignettes: no’ or similar), it will attempt to (re)build the vignettes (see <a href="#Writing-package-vignettes">Writing package vignettes</a>) in the package. To do so it installs the current package into a temporary library tree, but any dependent packages need to be installed in an available library tree (see the Note: at the top of this section).</p>
<p>Similarly, if the .Rd documentation files contain any <code class="calibre2">&#92;Sexpr</code> macros (see <a href="writing-r-documentation-files.html#Dynamic-pages">Dynamic pages</a>), the package will be temporarily installed to execute them. Post-execution binary copies of those pages containing build-time macros will be saved in build/partial.rdb. If there are any install-time or render-time macros, a .pdf version of the package manual will be built and installed in the build subdirectory. (This allows CRAN or other repositories to display the manual even if they are unable to install the package.) This can be suppressed by the option --no-manual or if package’s DESCRIPTION contains ‘BuildManual: no’ or similar.</p>
<p>One of the checks that <code class="calibre2">R CMD build</code> runs is for empty source directories. These are in most (but not all) cases unintentional, if they are intentional use the option --keep-empty-dirs (or set the environment variable <code class="calibre2">_R_BUILD_KEEP_EMPTY_DIRS_</code> to ‘TRUE’, or have a ‘BuildKeepEmpty’ field with a true value in the DESCRIPTION file).</p>
<p>The --resave-data option allows saved images (.rda and .RData files) in the data directory to be optimized for size. It will also compress tabular files and convert .R files to saved images. It can take values <code class="calibre2">no</code>, <code class="calibre2">gzip</code> (the default if this option is not supplied, which can be changed by setting the environment variable <code class="calibre2">_R_BUILD_RESAVE_DATA_</code>) and <code class="calibre2">best</code> (equivalent to giving it without a value), which chooses the most effective compression. Using <code class="calibre2">best</code> adds a dependence on <code class="calibre2">R (&gt;= 2.10)</code> to the DESCRIPTION file if <code class="calibre2">bzip2</code> or <code class="calibre2">xz</code> compression is selected for any of the files. If this is thought undesirable, --resave-data=gzip (which is the default if that option is not supplied) will do what compression it can with <code class="calibre2">gzip</code>. A package can control how its data is resaved by supplying a ‘BuildResaveData’ field (with one of the values given earlier in this paragraph) in its DESCRIPTION file.</p>
<p>The --compact-vignettes option will run <code class="calibre2">tools::compactPDF</code> over the PDF files in inst/doc (and its subdirectories) to losslessly compress them. This is not enabled by default (it can be selected by environment variable <code class="calibre2">_R_BUILD_COMPACT_VIGNETTES_</code>) and needs <code class="calibre2">qpdf</code> (<a href="http://qpdf.sourceforge.net/" class="uri">http://qpdf.sourceforge.net/</a>) to be available.</p>
<p>It can be useful to run <code class="calibre2">R CMD check --check-subdirs=yes</code> on the built tarball as a final check on the contents.</p>
<p>Where a non-POSIX file system is in use which does not utilize execute permissions, some care is needed with permissions. This applies on Windows and to e.g. FAT-formatted drives and SMB-mounted file systems on other OSes. The ‘mode’ of the file recorded in the tarball will be whatever <code class="calibre2">file.info()</code> returns. On Windows this will record only directories as having execute permission and on other OSes it is likely that all files have reported ‘mode’ <code class="calibre2">0777</code>. A particular issue is packages being built on Windows which are intended to contain executable scripts such as configure and cleanup: <code class="calibre2">R CMD build</code> ensures those two are recorded with execute permission.</p>
<p>Directory build of the package sources is reserved for use by <code class="calibre2">R CMD build</code>: it contains information which may not easily be created when the package is installed, including index information on the vignettes and, rarely, information on the help pages and perhaps a copy of the PDF reference manual (see above).</p>
<hr />
<p><a href="" id="Building-binary-packages"></a> <a href="" id="Building-binary-packages-1"></a></p>
<h4 id="building-binary-packages" class="subsection">1.3.3 Building binary packages</h4>
<p><a href="" id="index-Building-binary-packages"></a></p>
<p>Binary packages are compressed copies of installed versions of packages. They contain compiled shared libraries rather than C, C++ or Fortran source code, and the R functions are included in their installed form. The format and filename are platform-specific; for example, a binary package for Windows is usually supplied as a .zip file, and for the macOS platform the default binary package file extension is .tgz.</p>
<p>The recommended method of building binary packages is to use</p>
<p><code class="calibre2">R CMD INSTALL --build pkg</code> where pkg is either the name of a source tarball (in the usual .tar.gz format) or the location of the directory of the package source to be built. This operates by first installing the package and then packing the installed binaries into the appropriate binary package file for the particular platform.</p>
<p>By default, <code class="calibre2">R CMD INSTALL --build</code> will attempt to install the package into the default library tree for the local installation of R. This has two implications:</p>
<ul>
<li>If the installation is successful, it will overwrite any existing installation of the same package.</li>
<li>The default library tree must have write permission; if not, the package will not install and the binary will not be created.</li>
</ul>
<p>To prevent changes to the present working installation or to provide an install location with write access, create a suitably located directory with write access and use the <code class="calibre2">-l</code> option to build the package in the chosen location. The usage is then</p>
<p><code class="calibre2">R CMD INSTALL -l location --build pkg</code></p>
<p>where location is the chosen directory with write access. The package will be installed as a subdirectory of location, and the package binary will be created in the current directory.</p>
<p>Other options for <code class="calibre2">R CMD INSTALL</code> can be found using <code class="calibre2">R CMD INSTALL --help</code>, and platform-specific details for special cases are discussed in the platform-specific FAQs.</p>
<p>Finally, at least one web-based service is available for building binary packages from (checked) source code: WinBuilder (see <a href="https://win-builder.R-project.org/" class="uri">https://win-builder.R-project.org/</a>) is able to build Windows binaries. Note that this is intended for developers on other platforms who do not have access to Windows but wish to provide binaries for the Windows platform.</p>
<hr />
<p><a href="" id="Writing-package-vignettes"></a> <a href="" id="Writing-package-vignettes-1"></a></p>








